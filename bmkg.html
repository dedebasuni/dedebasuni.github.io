<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaca & Gempa BMKG</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#1f2937">
    <style>
        #map { height: 350px; border-radius: 0.5rem; }
        @media (max-width: 640px) { #map { height: 250px; } }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .notification { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        :root { color-scheme: light dark; }
        canvas { max-height: 200px; }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #log-section { max-height: 300px; overflow-y: auto; }
        body {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Amiri', serif;
        }
        .weather-bg {
            position: relative;
            overflow: hidden;
        }
        .weather-bg.rain::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent, rgba(255,255,255,0.2));
            animation: rainAnimation 2s linear infinite;
            pointer-events: none;
        }
        @keyframes rainAnimation {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .weather-bg.sunny::before {
            content: '☀️';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            animation: sunnyAnimation 5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes sunnyAnimation {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        .mini-widget {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .aqi-meter {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #22c55e 0%, #eab308 50%, #ef4444 100%);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-3">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold">Cuaca & Gempa BMKG</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Data terbaru dari BMKG Indonesia</p>
            </div>
            <div id="mini-weather-widget" class="mini-widget hidden text-sm text-gray-500 dark:text-gray-400"></div>
            <div class="flex gap-2">
                <button id="toggle-theme" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label="Toggle theme">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
                <button id="locate-me" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label="Lokasi saya">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    </svg>
                </button>
                <button id="whatsapp-btn" class="p-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors hidden" aria-label="Kirim ke WhatsApp">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26 9.87 9.87 0 019.865-9.867 9.867 9.867 0 016.986 2.986 9.867 9.867 0 012.985 6.982 9.874 9.874 0 01-9.897 9.892m7.393-18.077A11.85 11.85 0 0012.06 0 11.85 11.85 0 001.67 19.192l-2.14 7.811 8.048-2.11A11.86 11.86 0 0012.06 24c6.54 0 11.86-5.32 11.86-11.859 0-3.164-1.226-6.132-3.453-8.37z"/>
                    </svg>
                </button>
                <button id="refresh-data" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" aria-label="Refresh data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Notification -->
        <div id="notification" class="hidden fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg notification z-50"></div>

        <!-- Weather -->
        <section id="weather-section" class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 fade-in weather-bg">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Prakiraan Cuaca</h2>
                <div id="weather-time" class="text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
            <div class="flex gap-3 mb-3">
                <input id="city-search" type="text" placeholder="Cari wilayah (Kota/Provinsi)..." class="flex-1 p-2 rounded-md border dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:ring-indigo-500">
                <button id="search-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition-colors">Cari</button>
            </div>
            <div id="weather-loading" class="hidden flex justify-center py-4">
                <div class="loading-spinner"></div>
            </div>
            <div id="weather-data" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            <div id="aqi-data" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
            <div class="mt-4">
                <canvas id="weather-chart"></canvas>
            </div>
        </section>

        <!-- Warning Section -->
        <section id="warning-section" class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 fade-in hidden">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Peringatan Dini</h2>
                <div id="warning-time" class="text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
            <div id="warning-loading" class="hidden flex justify-center py-4">
                <div class="loading-spinner"></div>
            </div>
            <div id="warning-data" class="grid grid-cols-1 gap-3"></div>
        </section>

        <!-- Earthquake -->
        <section class="mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 fade-in">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Gempa Terkini</h2>
                <div id="quake-time" class="text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mb-3">
                <div class="w-full sm:w-1/3 space-y-3">
                    <div class="flex gap-2">
                        <select id="magnitude-filter" class="w-full rounded-md border dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:ring-indigo-500">
                            <option value="0">Semua Magnitudo</option>
                            <option value="3">≥ 3.0</option>
                            <option value="4">≥ 4.0</option>
                            <option value="5">≥ 5.0</option>
                        </select>
                        <input type="date" id="quake-date" class="w-full rounded-md border dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:ring-indigo-500" value="2025-05-10">
                    </div>
                    <div id="quake-info" class="bg-gray-100 dark:bg-gray-700 p-3 rounded-md">
                        <p class="text-sm">Total gempa: <span id="quake-count" class="font-medium">0</span></p>
                        <p class="text-sm">Terkuat: <span id="quake-strongest" class="font-medium">-</span></p>
                    </div>
                </div>
                <div class="w-full sm:w-2/3" id="map"></div>
            </div>
            <div id="quake-loading" class="hidden flex justify-center py-4">
                <div class="loading-spinner"></div>
            </div>
            <div id="earthquake-list" class="grid grid-cols-1 gap-3"></div>
        </section>

        <!-- Log Section -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 fade-in" id="log-section">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Log Pencarian & Notifikasi</h2>
                <button id="clear-log" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors">Hapus</button>
            </div>
            <div id="log-loading" class="hidden flex justify-center py-4">
                <div class="loading-spinner"></div>
            </div>
            <div id="log-list" class="grid grid-cols-1 gap-3"></div>
        </section>

        <!-- Footer -->
        <footer class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>Data diperbarui secara otomatis dari BMKG</p>
            <p class="mt-1">© 2025 Cuaca & Gempa BMKG</p>
        </footer>
    </div>

    <script>
        // Lazy Load Map
        let map = null;
        let mapLoaded = false;
        function initMap() {
            if (mapLoaded) return;
            // Safety check for Leaflet
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded.');
                showNotification('Gagal memuat peta: Leaflet tidak tersedia.', 'error');
                return;
            }
            try {
                map = L.map('map').setView([-2.5489, 118.0149], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://osm.org/copyright">OSM</a>'
                }).addTo(map);
                mapLoaded = true;
            } catch (e) {
                console.error('Failed to initialize map:', e);
                showNotification('Gagal memuat peta. Silakan coba lagi nanti.', 'error');
            }
        }

        const mapSection = document.querySelector('#map');
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                initMap();
                observer.unobserve(mapSection);
            }
        }, { threshold: 0.1 });
        observer.observe(mapSection);

        // API Configuration
        const APIs = {
            weather: 'https://api.bmkg.go.id/publik/prakiraan-cuaca?adm4=32.03.16.2007',
            earthquake: 'https://data.bmkg.go.id/DataMKG/TEWS/autogempa.xml',
            historicalQuake: 'https://data.bmkg.go.id/DataMKG/TEWS/gempaterkini.xml',
            aqi: 'https://api.openweathermap.org/data/2.5/air_pollution',
            warning: 'https://data.bmkg.go.id/DataMKG/TEWS/gempadirasakan.xml'
        };

        const AQI_API_KEY = 'e98de5f3705f63f8923b88904e99af9f';

        // Daftar Provinsi untuk Pencarian (dengan kode adm4)
        const provinces = [
            { name: "Aceh", adm4: "11.01.01.2001", lat: 5.5483, lon: 95.3238 },
            { name: "Bali", adm4: "51.71.01.1001", lat: -8.4095, lon: 115.1889 },
            { name: "Banten", adm4: "36.03.01.1001", lat: -6.4058, lon: 106.0640 },
            { name: "Bengkulu", adm4: "17.71.01.1001", lat: -3.8004, lon: 102.2655 },
            { name: "DI Yogyakarta", adm4: "34.71.01.1001", lat: -7.7971, lon: 110.3705 },
            { name: "DKI Jakarta", adm4: "31.71.01.1001", lat: -6.2088, lon: 106.8456 },
            { name: "Gorontalo", adm4: "75.01.01.1001", lat: 0.6999, lon: 122.4467 },
            { name: "Jambi", adm4: "15.71.01.1001", lat: -1.6101, lon: 103.6131 },
            { name: "Jawa Barat", adm4: "32.03.16.2007", lat: -6.9175, lon: 107.6191 },
            { name: "Jawa Tengah", adm4: "33.74.01.1001", lat: -7.1507, lon: 110.1403 },
            { name: "Jawa Timur", adm4: "35.78.01.1001", lat: -7.5361, lon: 112.2384 },
            { name: "Kalimantan Barat", adm4: "61.71.05.1001", lat: -0.1322, lon: 111.4753 },
            { name: "Kalimantan Selatan", adm4: "63.71.01.1001", lat: -3.3167, lon: 114.5901 },
            { name: "Kalimantan Tengah", adm4: "62.71.01.1001", lat: -1.6815, lon: 113.3824 },
            { name: "Kalimantan Timur", adm4: "64.71.01.1001", lat: 0.5387, lon: 116.4194 },
            { name: "Kalimantan Utara", adm4: "65.71.01.1001", lat: 3.0926, lon: 115.2838 },
            { name: "Kepulauan Bangka Belitung", adm4: "19.01.01.1001", lat: -2.7411, lon: 106.4406 },
            { name: "Kepulauan Riau", adm4: "21.71.10.1001", lat: 3.9457, lon: 108.1429 },
            { name: "Lampung", adm4: "18.71.14.1001", lat: -4.5586, lon: 105.4068 },
            { name: "Maluku", adm4: "81.71.04.2001", lat: -3.2385, lon: 130.1453 },
            { name: "Maluku Utara", adm4: "82.71.02.1001", lat: 1.5700, lon: 127.8088 },
            { name: "Nusa Tenggara Barat", adm4: "52.01.01.1001", lat: -8.6529, lon: 117.3616 },
            { name: "Nusa Tenggara Timur", adm4: "53.71.01.1001", lat: -8.6574, lon: 121.0794 },
            { name: "Papua", adm4: "91.71.01.1001", lat: -4.2699, lon: 138.0804 },
            { name: "Papua Barat", adm4: "92.71.01.1001", lat: -1.3361, lon: 133.1747 },
            { name: "Riau", adm4: "14.71.01.1001", lat: 0.2933, lon: 101.7068 },
            { name: "Sulawesi Barat", adm4: "76.04.01.1001", lat: -2.8440, lon: 119.2321 },
            { name: "Sulawesi Selatan", adm4: "73.04.01.1001", lat: -3.6688, lon: 119.9741 },
            { name: "Sulawesi Tengah", adm4: "72.71.02.1002", lat: -1.4300, lon: 121.4453 },
            { name: "Sulawesi Tenggara", adm4: "74.01.01.1001", lat: -4.1449, lon: 122.1746 },
            { name: "Sulawesi Utara", adm4: "71.71.01.1001", lat: 1.4931, lon: 124.8413 },
            { name: "Sumatera Barat", adm4: "13.71.01.1001", lat: -0.7399, lon: 100.8000 },
            { name: "Sumatera Selatan", adm4: "16.71.01.1001", lat: -3.3199, lon: 103.9146 },
            { name: "Sumatera Utara", adm4: "12.01.01.1001", lat: 2.1154, lon: 99.5451 }
        ];

        let quakes = [], logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
        let currentWeatherData = null, currentEarthquakeData = null, currentLocation = '';
        let currentLat = -6.9175, currentLon = 107.6191; // Default to Bandung

        const getColor = m => m >= 5 ? '#ef4444' : m >= 4 ? '#f97316' : m >= 3 ? '#eab308' : '#22c55e';

        // Weather Icon Mapping
        const weatherIcons = {
            'Cerah': '☀️', 'Cerah Berawan': '🌤️', 'Berawan': '☁️', 'Berawan Tebal': '🌥️',
            'Hujan Ringan': '🌦️', 'Hujan Sedang': '🌧️', 'Hujan Lebat': '⛈️', 'Hujan Petir': '🌩️',
            'Kabut': '🌫️', 'Asap': '🌫️', 'Udara Kabur': '🌫️'
        };

        // Theme Toggle
        document.getElementById('toggle-theme').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'light') document.documentElement.classList.remove('dark');

        // Notification
        function showNotification(message, type = 'error') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `hidden fixed top-4 right-4 text-white p-3 rounded-lg shadow-lg notification z-50`;
            notif.classList.add(type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500');
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 5000);
        }

        // Geolocation
        document.getElementById('locate-me').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const { latitude, longitude } = pos.coords;
                        if (mapLoaded) {
                            map.setView([latitude, longitude], 10);
                            L.marker([latitude, longitude], {
                                icon: L.divIcon({ className: 'location-marker', html: '📍', iconSize: [30, 30] })
                            }).addTo(map).bindPopup('Lokasi Anda').openPopup();
                        }
                        currentLat = latitude;
                        currentLon = longitude;
                        fetchAQI(latitude, longitude);
                        showNotification('Lokasi Anda ditemukan', 'success');
                    },
                    () => showNotification('Gagal mendapatkan lokasi. Pastikan izin lokasi diaktifkan.')
                );
            } else {
                showNotification('Geolocation tidak didukung di browser Anda.');
            }
        });

        // Update Mini Weather Widget
        function updateMiniWeatherWidget() {
            const widget = document.getElementById('mini-weather-widget');
            if (currentWeatherData && currentLocation) {
                const currentWeather = currentWeatherData[0];
                widget.innerHTML = `
                    <span class="text-lg">${weatherIcons[currentWeather.weather] || '❓'}</span>
                    <span>${currentLocation}: ${currentWeather.weather}, ${currentWeather.temp}°C, ${currentWeather.humidity}%</span>
                `;
                widget.classList.remove('hidden');
            } else {
                widget.classList.add('hidden');
            }
        }

        // Fetch AQI Data
        async function fetchAQI(lat, lon) {
            const aqiDiv = document.getElementById('aqi-data');
            try {
                const response = await fetch(`${APIs.aqi}?lat=${lat}&lon=${lon}&appid=${AQI_API_KEY}`);
                if (!response.ok) throw new Error(`Gagal fetch AQI: ${response.statusText}`);
                const data = await response.json();
                const aqi = data.list[0].main.aqi;
                const aqiLevel = getAQILevel(aqi);
                const aqiRecommendation = getAQIRecommendation(aqi);

                // Ensure DOM is ready before updating
                setTimeout(() => {
                    aqiDiv.innerHTML = `
                        <h3 class="text-lg font-medium mb-2">Kualitas Udara</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-medium">AQI: ${aqi}</span>
                            <span class="${aqiLevel.color} px-2 py-1 rounded-full text-xs font-bold">${aqiLevel.text}</span>
                        </div>
                        <div class="aqi-meter mb-2"></div>
                        <p class="text-sm">${aqiRecommendation}</p>
                    `;
                }, 100); // Small delay to ensure DOM is ready
                logActivity('Pencarian', `Mengambil data AQI untuk koordinat ${lat}, ${lon}`);
            } catch (e) {
                console.error('AQI fetch error:', e);
                aqiDiv.innerHTML = `<p class="text-center text-gray-500 py-2">Data AQI tidak tersedia: ${e.message}</p>`;
            }
        }

        function getAQILevel(aqi) {
            if (aqi <= 50) return { text: 'Baik', color: 'text-green-500' };
            if (aqi <= 100) return { text: 'Sedang', color: 'text-yellow-500' };
            if (aqi <= 150) return { text: 'Tidak Sehat', color: 'text-orange-500' };
            return { text: 'Berbahaya', color: 'text-red-500' };
        }

        function getAQIRecommendation(aqi) {
            if (aqi <= 50) return 'Kualitas udara baik, cocok untuk aktivitas luar ruangan.';
            if (aqi <= 100) return 'Kualitas udara sedang, gunakan masker jika sensitif.';
            if (aqi <= 150) return 'Kualitas udara tidak sehat, hindari aktivitas outdoor lama.';
            return 'Kualitas udara berbahaya, tetap di dalam ruangan dan gunakan masker.';
        }

        // Weather Fetch
        async function fetchWeather(search = '') {
            const weatherDiv = document.getElementById('weather-data');
            const loading = document.getElementById('weather-loading');
            const chartCanvas = document.getElementById('weather-chart').getContext('2d');
            let weatherChart = Chart.getChart(chartCanvas) || null;
            const weatherSection = document.getElementById('weather-section');

            try {
                loading.classList.remove('hidden');
                weatherDiv.innerHTML = '';
                weatherSection.className = 'mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 fade-in weather-bg';

                const province = provinces.find(p => p.name.toLowerCase().includes(search.toLowerCase()));
                if (!province) throw new Error('Wilayah tidak ditemukan');

                const response = await fetch(`${APIs.weather.replace('adm4=32.03.16.2007', `adm4=${province.adm4}`)}`);
                if (!response.ok) throw new Error(`Gagal mengambil data cuaca: ${response.statusText}`);

                const data = await response.json();
                console.log('API Response for', province.name, ':', data); // Debugging: Lihat struktur data

                if (!data || !data.lokasi || !data.data) throw new Error('Data cuaca tidak valid');

                const dailyForecasts = data.data[0]?.cuaca;
                if (!dailyForecasts || !Array.isArray(dailyForecasts) || dailyForecasts.length === 0) {
                    throw new Error(`Data prakiraan cuaca tidak ditemukan atau kosong untuk ${province.name}`);
                }

                // Ambil 3 hari pertama dari array dua dimensi
                const forecasts = [];
                for (let i = 0; i < Math.min(3, dailyForecasts.length); i++) {
                    const dayForecasts = dailyForecasts[i]; // Array prakiraan untuk satu hari
                    if (!Array.isArray(dayForecasts) || dayForecasts.length === 0) continue;

                    const firstPrakiraan = dayForecasts[0]; // Ambil prakiraan pertama untuk hari itu
                    console.log('First Prakiraan for day', i + 1, ':', firstPrakiraan); // Debugging

                    const date = firstPrakiraan.local_datetime.split(' ')[0]; // Ambil tanggal (YYYY-MM-DD)
                    const weatherDesc = firstPrakiraan.weather_desc || 'Tidak diketahui';
                    const temp = firstPrakiraan.t !== undefined ? `${firstPrakiraan.t}°C` : 'N/A';
                    const humidity = firstPrakiraan.hu !== undefined ? `${firstPrakiraan.hu}%` : 'N/A';
                    const windSpeed = firstPrakiraan.ws !== undefined ? `${firstPrakiraan.ws} km/j` : 'N/A';
                    const windDir = firstPrakiraan.wd || 'N/A';
                    const visibility = firstPrakiraan.vs_text || 'N/A';

                    forecasts.push({
                        date,
                        weather: weatherDesc,
                        temp,
                        humidity,
                        windSpeed,
                        windDir,
                        visibility
                    });
                }

                if (forecasts.length === 0) throw new Error('Data cuaca tidak ditemukan untuk wilayah ini');

                currentWeatherData = forecasts;
                currentLocation = province.name;
                currentLat = province.lat;
                currentLon = province.lon;

                // Tampilkan prakiraan cuaca dalam kartu
                weatherDiv.innerHTML = forecasts.map((f, i) => `
                    <div class="card bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                        <h3 class="text-lg font-medium mb-2">${new Date(f.date).toLocaleDateString('id-ID')}</h3>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-2xl">${weatherIcons[f.weather] || '❓'}</span>
                            <span>${f.weather}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-gray-200 dark:bg-gray-600 p-2 rounded">
                                <p class="text-xs text-gray-500 dark:text-gray-300">Suhu</p>
                                <p class="font-medium">${f.temp}</p>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-600 p-2 rounded">
                                <p class="text-xs text-gray-500 dark:text-gray-300">Kelembapan</p>
                                <p class="font-medium">${f.humidity}</p>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-600 p-2 rounded">
                                <p class="text-xs text-gray-500 dark:text-gray-300">Kecepatan Angin</p>
                                <p class="font-medium">${f.windSpeed}</p>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-600 p-2 rounded">
                                <p class="text-xs text-gray-500 dark:text-gray-300">Arah Angin</p>
                                <p class="font-medium">${f.windDir}</p>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-600 p-2 rounded">
                                <p class="text-xs text-gray-500 dark:text-gray-300">Jarak Pandang</p>
                                <p class="font-medium">${f.visibility}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Perbarui chart suhu
                if (weatherChart) weatherChart.destroy();
                document.getElementById('weather-chart').style.display = 'block';
                weatherChart = new Chart(chartCanvas, {
                    type: 'line',
                    data: {
                        labels: forecasts.map(f => new Date(f.date).toLocaleDateString('id-ID')),
                        datasets: [{
                            label: 'Suhu (°C)',
                            data: forecasts.map(f => parseFloat(f.temp.replace('°C', '')) || 0),
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                            x: { grid: { display: false } }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { boxWidth: 12 } },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        maintainAspectRatio: false
                    }
                });

                const currentWeather = forecasts[0].weather.toLowerCase();
                if (currentWeather.includes('hujan')) {
                    weatherSection.classList.add('rain');
                } else if (currentWeather.includes('cerah')) {
                    weatherSection.classList.add('sunny');
                }

                document.getElementById('weather-time').textContent = `Terakhir diperbarui: ${new Date().toLocaleTimeString()}`;
                logActivity('Pencarian', `Mencari cuaca untuk ${search}`);
                updateWhatsAppButton();
                updateMiniWeatherWidget();
                fetchAQI(province.lat, province.lon);
                fetchWarnings();

            } catch (e) {
                console.error('Weather fetch error:', e);
                showNotification('Gagal memuat data cuaca. Silakan coba lagi nanti.');
                weatherDiv.innerHTML = '<p class="text-center text-gray-500 col-span-3 py-4">Tidak ada data cuaca tersedia.</p>';
                if (weatherChart) weatherChart.destroy();
                document.getElementById('weather-chart').style.display = 'none';
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        // Fetch Warnings (Hypothetical)
        async function fetchWarnings() {
            const warningDiv = document.getElementById('warning-data');
            const loading = document.getElementById('warning-loading');
            const warningSection = document.getElementById('warning-section');

            try {
                loading.classList.remove('hidden');
                warningDiv.innerHTML = '';

                // Simulasi data peringatan (karena API belum ada)
                const warnings = [
                    { type: 'Tsunami', location: currentLocation, message: 'Potensi tsunami di wilayah pesisir.', time: new Date().toLocaleString('id-ID') }
                    // Ganti dengan fetch API jika tersedia
                ];

                if (warnings.length > 0) {
                    warningSection.classList.remove('hidden');
                    warningDiv.innerHTML = warnings.map(w => `
                        <div class="card bg-red-50 dark:bg-red-900 p-4 rounded-lg shadow hover:shadow-md">
                            <h3 class="text-lg font-medium text-red-600 dark:text-red-400">${w.type}</h3>
                            <p class="mt-1">${w.message}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${w.time}</p>
                        </div>
                    `).join('');
                    document.getElementById('warning-time').textContent = `Terakhir diperbarui: ${new Date().toLocaleTimeString()}`;
                    logActivity('Peringatan', `Mengambil peringatan dini untuk ${currentLocation}`);
                    const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
                    audio.play().catch(() => console.log('Audio playback failed'));
                    showNotification('Peringatan dini: Periksa section Peringatan Dini!', 'error');
                } else {
                    warningSection.classList.add('hidden');
                }
            } catch (e) {
                console.error('Warning fetch error:', e);
                warningSection.classList.add('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Earthquake Fetch
        async function fetchQuakes(date = new Date().toISOString().split('T')[0]) {
            const quakeList = document.getElementById('earthquake-list');
            const loading = document.getElementById('quake-loading');
            const apiUrl = date === new Date().toISOString().split('T')[0] ? APIs.earthquake : APIs.historicalQuake;

            try {
                loading.classList.remove('hidden');
                quakeList.innerHTML = '';

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Gagal mengambil data gempa');

                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');

                const earthquakes = xmlDoc.getElementsByTagName('gempa');
                if (!earthquakes.length) throw new Error('Data gempa tidak ditemukan');

                quakes = [];
                for (let earthquake of earthquakes) {
                    const data = {
                        tanggal: earthquake.getElementsByTagName('Tanggal')[0]?.textContent || 'Tidak tersedia',
                        jam: earthquake.getElementsByTagName('Jam')[0]?.textContent || 'Tidak tersedia',
                        lintang: earthquake.getElementsByTagName('Lintang')[0]?.textContent || '0',
                        bujur: earthquake.getElementsByTagName('Bujur')[0]?.textContent || '0',
                        wilayah: earthquake.getElementsByTagName('Wilayah')[0]?.textContent || 'Tidak tersedia',
                        magnitude: earthquake.getElementsByTagName('Magnitude')[0]?.textContent || '0',
                        kedalaman: earthquake.getElementsByTagName('Kedalaman')[0]?.textContent || 'Tidak tersedia',
                        potensi: earthquake.getElementsByTagName('Potensi')[0]?.textContent || 'Tidak tersedia'
                    };
                    quakes.push(data);

                    if (+data.magnitude >= 5.0 && date === new Date().toISOString().split('T')[0]) {
                        const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
                        audio.play().catch(() => console.log('Audio playback failed'));
                        showNotification(`Peringatan: Gempa ${data.magnitude} SR di ${data.wilayah}!`, 'error');
                    }
                }

                currentEarthquakeData = quakes[0];
                updateQuakes();
                logActivity('Pencarian', `Mencari data gempa untuk tanggal ${date}`);
                document.getElementById('quake-time').textContent = `Terakhir diperbarui: ${new Date().toLocaleTimeString()}`;
                updateWhatsAppButton();

            } catch (e) {
                console.error('Quake fetch error:', e);
                showNotification('Gagal memuat data gempa. Silakan coba lagi nanti.');
                quakeList.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data gempa tersedia.</p>';
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Update Quakes
        function updateQuakes() {
            const minMag = +document.getElementById('magnitude-filter').value;
            const filteredQuakes = quakes.filter(q => minMag === 0 || +q.magnitude >= minMag);
            const quakeList = document.getElementById('earthquake-list');
            quakeList.innerHTML = '';
            if (mapLoaded) {
                map.eachLayer(l => (l instanceof L.Marker || l instanceof L.CircleMarker) && map.removeLayer(l));
            }

            document.getElementById('quake-count').textContent = filteredQuakes.length;
            const strongest = quakes.reduce((max, q) => Math.max(max, +q.magnitude), 0);
            document.getElementById('quake-strongest').textContent = strongest > 0 ? `${strongest} SR` : '-';

            filteredQuakes.forEach(q => {
                const mag = +q.magnitude;
                const color = getColor(mag);

                quakeList.innerHTML += `
                    <div class="card bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-medium">${q.wilayah}</h3>
                            <span class="px-2 py-1 rounded-full text-xs font-bold" style="background-color: ${color}20; color: ${color}">
                                ${mag} SR
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-300">Kedalaman</p>
                                <p>${q.kedalaman}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-300">Waktu</p>
                                <p>${q.tanggal} ${q.jam}</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500 dark:text-gray-300">Lokasi</p>
                            <p>${q.lintang}, ${q.bujur}</p>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500 dark:text-gray-300">Potensi</p>
                            <p class="${q.potensi.includes('tidak berpotensi') ? 'text-green-500' : 'text-red-500'}">
                                ${q.potensi}
                            </p>
                        </div>
                    </div>
                `;

                const lat = parseFloat(q.lintang);
                const lon = parseFloat(q.bujur);
                if (mapLoaded && lat && lon) {
                    L.circleMarker([lat, lon], {
                        radius: Math.min(mag * 2, 15),
                        color: color,
                        fillColor: color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(map).bindPopup(`
                        <b>${q.wilayah}</b><br>
                        Magnitudo: ${mag} SR<br>
                        Kedalaman: ${q.kedalaman}<br>
                        Waktu: ${q.tanggal} ${q.jam}<br>
                        Potensi: ${q.potensi}
                    `);
                }
            });
        }

        // Log Activity
        function logActivity(type, details) {
            const timestamp = new Date().toLocaleString('id-ID');
            logs.push({ type, details, timestamp });
            localStorage.setItem('activityLogs', JSON.stringify(logs));
            updateLogs();
        }

        // Update Logs
        function updateLogs() {
            const logList = document.getElementById('log-list');
            logList.innerHTML = logs.map(log => `
                <div class="card bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                    <p class="text-sm">[${log.timestamp}] ${log.type}: ${log.details}</p>
                </div>
            `).join('') || '<p class="text-center text-gray-500 py-4">Belum ada aktivitas.</p>';
        }

        // WhatsApp Notification
        function updateWhatsAppButton() {
            const whatsappBtn = document.getElementById('whatsapp-btn');
            if (currentWeatherData && currentEarthquakeData && currentLocation) {
                whatsappBtn.classList.remove('hidden');
                whatsappBtn.onclick = () => {
                    let message = `*Prakiraan Cuaca & Gempa untuk ${currentLocation}*\n\n`;
                    message += `*Cuaca 3 Hari Ke Depan:*\n`;
                    currentWeatherData.forEach(forecast => {
                        message += `${new Date(forecast.date).toLocaleDateString('id-ID')}\n`;
                        message += `Cuaca: ${forecast.weather}\n`;
                        message += `Suhu: ${forecast.temp} °C\n`;
                        message += `Kelembapan: ${forecast.humidity}%\n`;
                        message += `Kecepatan Angin: ${forecast.windSpeed} km/j\n`;
                        message += `Arah Angin: ${forecast.windDir}\n`;
                        message += `Jarak Pandang: ${forecast.visibility}\n\n`;
                    });
                    message += `*Gempa Terkini:*\n`;
                    message += `Tanggal: ${currentEarthquakeData.tanggal} ${currentEarthquakeData.jam}\n`;
                    message += `Lokasi: ${currentEarthquakeData.lintang}, ${currentEarthquakeData.bujur} - ${currentEarthquakeData.wilayah}\n`;
                    message += `Magnitudo: ${currentEarthquakeData.magnitude}\n`;
                    message += `Kedalaman: ${currentEarthquakeData.kedalaman}\n`;
                    message += `Potensi: ${currentEarthquakeData.potensi}\n`;
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    logActivity('Notifikasi', `Mengirim notifikasi WhatsApp untuk ${currentLocation}`);
                };
            } else {
                whatsappBtn.classList.add('hidden');
            }
        }

        // Event Listeners
        document.getElementById('clear-log').addEventListener('click', () => {
            if (confirm('Apakah Anda yakin ingin menghapus semua log?')) {
                logs = [];
                localStorage.removeItem('activityLogs');
                updateLogs();
                showNotification('Log telah dihapus', 'success');
            }
        });

        document.getElementById('magnitude-filter').addEventListener('change', updateQuakes);

        document.getElementById('quake-date').addEventListener('change', (e) => {
            fetchQuakes(e.target.value);
        });

        document.getElementById('city-search').addEventListener('keypress', e => {
            if (e.key === 'Enter') fetchWeather(e.target.value);
        });

        document.getElementById('search-btn').addEventListener('click', () => {
            fetchWeather(document.getElementById('city-search').value);
        });

        document.getElementById('refresh-data').addEventListener('click', () => {
            fetchWeather(currentLocation);
            fetchQuakes(document.getElementById('quake-date').value);
            fetchWarnings();
            if (currentLat && currentLon) fetchAQI(currentLat, currentLon);
            showNotification('Data diperbarui', 'success');
        });

        // Auto Update
        function startAutoUpdate() {
            setInterval(() => {
                if (document.visibilityState === 'visible' && currentLocation) {
                    fetchWeather(currentLocation);
                    fetchQuakes(document.getElementById('quake-date').value);
                    fetchWarnings();
                    if (currentLat && currentLon) fetchAQI(currentLat, currentLon);
                    showNotification('Data diperbarui otomatis', 'success');
                }
            }, 10800000); // Update setiap 3 jam (10800000 ms)
        }

        // Initial Fetch (Default to Bandung)
        document.addEventListener('DOMContentLoaded', () => {
            fetchQuakes();
            fetchWeather('Bandung'); // Default to Bandung
            // Retry AQI fetch if it fails initially
            async function tryFetchAQI() {
                try {
                    await fetchAQI(-6.9175, 107.6191); // Default AQI for Bandung
                } catch (e) {
                    console.error('Initial AQI fetch failed, retrying in 5 seconds:', e);
                    setTimeout(tryFetchAQI, 5000); // Retry after 5 seconds
                }
            }
            tryFetchAQI();
            updateLogs();
            startAutoUpdate();
            document.getElementById('weather-time').textContent = `Memuat data cuaca...`;
            document.getElementById('quake-time').textContent = `Memuat data gempa...`;
        });
    </script>
</body>
</html>
