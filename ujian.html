<!DOCTYPE html>
<html lang="id">
<head>
  <!-- Meta Tags for SEO -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <!-- Title for the page -->
  <link rel="icon" href="https://lh3.googleusercontent.com/a/AEdFTp5o-M5qkUuK8udmqYnz01dEsVcMwHlzpbEgQmFxng=s230-c" type="image/png">
  <title>Ujian Online Chat Style SMAPTA</title>
  
  <!-- Meta Description for Search Engine -->
  <meta name="description" content="Ujian Online berbasis Smartphone untuk Siswa. Mudah Diakses, Cepat, dan Aman.">
  
  <!-- Meta Keywords for Search Engine -->
  <meta name="keywords" content="Ujian Online, CBT, Smartphone, Pendidikan, Sekolah Digital, Mobile Exam, CBT, E-learning">
  
  <!-- Meta Author for Attribution -->
  <meta name="author" content="Dede Basuni">
  
  <!-- Open Graph for Social Media Sharing -->
  <meta property="og:title" content="Ujian Online Chat Style SMAPTA">
  <meta property="og:description" content="Ujian Online berbasis Smartphone untuk Siswa. Mudah Diakses, Cepat, dan Aman.">
  <meta property="og:image" content="https://lh3.googleusercontent.com/a/AEdFTp5o-M5qkUuK8udmqYnz01dEsVcMwHlzpbEgQmFxng=s230-c">
  <meta property="og:url" content="https://dedebasuni.github.io/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Ujian Online Chat Style">
  
  <!-- Twitter Card for Social Media -->
  <meta name="twitter:title" content="Ujian Online Chat Style SMAPTA">
  <meta name="twitter:description" content="Ujian Online berbasis Smartphone untuk Siswa. Mudah Diakses, Cepat, dan Aman.">
  <meta name="twitter:image" content="https://lh3.googleusercontent.com/a/AEdFTp5o-M5qkUuK8udmqYnz01dEsVcMwHlzpbEgQmFxng=s230-c">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@dede_basuni">

  <!-- Preconnect to external domains for faster loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS -->
<style>
  :root {
    --whatsapp-green: #00a884;
    --whatsapp-dark-green: #005c4b;
    --whatsapp-light-green: #d9fdd3;
    --whatsapp-gray: #e9edef;
    --whatsapp-dark-gray: #111b21;
    --whatsapp-blue: #53bdeb;
    --correct: #00a884;
    --incorrect: #ff453a;
    --text-light: #667781;
    --text-dark: #111b21;
    --bg-light: #e9edef;
    --bg-dark: #0b141a;
    --chat-bg-dark: #0b141a;
    --white: #fff;
    --header-dark: #202c33;
    --border-light: #eee;
    --border-dark: #2A3942;
    --base-font-size: 14px;
    --header-height: 60px;
    --footer-height: 60px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: var(--base-font-size);
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-light);
    color: var(--text-dark);
    transition: background-color 0.3s, color 0.3s;
    overflow: hidden;
  }
  body.dark {
    background: var(--bg-dark);
    color: #e9edef;
  }

  /* HEADER */
  .header {
    background: var(--whatsapp-dark-green);
    color: var(--white);
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    z-index: 10;
    height: 60px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  body.dark .header {
    background: var(--header-dark);
  }
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: url('https://placehold.co/48x48/00a884/ffffff') no-repeat center/cover;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .header-info .name {
    font-weight: 500;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .header-info .status {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .timer {
    font-weight: 600;
    font-size: 14px;
    background: rgba(255,255,255,0.9);
    padding: 5px 10px;
    border-radius: 20px;
    color: var(--whatsapp-dark-green);
    user-select: none;
    min-width: 60px;
    text-align: center;
  }
  body.dark .timer {
    background: #111B21;
    color: var(--whatsapp-light-green);
  }

  /* DARK MODE TOGGLE */
  .dark-toggle {
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--white);
    font-size: 20px;
    margin-left: 10px;
    padding: 5px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }
  .dark-toggle:hover {
    background: rgba(255,255,255,0.1);
  }

  /* CHAT CONTAINER */
  .chat-container {
    flex: 1;
    overflow-y: auto;
    padding-top: calc(var(--header-height) + 10px);
    padding-bottom: calc(var(--footer-height) + 10px);
    background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
    background-repeat: repeat;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
    position: relative;
  }
  body.dark .chat-container {
    background-image: url('https://i.pinimg.com/736x/85/04/30/850430a750fb80c1ebaa5e740fc7cbd6.jpg');
    background-color: var(--chat-bg-dark);
    padding-top: calc(var(--header-height) + 10px);
    padding-bottom: calc(var(--footer-height) + 10px);    
  }

  /* MESSAGE BUBBLE */
  .message {
    max-width: 75%;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    line-height: 1.4;
    position: relative;
    font-size: 14.2px;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    word-wrap: break-word;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    word-break: break-word;
  }
  .bot-message {
    background: var(--white);
    align-self: flex-start;
    border-top-left-radius: 0;
    color: var(--text-dark);
    margin-left: 8px;
  }
  .user-message {
    background: var(--whatsapp-light-green);
    align-self: flex-end;
    border-top-right-radius: 0;
    color: var(--text-dark);
    margin-right: 8px;
  }
  body.dark .bot-message {
    background: #202C33;
    color: #E9EDEF;
  }
  body.dark .user-message {
    background: #005C4B;
    color: #E9EDEF;
  }

  /* Message time */
  .message-time {
    font-size: 11px;
    color: rgba(0,0,0,0.5);
    float: right;
    margin-left: 8px;
    margin-top: 2px;
  }
  body.dark .message-time {
    color: rgba(255,255,255,0.5);
  }
  .user-message .message-time {
    color: rgba(0,0,0,0.6);
  }
  body.dark .user-message .message-time {
    color: rgba(255,255,255,0.6);
  }

  /* Gambar di dalam pesan */
  .message img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin-top: 5px;
    display: block;
  }

  /* OPTION JAWABAN */
  .option-message {
    background: var(--white);
    border-radius: 8px;
    padding: 10px 12px;
    margin: 6px 8px;
    cursor: pointer;
    border-left: 4px solid transparent;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    font-weight: 500;
    transition: all 0.2s;
    position: relative;
    user-select: none;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    color: var(--text-dark);
    font-size: 14.2px;
    word-break: break-word;
  }
  .option-message:hover:not(.selected) {
    background: #f5f5f5;
    border-left-color: var(--whatsapp-dark-green);
  }
  .option-message.selected {
    pointer-events: none;
    background: var(--whatsapp-light-green);
    border-left-color: var(--whatsapp-green);
  }
  .correct-answer {
    background: var(--correct);
    color: white;
    border-left-color: var(--correct);
  }
  .wrong-answer {
    background: var(--incorrect);
    color: white;
    border-left-color: var(--incorrect);
  }
  body.dark .option-message {
    background: #202C33;
    color: #E9EDEF;
  }
  body.dark .option-message:hover:not(.selected) {
    background: #2A3942;
  }
  body.dark .option-message.selected {
    background: #005C4B;
    border-left-color: var(--whatsapp-green);
  }
  body.dark .correct-answer {
    background: #1B5E20;
    color: #E9EDEF;
    border-left-color: #2E7D32;
  }
  body.dark .wrong-answer {
    background: #7F1D1D;
    border-left-color: #B91C1C;
  }
  /* Gambar di dalam opsi */
  .option-message img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin-top: 5px;
  }

  /* Status Indicator */
  .status-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-weight: bold;
    font-size: 16px;
  }
  .correct-indicator { color: white; }
  .incorrect-indicator { color: white; }

  /* FOOTER */
  .footer {
    background: #f0f0f0;
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #e5e5e5;
    height: 60px;
  }
  body.dark .footer {
    background: var(--header-dark);
    border-top-color: #303D45;
  }
  #question-counter {
    font-size: 14px;
    color: var(--text-light);
    font-weight: 500;
  }
  body.dark #question-counter {
    color: #AEBAC1;
  }
  button.btn {
    padding: 8px 20px;
    border: none;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
    height: 36px;
  }
  button.btn-primary {
    background: var(--whatsapp-dark-green);
    color: white;
  }
  button.btn-primary:hover:not(:disabled) {
    background: var(--whatsapp-dark-gray);
  }
  button.btn-primary:disabled {
    background: #CCCCCC;
    cursor: not-allowed;
    color: #666;
  }
  body.dark button.btn-primary:disabled {
    background: #2A3942;
    color: #6B7B84;
  }

  /* LOGIN SCREEN */
  #login-screen {
    background: var(--white);
    padding: 30px 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    margin: auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
    color: var(--text-dark);
  }
  body.dark #login-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #login-screen h2 {
    text-align: center;
    color: var(--whatsapp-dark-green);
    font-size: 22px;
    margin-bottom: 10px;
  }
  body.dark #login-screen h2 {
    color: var(--whatsapp-green);
  }
  .input-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .input-field label {
    font-size: 14px;
    color: var(--text-light);
  }
  body.dark .input-field label {
    color: #AEBAC1;
  }
  .input-field input {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    color: var(--text-dark);
    background: var(--white);
  }
  body.dark .input-field input {
    background: #2A3942;
    border-color: #303D45;
    color: #E9EDEF;
  }
  .input-field input:focus {
    border-color: var(--whatsapp-dark-green);
  }
  .login-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .login-actions button {
    min-width: 150px;
  }

  /* RESULT SCREEN */
  #result-screen {
    background: var(--white);
    padding: 30px 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    margin: auto;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    color: var(--text-dark);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  body.dark #result-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  .result-avatar {
    width: 100px;
    height: 100px;
    margin: 0 auto;
    border-radius: 50%;
    background: url('https://avatars.githubusercontent.com/u/12972124?v=4') no-repeat center/contain;
    background-color: #F0F2F5;
    padding: 20px;
  }
  body.dark .result-avatar {
    background-color: #2A3942;
  }
  #result-title {
    color: var(--whatsapp-dark-green);
    font-size: 22px;
    font-weight: 600;
  }
  body.dark #result-title {
    color: var(--whatsapp-green);
  }
  #result-details {
    line-height: 1.6;
    font-size: 15px;
    text-align: left;
    background: #F9F9F9;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }
  body.dark #result-details {
    background: #2A3942;
  }
  #result-details p {
    margin-bottom: 8px;
  }
  button#restart-btn {
    background: var(--whatsapp-dark-green);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-weight: 500;
    font-size: 16px;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s ease;
    margin-top: 10px;
  }
  button#restart-btn:hover {
    background: var(--whatsapp-dark-gray);
  }

  /* Statistik Jawaban */
  #stats-container {
    background: var(--white);
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 8px 0;
    max-height: 180px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 14px;
    color: var(--text-dark);
  }
  body.dark #stats-container {
    background: #202C33;
    color: #E9EDEF;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  #stats-container h3 {
    margin-bottom: 10px;
    color: var(--whatsapp-dark-green);
    font-size: 15px;
    font-weight: 600;
  }
  body.dark #stats-container h3 {
    color: var(--whatsapp-green);
  }
  #stats-list {
    list-style: none;
    max-height: 140px;
    overflow-y: auto;
    padding-left: 0;
  }
  #stats-list li {
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    font-weight: 500;
    padding: 4px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  body.dark #stats-list li {
    border-bottom-color: rgba(255,255,255,0.05);
  }
  #stats-list li:last-child {
    border-bottom: none;
  }
  #stats-list li.correct {
    color: var(--correct);
  }
  #stats-list li.incorrect {
    color: var(--incorrect);
  }

  /* Indikator mengetik */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--white);
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    width: fit-content;
    margin: 8px 8px 8px;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    border-top-left-radius: 0;
  }
  body.dark .typing-indicator {
    background: #202C33;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.3);
  }
  .typing-dot {
    width: 7px;
    height: 7px;
    background: var(--text-light);
    border-radius: 50%;
    animation: bounce 1.5s infinite ease-in-out;
  }
  .typing-dot:nth-child(2) {
    animation-delay: 0.3s;
  }
  .typing-dot:nth-child(3) {
    animation-delay: 0.6s;
  }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
  }
  @keyframes fadeInUp {
    from {opacity: 0; transform: translateY(8px);}
    to {opacity: 1; transform: translateY(0);}
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }
  body.dark ::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
  }
  body.dark ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
  }

  /* Admin Screen */
  #admin-screen {
    background: var(--white);
    padding: 20px;
    border-radius: 8px;
    max-width: 900px;
    width: 90%;
    margin: auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    color: var(--text-dark);
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
  }
  body.dark #admin-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #admin-screen h2 {
    text-align: center;
    color: var(--whatsapp-dark-green);
    font-size: 24px;
  }
  body.dark #admin-screen h2 {
    color: var(--whatsapp-green);
  }
  #results-table-container {
    overflow-x: auto;
    max-height: 70vh;
    overflow-y: auto;
  }
  #results-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }
  #results-table th, #results-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
    font-size: 14px;
  }
  #results-table th {
    background-color: #f2f2f2;
    font-weight: 600;
    color: var(--text-dark);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  body.dark #results-table th {
    background-color: #2A3942;
    color: #E9EDEF;
  }
  #results-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  body.dark #results-table tbody tr:nth-child(even) {
    background-color: #111B21;
  }
  #results-table tbody tr:hover {
    background-color: #e0e0e0;
    cursor: pointer;
  }
  body.dark #results-table tbody tr:hover {
    background-color: #303D45;
  }
  .view-detail-btn {
    background: var(--whatsapp-blue);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.2s;
  }
  .view-detail-btn:hover {
    background: #2196F3;
  }
  .admin-back-btn {
    background: #F44336;
    color: white;
  }
  .admin-back-btn:hover {
    background: #D32F2F;
  }

  /* Custom Modal Styles (adjusted to use existing variables) */
  .custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
  }

  .custom-modal-content {
    background-color: var(--white); /* Light mode default */
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
    transform: translateY(-20px);
    opacity: 0;
    animation: fadeInModal 0.3s forwards ease-out;
    border: 1px solid var(--border-light); /* Using new variable */
  }

  body.dark .custom-modal-content {
    background-color: var(--header-dark); /* Dark mode */
    border-color: var(--border-dark); /* Using new variable */
  }

  .custom-modal-title {
    font-size: 1.5rem;
    margin-bottom: 15px;
    color: var(--whatsapp-dark-green); /* Light mode default */
  }

  body.dark .custom-modal-title {
    color: var(--whatsapp-green); /* Dark mode */
  }

  .custom-modal-message {
    font-size: 1rem;
    margin-bottom: 25px;
    line-height: 1.5;
    color: var(--text-dark); /* Light mode default */
  }

  body.dark .custom-modal-message {
    color: #E9EDEF; /* Dark mode */
  }

  .custom-modal-button {
    background-color: var(--whatsapp-dark-green); /* Light mode default */
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease, transform 0.2s ease;
  }

  body.dark .custom-modal-button {
    background-color: var(--whatsapp-green); /* Dark mode */
  }

  .custom-modal-button:hover {
    background-color: var(--whatsapp-green); /* Light mode hover */
    transform: translateY(-2px);
  }

  body.dark .custom-modal-button:hover {
    background-color: #075E54; /* Dark mode hover */
  }

  .custom-modal-message img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin-top: 10px;
    border: 1px solid #ccc;
  }

  #detail-answers-content {
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-light); /* Using new variable */
    padding: 15px;
    border-radius: 8px;
    background-color: #fcfcfc;
  }

  body.dark #detail-answers-content {
    background-color: #111B21;
    border-color: var(--border-dark); /* Using new variable */
  }

  #detail-answers-content p {
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px dashed var(--border-light); /* Using new variable */
  }

  body.dark #detail-answers-content p {
    border-bottom: 1px dashed var(--border-dark); /* Using new variable */
  }

  #detail-answers-content p:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  #detail-answers-content .correct {
    color: var(--whatsapp-dark-green);
  }

  body.dark #detail-answers-content .correct {
    color: var(--whatsapp-green);
  }

  #detail-answers-content .incorrect {
    color: var(--incorrect);
  }

  /* Animations */
  @keyframes fadeInModal {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateY(5px); }
  }
  
  /* Admin Login Modal (already using custom-modal-overlay for consistency) */
  #admin-login-modal {
    display: none; /* Controlled by JS, but default hidden */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  #admin-login-modal-content {
    background-color: var(--white);
    padding: 25px;
    border-radius: 10px;
    width: 350px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  body.dark #admin-login-modal-content {
    background-color: var(--header-dark);
  }
  #admin-login-modal h3 {
    color: var(--whatsapp-dark-green);
    margin-bottom: 20px;
    text-align: center;
  }
  body.dark #admin-login-modal h3 {
    color: var(--whatsapp-green);
  }
  .admin-input-field {
    margin-bottom: 15px;
  }
  .admin-input-field label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-light);
  }
  .admin-input-field input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ddd;
  }
  body.dark .admin-input-field input {
    background: #2A3942;
    border-color: #303D45;
    color: #E9EDEF;
  }
  .admin-modal-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  .admin-login-btn {
    background: var(--whatsapp-dark-green);
    color: white;
  }
  .admin-cancel-btn {
    background: #f44336;
    color: white;
  }

  /* Detail Jawaban Modal Specific (already using custom-modal-overlay and its theme adaptation) */
  #detail-answers-content {
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-light); /* Adjusted */
    padding: 10px;
    border-radius: 5px;
    background-color: #fcfcfc; /* Adjusted */
    color: var(--text-dark); /* Adjusted */
  }
  body.dark #detail-answers-content {
    background-color: #111B21; /* Adjusted */
    border-color: var(--border-dark); /* Adjusted */
    color: #E9EDEF; /* Adjusted */
  }
  #detail-answers-content p {
    margin-bottom: 5px;
  }
  #detail-answers-content .correct { color: var(--correct); }
  #detail-answers-content .incorrect { color: var(--incorrect); }

  #avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-size: cover;
  }  

  /* Utility classes */
  .hidden {
    display: none !important;
  }

/* Responsive Media Queries */
@media (max-width: 767px) { /* Smartphones */
  :root {
    --base-font-size: 13px;
    --header-height: 50px;
    --footer-height: 50px;
  }

  .header {
    padding: 8px 12px;
    height: var(--header-height);
  }

  .avatar {
    width: 36px;
    height: 36px;
  }

  .timer {
    font-size: 12px;
    min-width: 50px;
    padding: 3px 8px;
  }

  .dark-toggle {
    width: 32px;
    height: 32px;
    font-size: 18px;
  }

  .message {
    max-width: 85%;
    font-size: calc(var(--base-font-size) + 0.2px;
    padding: 6px 10px;
  }

  .option-message {
    padding: 8px 10px;
    font-size: calc(var(--base-font-size) + 0.2px;
  }

  .footer {
    height: var(--footer-height);
    padding: 6px 12px;
  }

  button.btn {
    padding: 6px 16px;
    height: 32px;
    font-size: 13px;
  }

  #login-screen {
    padding: 20px 15px;
    max-width: 90%;
  }

  .input-field input {
    padding: 10px 12px;
    font-size: 14px;
  }

  .login-actions button {
    min-width: 120px;
  }

  #result-screen {
    padding: 20px 15px;
  }

  .result-avatar {
    width: 80px;
    height: 80px;
  }

  #admin-screen {
    padding: 15px;
    width: 95%;
  }

  #results-table th, #results-table td {
    padding: 6px 8px;
    font-size: 12px;
  }

  .view-detail-btn {
    padding: 4px 8px;
    font-size: 11px;
  }
}

@media (min-width: 768px) and (max-width: 1023px) { /* Tablets */
  :root {
    --base-font-size: 14px;
  }

  .message {
    max-width: 80%;
  }

  #login-screen {
    max-width: 70%;
  }

  #result-screen {
    max-width: 70%;
  }

  #admin-screen {
    max-width: 90%;
  }
}

@media (min-width: 1024px) { /* Desktop */
  :root {
    --base-font-size: 15px;
  }

  .message {
    max-width: 70%;
  }

  #login-screen {
    max-width: 500px;
  }

  #result-screen {
    max-width: 500px;
  }

  #admin-screen {
    max-width: 900px;
  }
}

/* Additional responsive adjustments */
@media (max-width: 480px) {
  .header-info .name {
    font-size: 14px;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .header-info .status {
    font-size: 11px;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .login-actions {
    flex-direction: column;
    gap: 8px;
  }

  .login-actions button {
    width: 100%;
  }

  #question-counter {
    font-size: 12px;
  }

  #stats-container {
    max-height: 150px;
  }
}

/* Make sure the header stays fixed on mobile */
@media (max-width: 767px) {
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .chat-container {
    margin-top: var(--header-height);
    margin-bottom: var(--footer-height);
  }

  .footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
  }
}

/* Improve option message touch targets on mobile */
@media (max-width: 767px) {
  .option-message {
    min-height: 44px; /* Minimum touch target size */
    display: flex;
    align-items: center;
  }
}

/* Adjust modal sizes for mobile */
@media (max-width: 767px) {
  .custom-modal-content {
    width: 95%;
    padding: 20px;
  }

  #admin-login-modal-content {
    width: 90%;
    padding: 20px;
  }

  #detail-answers-content {
    max-height: 60vh;
  }
}

/* Prevent zoom on input focus for mobile */
@media (max-width: 767px) {
  input, select, textarea {
    font-size: 16px !important;
  }
}
</style>

  <!-- Structured Data for SEO -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Blog",
      "name": "Ujian Online Chat Style SMAPTA",
      "description": "Ujian Online berbasis Smartphone untuk Siswa. Mudah Diakses, Cepat, dan Aman.",
      "url": "https://dedebasuni.github.io/",
      "author": {
        "@type": "Person",
        "name": "Dede Basuni",
        "url": "https://dedebasuni.github.io/",
        "image": "https://lh3.googleusercontent.com/a/AEdFTp5o-M5qkUuK8udmqYnz01dEsVcMwHlzpbEgQmFxng=s230-c",
        "sameAs": [
          "https://www.facebook.com/dede.basuni/",
          "https://twitter.com/dede_basuni",
          "https://www.instagram.com/dede.basuni/",
          "https://www.youtube.com/@dedebasuni"
        ]
      }
    }
  </script>

</head>
<body class="light">

<!-- HEADER -->
<div class="header hidden" id="header">
  <div class="avatar" id="avatar"></div>
  <div class="header-info">
    <div class="name" id="header-name"></div>
    <div class="status" id="header-status"></div>
  </div>
  <div class="timer" id="timer">--:--</div>
  <button class="dark-toggle" id="dark-toggle" title="Toggle Mode Gelap / Terang" aria-label="Toggle Dark Mode">🌙</button>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <h2>Login Peserta Ujian</h2>
  <div class="input-field">
    <label for="noPeserta">No. Peserta</label>
    <input type="text" id="noPeserta" placeholder="Masukkan nomor peserta" aria-label="Nomor Peserta" />
  </div>
  <div class="input-field">
    <label for="nama">Nama Lengkap</label>
    <input type="text" id="nama" placeholder="Masukkan nama lengkap" aria-label="Nama Lengkap" disabled />
  </div>
  <div class="input-field">
    <label for="kelas">Kelas</label>
    <input type="text" id="kelas" placeholder="Masukkan kelas" aria-label="Kelas" disabled />
  </div>
  <div class="login-actions">
    <button id="admin-login-btn" class="btn admin-login-btn">Login Admin</button>
    <button id="start-btn" class="btn btn-primary" disabled>Mulai Ujian</button>    
  </div>
</div>

<!-- EXAM SCREEN -->
<div id="exam-screen" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
  <div class="chat-container" id="chat-messages" aria-live="polite" aria-relevant="additions"></div>
  <div class="footer">
    <div id="question-counter" aria-live="polite" aria-atomic="true">Soal 1/10</div>
    <button id="next-btn" class="btn btn-primary" disabled>Lanjut</button>
  </div>
  <div id="stats-container">
    <h3>Statistik Jawaban</h3>
    <ul id="stats-list"></ul>
  </div>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="hidden">
  <div class="result-avatar"></div>
  <h2 id="result-title">Ujian Selesai!</h2>
  <div id="result-details"></div>
  <button id="restart-btn">Ulangi Ujian</button>
</div>

<!-- ADMIN SCREEN -->
<div id="admin-screen" class="hidden">
  <h2>Hasil Ujian Peserta</h2>
  <div id="results-table-container">
    <table id="results-table">
      <thead>
        <tr>
          <th>No. Peserta</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Skor</th>
          <th>Waktu Selesai</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data akan dimasukkan di sini oleh JavaScript -->
      </tbody>
    </table>
  </div>
  <button id="admin-back-btn" class="btn admin-back-btn">Kembali ke Login</button>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="admin-login-modal">
  <div id="admin-login-modal-content">
    <h3>Login Admin</h3>
    <div class="admin-input-field">
      <label for="admin-username">Username</label>
      <input type="text" id="admin-username" placeholder="Masukkan username admin">
    </div>
    <div class="admin-input-field">
      <label for="admin-password">Password</label>
      <input type="password" id="admin-password" placeholder="Masukkan password">
    </div>
    <div class="admin-modal-actions">
      <button id="admin-login-cancel" class="btn admin-cancel-btn">Batal</button>
      <button id="admin-login-submit" class="btn admin-login-btn">Login</button>
    </div>
  </div>
</div>

<!-- Custom Modal Overlay (for messages/alerts) -->
<div id="custom-modal-overlay" class="custom-modal-overlay" style="display: none;">
  <div class="custom-modal-content">
    <h3 id="custom-modal-title" class="custom-modal-title"></h3>
    <div id="custom-modal-message" class="custom-modal-message"></div>
    <button class="custom-modal-button" onclick="hideCustomModal()">OK</button>
  </div>
</div>

  <!-- Bootstrap JS Bundle with Popper -->
<script>
// Declare showCustomModal and hideCustomModal in the global scope
// so they can be called from inline onclick attributes.
let appState = {}; // Global state to be initialized by init()

function showCustomModal(title, content, isError, isHtmlContent = false) {
    let modalOverlay = document.getElementById('custom-modal-overlay');
    if (!modalOverlay) {
        modalOverlay = document.createElement('div');
        modalOverlay.id = 'custom-modal-overlay';
        modalOverlay.className = 'custom-modal-overlay';
        document.body.appendChild(modalOverlay);

        const modalContentDiv = document.createElement('div');
        modalContentDiv.className = 'custom-modal-content';
        modalOverlay.appendChild(modalContentDiv);

        const modalTitle = document.createElement('h3');
        modalTitle.id = 'custom-modal-title';
        modalTitle.className = 'custom-modal-title';
        modalContentDiv.appendChild(modalTitle);

        const modalMessage = document.createElement('div');
        modalMessage.id = 'custom-modal-message';
        modalMessage.className = 'custom-modal-message';
        modalContentDiv.appendChild(modalMessage);

        const modalButton = document.createElement('button');
        modalButton.textContent = 'OK';
        modalButton.className = 'custom-modal-button';
        // Note: The onclick attribute in HTML directly calls this global function
        modalButton.onclick = () => hideCustomModal(); 
        modalContentDiv.appendChild(modalButton);
    }

    const modalTitleEl = document.getElementById('custom-modal-title');
    const modalMessageEl = document.getElementById('custom-modal-message');
    const modalContentDiv = modalOverlay.querySelector('.custom-modal-content');

    modalTitleEl.textContent = title;
    
    // Apply error color based on isError, and default based on darkMode
    if (isError) {
        modalTitleEl.style.color = 'var(--incorrect)';
        modalContentDiv.style.animation = 'shake 0.5s'; // Add shake animation for errors
        modalContentDiv.addEventListener('animationend', () => {
            modalContentDiv.style.animation = ''; // Remove animation after it finishes
        });
    } else {
        // Use appState.darkMode after it's initialized
        modalTitleEl.style.color = appState.darkMode ? 'var(--whatsapp-green)' : 'var(--whatsapp-dark-green)';
    }

    if (isHtmlContent && typeof content === 'object') {
        modalMessageEl.innerHTML = '';
        modalMessageEl.appendChild(content);
    } else {
        modalMessageEl.textContent = content;
    }

    // Apply background and text colors based on current dark mode state
    if (appState.darkMode) { // Use appState.darkMode
        modalContentDiv.style.backgroundColor = 'var(--header-dark)';
        modalContentDiv.style.color = '#E9EDEF';
        const detailAnsContent = document.getElementById('detail-answers-content');
        if (detailAnsContent) {
            detailAnsContent.style.backgroundColor = '#111B21';
            detailAnsContent.style.borderColor = '#2A3942';
            detailAnsContent.style.color = '#E9EDEF';
        }
    } else {
        modalContentDiv.style.backgroundColor = 'var(--white)';
        modalContentDiv.style.color = 'var(--text-dark)';
        const detailAnsContent = document.getElementById('detail-answers-content');
        if (detailAnsContent) {
            detailAnsContent.style.backgroundColor = '#fcfcfc';
            detailAnsContent.style.borderColor = '#eee';
            detailAnsContent.style.color = 'var(--text-dark)';
        }
    }

    modalOverlay.style.display = 'flex';
  }

  function hideCustomModal() {
      const modalOverlay = document.getElementById('custom-modal-overlay');
      if (modalOverlay) {
          modalOverlay.style.display = 'none';
          // After hiding the modal, re-validate login inputs to update button state.
          // This is crucial for scenarios where the modal was shown due to time constraints
          // or completion status, and the button needs to reflect that.
          if (typeof validateLoginInputs === 'function') { // Ensure function exists before calling
              validateLoginInputs();
          }
      }
  }


  document.addEventListener('DOMContentLoaded', function () {

  const API_URL = 'https://script.google.com/macros/s/AKfycbwCn0QD_1GFvTJwsV3ZiHjQp-7EZzHLvKbiO6bBbjeJGnSId_ntpUFa0aP2EO_mi_hyzg/exec';
  const AU_DIPOYOK = 'mulai';
  const AU_DILEBOK = 'jenuh';

  // Sound effects WhatsApp-style
  const soundCorrect = new Audio('https://cdn.pixabay.com/download/audio/2025/06/06/audio_033375aac8.mp3');
  const soundWrong = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_8b0fae46ef.mp3');

  // State object, now inside DOMContentLoaded but referenced by global functions
  const state = {
    noPeserta: '',
    nama: '',
    kelas: '',
    questions: [],
    participants: [],
    settings: {},
    allResults: [],
    currentQuestionIndex: 0,
    answers: [],
    score: 0,
    timer: null,
    timeLeft: 0,
    typingTimeout: null,
    darkMode: false, // Default to false, will be overridden by localStorage or init
    practiceMode: false,
    examStarted: false, // Flag to track if exam has officially started
  };

  // Assign the state to the global appState for access by global modal functions
  appState = state;


  // DOM Elements
  const body = document.body;
  const header = document.getElementById('header');
  const avatar = document.getElementById('avatar');
  const headerName = document.getElementById('header-name');
  const headerStatus = document.getElementById('header-status');
  const timerEl = document.getElementById('timer');
  const darkToggle = document.getElementById('dark-toggle');

  const loginScreen = document.getElementById('login-screen');
  const examScreen = document.getElementById('exam-screen');
  const resultScreen = document.getElementById('result-screen');
  const adminScreen = document.getElementById('admin-screen');
  const resultsTableBody = document.querySelector('#results-table tbody');

  const chatMessages = document.getElementById('chat-messages');
  const questionCounter = document.getElementById('question-counter');
  const nextBtn = document.getElementById('next-btn');
  const startBtn = document.getElementById('start-btn');
  const adminLoginBtn = document.getElementById('admin-login-btn');
  const adminBackBtn = document.getElementById('admin-back-btn');

  const statsContainer = document.getElementById('stats-container');
  const statsList = document.getElementById('stats-list');

  const resultTitle = document.getElementById('result-title');
  const resultDetails = document.getElementById('result-details');
  const restartBtn = document.getElementById('restart-btn');

  const inputNoPeserta = document.getElementById('noPeserta');
  const inputNama = document.getElementById('nama');
  const inputKelas = document.getElementById('kelas');

  // Admin login modal elements
  const adminLoginModal = document.getElementById('admin-login-modal');
  const adminUsernameInput = document.getElementById('admin-username');
  const adminPasswordInput = document.getElementById('admin-password');
  const adminLoginSubmit = document.getElementById('admin-login-submit');
  const adminLoginCancel = document.getElementById('admin-login-cancel');

  // --- Utility Functions ---

  function isImageUrl(str) {
    return (typeof str === 'string') && (str.startsWith('http://') || str.startsWith('https://')) &&
           (/\.(jpg|jpeg|png|gif|webp)$/i).test(str);
  }

  function createImageElement(src) {
    const img = document.createElement('img');
    img.src = src;
    img.alt = 'Gambar soal';
    img.loading = 'lazy';
    img.onerror = () => {
      console.warn('Failed to load image:', src);
      img.src = `https://placehold.co/150x100/A0A0A0/FFFFFF?text=Gambar+Rusak`;
    };
    return img;
  }

  function getInitials(name) {
    return name
      .split(' ')
      .map(n => n[0])
      .join('')
      .toUpperCase();
  }

  /**
   * Parses a date string in DD/MM/YYYY HH:mm:ss format into a Date object.
   * This helps to avoid browser-specific parsing ambiguities (MM/DD/YYYY vs DD/MM/YYYY).
   * @param {string} dateString - The date string to parse.
   * @returns {Date|null} A Date object or null if parsing fails.
   */
  function parseDDMMYYYY_HHMMSS(dateString) {
      if (!dateString || typeof dateString !== 'string') return null;
      const parts = dateString.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})/);
      if (parts) {
          // Construct ISO 8601 compatible string: YYYY-MM-DDTHH:mm:ss
          // Note: Month in Date constructor is 0-indexed, but here we use it as MM in YYYY-MM-DD
          return new Date(`${parts[3]}-${parts[2]}-${parts[1]}T${parts[4].padStart(2, '0')}:${parts[5]}:${parts[6]}`);
      }
      return null; // Return null if format doesn't match
  }

  // --- Initialization ---

  async function init() {
    // Set default theme to dark if not set in localStorage
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === null) {
      state.darkMode = true; // Default to dark mode
      localStorage.setItem('darkMode', 'true');
    } else {
      state.darkMode = savedDarkMode === 'true';
    }

    if (state.darkMode) {
      body.classList.add('dark');
      body.classList.remove('light');
      darkToggle.textContent = '☀️';
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      darkToggle.textContent = '🌙';
    }

    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      if (data.status !== 'success' || !data.data) {
        throw new Error('Failed to load initial data from Google Sheet.');
      }
      state.settings = data.data.settings || {};
      state.participants = data.data.participants || [];
      state.questions = data.data.questions || [];
      state.allResults = data.data.results || [];

      // Parse start and end times once during initialization
      if (state.settings['Waktu Mulai']) {
          state.settings.parsedStartTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Mulai']);
      }
      if (state.settings['Waktu Selesai']) {
          state.settings.parsedEndTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Selesai']);
      }

      if (state.settings['Mata Pelajaran'] && state.settings['Guru Mapel']) {
        headerName.textContent = `${state.settings['Mata Pelajaran']} - ${state.settings['Guru Mapel']}`;
      } else {
        headerName.textContent = 'Ujian Online';
      }
      headerStatus.textContent = state.settings['Kelas'] ? `Kelas: ${state.settings['Kelas']}` : 'Sedang mengerjakan ujian';

    } catch (e) {
      showCustomModal('Error', `Failed to load initial data: ${e.message}. Pastikan URL API benar dan Google Sheet siap.`, true);
      console.error('Error fetching initial data:', e);
      startBtn.disabled = true;
    }

    inputNoPeserta.addEventListener('input', validateLoginInputs);
    inputNama.addEventListener('input', validateLoginInputs);
    inputKelas.addEventListener('input', validateLoginInputs);

    darkToggle.addEventListener('click', toggleDarkMode);
    startBtn.addEventListener('click', startExam);
    adminLoginBtn.addEventListener('click', showAdminLoginModal);
    nextBtn.addEventListener('click', handleNextQuestion);
    restartBtn.addEventListener('click', restartExam);
    adminBackBtn.addEventListener('click', showLoginScreen);

    // Admin login modal events
    adminLoginSubmit.addEventListener('click', handleAdminLogin);
    adminLoginCancel.addEventListener('click', hideAdminLoginModal);

    // Call validateLoginInputs after initial load to set correct button state
    validateLoginInputs();

    loadFromStorage() ? continueExam() : showLoginScreen();

    // Notifikasi keluar layar
    window.addEventListener('beforeunload', function(event) {
        if (state.examStarted && state.currentQuestionIndex < state.questions.length && state.questions.length > 0) {
            // Cancel the event
            event.preventDefault();
            // Chrome requires returnValue to be set
            event.returnValue = '';
            // Show a custom modal instead of alert
            showCustomModal('Peringatan', 'Anda tidak diperkenankan keluar dari layar ujian sebelum semua soal terjawab!', true);
            return 'Anda tidak diperkenankan keluar dari layar ujian sebelum semua soal terjawab!';
        }
    });

    // Handle visibility change
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && state.examStarted && state.currentQuestionIndex < state.questions.length && state.questions.length > 0) {
            showCustomModal('Peringatan', 'Anda tidak diperkenankan keluar dari layar ujian sebelum semua soal terjawab!', true);
        }
    });

    // Handle orientation changes
    window.addEventListener('orientationchange', function() {
      // Small delay to allow viewport to adjust
      setTimeout(function() {
        scrollToBottom();
      }, 300);
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      scrollToBottom();
    });
  }

  function toggleDarkMode() {
    state.darkMode = !state.darkMode;
    if (state.darkMode) {
      body.classList.add('dark');
      body.classList.remove('light');
      darkToggle.textContent = '☀️';
      localStorage.setItem('darkMode', 'true');
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      darkToggle.textContent = '�';
      localStorage.setItem('darkMode', 'false');
    }
    // Re-apply modal theme if modal is open
    const modalOverlay = document.getElementById('custom-modal-overlay');
    if (modalOverlay && modalOverlay.style.display === 'flex') {
        const modalTitleEl = document.getElementById('custom-modal-title');
        const modalMessageEl = document.getElementById('custom-modal-message');
        const modalContentDiv = modalOverlay.querySelector('.custom-modal-content');
        const isError = modalTitleEl.style.color === 'var(--incorrect)'; // Check if current title color indicates error

        if (state.darkMode) {
            modalContentDiv.style.backgroundColor = 'var(--header-dark)';
            modalContentDiv.style.color = '#E9EDEF';
            modalTitleEl.style.color = isError ? 'var(--incorrect)' : 'var(--whatsapp-green)';
            const detailAnsContent = document.getElementById('detail-answers-content');
            if (detailAnsContent) {
                detailAnsContent.style.backgroundColor = '#111B21';
                detailAnsContent.style.borderColor = '#2A3942';
                detailAnsContent.style.color = '#E9EDEF';
            }
        } else {
            modalContentDiv.style.backgroundColor = 'var(--white)';
            modalContentDiv.style.color = 'var(--text-dark)';
            modalTitleEl.style.color = isError ? 'var(--incorrect)' : 'var(--whatsapp-dark-green)';
            const detailAnsContent = document.getElementById('detail-answers-content');
            if (detailAnsContent) {
                detailAnsContent.style.backgroundColor = '#fcfcfc';
                detailAnsContent.style.borderColor = '#eee';
                detailAnsContent.style.color = 'var(--text-dark)';
            }
        }
    }
  }

  function validateLoginInputs() {
    // Selalu nonaktifkan tombol terlebih dahulu, lalu aktifkan jika semua kondisi terpenuhi
    startBtn.disabled = true; 

    const noPesertaVal = inputNoPeserta.value.trim();
    const namaVal = inputNama.value.trim();
    const kelasVal = inputKelas.value.trim();

    const participant = state.participants.find(p => p.noPeserta === noPesertaVal);

    // Dapatkan waktu saat ini
    const currentTime = new Date();

    // Pastikan parsedStartTime dan parsedEndTime tersedia
    const startTime = state.settings.parsedStartTime;
    const endTime = state.settings.parsedEndTime;

    // Jika waktu mulai/selesai tidak valid atau tidak diatur, tampilkan modal error
    if (!startTime || isNaN(startTime.getTime()) || !endTime || isNaN(endTime.getTime())) {
        showCustomModal('Error Pengaturan Ujian', 'Waktu mulai atau waktu selesai ujian tidak valid. Hubungi administrator.', true);
        return; // Tombol tetap dinonaktifkan
    }

    // Periksa kondisi waktu ujian
    if (currentTime < startTime) {
        showCustomModal('Ujian Belum Dimulai', `Ujian akan dimulai pada ${startTime.toLocaleString('id-ID', {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'})}.`, false);
        return; // Tombol tetap dinonaktifkan
    }
    if (currentTime > endTime) {
        showCustomModal('Ujian Sudah Selesai', `Ujian telah berakhir pada ${endTime.toLocaleString('id-ID', {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'})}.`, false);
        return; // Tombol tetap dinonaktifkan
    }

    // Jika waktu ujian valid, lanjutkan dengan validasi peserta
    if (participant) {
      inputNama.value = participant.nama;
      inputKelas.value = participant.kelas;
      inputNama.disabled = true;
      inputKelas.disabled = true;

      // Check for completion using local storage
      const completedExams = JSON.parse(localStorage.getItem('completedExams') || '{}');
      if (completedExams[noPesertaVal]) {
          showCustomModal('Ujian Selesai', `Maaf, ${participant.nama}, Anda sudah menyelesaikan ujian ini.`, false);
          return; // Tombol tetap dinonaktifkan
      }

      // Jika semua kondisi valid, aktifkan tombol
      startBtn.disabled = false;
    } else { // New participant (not found in sheet)
      inputNama.value = ''; // Clear fields for new participant
      inputKelas.value = '';
      inputNama.disabled = false; // Enable input fields for new participant
      inputKelas.disabled = false;
      
      // For new participants, all fields must be filled and exam time must be valid
      if (noPesertaVal && namaVal && kelasVal) {
          startBtn.disabled = false; // Aktifkan tombol jika semua input terisi dan waktu valid
      }
    }
  }

  // --- Admin Login ---

  function showAdminLoginModal() {
    adminUsernameInput.value = '';
    adminPasswordInput.value = '';
    adminLoginModal.style.display = 'flex';
    adminUsernameInput.focus();
  }

  function hideAdminLoginModal() {
    adminLoginModal.style.display = 'none';
  }

  function handleAdminLogin() {
    const username = adminUsernameInput.value.trim();
    const password = adminPasswordInput.value.trim();

    if (username === AU_DIPOYOK && password === AU_DILEBOK) {
      hideAdminLoginModal();
      showAdminScreen();
    } else {
      showCustomModal('Login Gagal', 'Username atau password salah.', true);
    }
  }

  // --- Exam Flow ---

  async function startExam() {
    const noPesertaVal = inputNoPeserta.value.trim();
    const namaVal = inputNama.value.trim();
    const kelasVal = inputKelas.value.trim();

    // Re-check conditions right before starting the exam to prevent bypass
    const currentTime = new Date();
    const startTime = state.settings.parsedStartTime;
    const endTime = state.settings.parsedEndTime;

    if (!startTime || isNaN(startTime.getTime()) || !endTime || isNaN(endTime.getTime())) {
        showCustomModal('Error Pengaturan Ujian', 'Waktu mulai atau waktu selesai ujian tidak valid. Hubungi administrator.', true);
        return;
    }
    if (currentTime < startTime) {
        showCustomModal('Ujian Belum Dimulai', `Ujian akan dimulai pada ${startTime.toLocaleString('id-ID', {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'})}.`, false);
        return;
    }
    if (currentTime > endTime) {
        showCustomModal('Ujian Sudah Selesai', `Ujian telah berakhir pada ${endTime.toLocaleString('id-ID', {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'})}.`, true);
        return;
    }

    // Check if participant already completed, using local storage
    const completedExams = JSON.parse(localStorage.getItem('completedExams') || '{}');
    if (completedExams[noPesertaVal]) {
        showCustomModal('Ujian Selesai', `Maaf, ${namaVal || 'Anda'}, Anda sudah menyelesaikan ujian ini.`, false);
        return;
    }

    // If all checks pass, proceed to start the exam
    state.noPeserta = noPesertaVal;
    state.nama = namaVal;
    state.kelas = kelasVal;
    state.practiceMode = false;
    state.examStarted = true; // Set exam started flag

    avatar.style.backgroundImage = `url('https://placehold.co/48x48/00a884/ffffff?text=${getInitials(state.nama)}')`;

    loginScreen.classList.add('hidden');
    header.classList.remove('hidden');
    examScreen.classList.remove('hidden');
    statsContainer.classList.remove('hidden');

    chatMessages.innerHTML = '';
    statsList.innerHTML = '';
    questionCounter.textContent = `Soal 1/${state.questions.length}`;
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';

    state.currentQuestionIndex = 0;
    state.answers = [];
    state.score = 0;
    const waktuSetting = parseInt(state.settings['Waktu'] || '60', 10);
    state.timeLeft = waktuSetting * 60;
    clearInterval(state.timer);
    startTimer();

    appendBotMessage(`Halo ${state.nama}! Selamat datang di ujian online.`);
    appendBotMessage('Silakan jawab semua soal dengan memilih salah satu opsi yang tersedia.');

    setTimeout(() => {
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        if (state.questions.length > 0) {
            showQuestion(0);
        } else {
            appendBotMessage('Tidak ada soal yang tersedia. Harap hubungi administrator.');
            nextBtn.disabled = true;
        }
        updateStats();
      }, 1200);
    }, 1000);
  }

  function startTimer() {
    updateTimerDisplay();
    state.timer = setInterval(() => {
      if (state.timeLeft <= 0) {
        clearInterval(state.timer);
        finishExam();
      } else {
        state.timeLeft--;
        updateTimerDisplay();
        saveToStorage();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
    const s = (state.timeLeft % 60).toString().padStart(2, '0');
    timerEl.textContent = `${m}:${s}`;
  }

  // --- Chat & Message Display ---

  function showTypingIndicator() {
    if (document.querySelector('.typing-indicator')) return;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.setAttribute('aria-live', 'polite');
    typingDiv.innerHTML = `
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
    `;
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
  }

  function hideTypingIndicator() {
    const typingDiv = document.querySelector('.typing-indicator');
    if (typingDiv) typingDiv.remove();
  }

  function appendBotMessage(content) {
    hideTypingIndicator();
    const div = document.createElement('div');
    div.className = 'message bot-message';
    if (isImageUrl(content)) {
        div.appendChild(createImageElement(content));
    } else {
        div.textContent = content;
    }
    const timeSpan = document.createElement('span');
    timeSpan.className = 'message-time';
    timeSpan.textContent = getCurrentTime();
    div.appendChild(timeSpan);
    chatMessages.appendChild(div);
    animateAndScroll(div);
  }

  function appendUserMessage(content) {
    const div = document.createElement('div');
    div.className = 'message user-message';
    if (isImageUrl(content)) {
        div.appendChild(createImageElement(content));
    } else {
        div.textContent = content;
    }
    const timeSpan = document.createElement('span');
    timeSpan.className = 'message-time';
    timeSpan.textContent = getCurrentTime();
    div.appendChild(timeSpan);
    chatMessages.appendChild(div);
    animateAndScroll(div);
  }

  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function animateAndScroll(el) {
    el.style.opacity = '0';
    el.style.transform = 'translateY(10px)';
    requestAnimationFrame(() => {
      el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
      scrollToBottom();
    });
  }

  function scrollToBottom() {
    // Small delay to ensure DOM updates are complete
    setTimeout(function() {
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }, 100);
  }

  // --- Question and Answer Logic ---

  function showQuestion(index) {
    state.currentQuestionIndex = index;
    nextBtn.disabled = true;

    chatMessages.querySelectorAll('.option-message').forEach(opt => opt.remove());
    hideTypingIndicator();

    const q = state.questions[index];
    appendBotMessage(q.question);

    showTypingIndicator();
    setTimeout(() => {
      hideTypingIndicator();
      q.options.forEach((opt, i) => {
        const div = document.createElement('div');
        div.className = 'option-message';
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', 'false');

        const optionLabel = `${String.fromCharCode(65 + i)}. `;
        if (isImageUrl(opt)) {
            div.innerHTML = optionLabel;
            div.appendChild(createImageElement(opt));
        } else {
            div.textContent = optionLabel + opt;
        }

        div.addEventListener('click', () => selectAnswer(div, opt, q.correctAnswer));
        div.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectAnswer(div, opt, q.correctAnswer);
          }
        });
        chatMessages.appendChild(div);
        animateAndScroll(div);
      });
      questionCounter.textContent = `Soal ${index + 1} / ${state.questions.length}`;

      const firstOpt = chatMessages.querySelector('.option-message');
      if (firstOpt) firstOpt.focus();
    }, 1200);
  }

  function selectAnswer(selectedDiv, selectedAnswer, correctAnswer) {
    if (!nextBtn.disabled) return;

    appendUserMessage(selectedAnswer);

    document.querySelectorAll('.option-message').forEach(opt => {
      opt.style.pointerEvents = 'none';
      opt.classList.add('selected');
    });

    const isCorrect = selectedAnswer === correctAnswer;
    state.answers.push({
      question: state.questions[state.currentQuestionIndex].question,
      selectedAnswer,
      correctAnswer,
      isCorrect
    });

    try {
      if (isCorrect) {
        soundCorrect.currentTime = 0;
        soundCorrect.play();
        state.score++;
      } else {
        soundWrong.currentTime = 0;
        soundWrong.play();
      }
    } catch (e) {
      console.warn("Sound playback failed:", e);
    }

    document.querySelectorAll('.option-message').forEach(opt => {
      const optContentElement = opt.querySelector('img');
      const optContent = optContentElement ? optContentElement.src : opt.textContent.replace(/^[A-Z]\.\s*/, '');

      const correctContent = isImageUrl(correctAnswer) ? correctAnswer : correctAnswer;

      if (optContent === correctContent || opt.textContent.includes(correctAnswer)) {
        opt.classList.add('correct-answer');
        addStatusIcon(opt, '✓', 'correct-indicator');
      }
      if (opt === selectedDiv && !isCorrect) {
        opt.classList.add('wrong-answer');
        addStatusIcon(opt, '✗', 'incorrect-indicator');
      }
    });

    nextBtn.disabled = false;

    if (state.currentQuestionIndex === state.questions.length - 1) {
      nextBtn.textContent = 'Selesai';
    } else {
      nextBtn.textContent = 'Lanjut';
    }

    updateStats();
    saveToStorage();
  }

  function addStatusIcon(element, icon, className) {
    const span = document.createElement('span');
    span.className = `status-indicator ${className}`;
    span.textContent = icon;
    element.appendChild(span);
  }

  function updateStats() {
    statsList.innerHTML = '';
    state.answers.forEach((ans, i) => {
      const li = document.createElement('li');
      li.textContent = `Soal ${i + 1}: ${ans.isCorrect ? 'Benar' : 'Salah'}`;
      li.className = ans.isCorrect ? 'correct' : 'incorrect';
      statsList.appendChild(li);
    });
  }

  function handleNextQuestion() {
    if (state.currentQuestionIndex < state.questions.length - 1) {
      state.currentQuestionIndex++;
      showQuestion(state.currentQuestionIndex);
    } else {
      finishExam();
    }
  }

  // --- Exam Completion ---

  function finishExam() {
    clearInterval(state.timer);
    state.examStarted = false; // Reset exam started flag

    header.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.remove('hidden');

    // Normalize score to 100
    const totalQuestions = state.questions.length;
    let normalizedScore = 0;
    if (totalQuestions > 0) {
      normalizedScore = Math.round((state.score / totalQuestions) * 100);
    }

    const percentage = normalizedScore; // Use normalized score as percentage
    const emoji = percentage >= 85 ? '🎉' : percentage >= 60 ? '👍' : '💪';
    const feedback = percentage >= 85 ? 'Sempurna!' : percentage >= 60 ? 'Bagus!' : 'Perlu belajar lagi';

    resultTitle.textContent = `Ujian Selesai!`;
    resultDetails.innerHTML = `
      <p>No. Peserta: ${state.noPeserta}</p>
      <p>Nama: ${state.nama}</p>
      <p>Kelas: ${state.kelas}</p>
      <p>Skor: ${state.score} dari ${totalQuestions} soal</p>
      <p>Nilai Akhir (Skala 100): <strong>${normalizedScore}</strong></p>
      <p><strong>${feedback} ${emoji}</strong></p>
    `;

    sendResults(normalizedScore); // Send normalized score
    clearStorage();
  }

  async function sendResults(finalScore) { // Accept finalScore as parameter
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          noPeserta: state.noPeserta,
          nama: state.nama,
          kelas: state.kelas,
          score: finalScore, // Send the normalized score
          answers: state.answers,
        }),
        mode: 'no-cors',
      });
      console.log('Hasil ujian dikirim:', response);
      const participantIndex = state.participants.findIndex(p => p.noPeserta === state.noPeserta);
      if (participantIndex !== -1) {
        state.participants[participantIndex].isCompleted = true;
      }
      // Mark as completed in local storage for persistence across sessions/reloads
      const completedExams = JSON.parse(localStorage.getItem('completedExams') || '{}');
      completedExams[state.noPeserta] = true;
      localStorage.setItem('completedExams', JSON.stringify(completedExams));

      await fetchAllInitialData(); // Re-fetch all data, though localStorage is now primary for completion status
    } catch (e) {
      console.warn('Gagal kirim hasil ujian:', e);
    }
  }

  // --- Restart & Continue Exam ---

  function restartExam() {
    resultScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    statsContainer.classList.add('hidden');
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';
    chatMessages.innerHTML = '';
    inputNoPeserta.value = '';
    inputNama.value = '';
    inputKelas.value = '';
    inputNama.disabled = false;
    inputKelas.disabled = false;
    startBtn.disabled = true;
    state.answers = [];
    state.score = 0;
    state.currentQuestionIndex = 0;
    state.examStarted = false; // Reset exam started flag
    clearStorage();
    clearInterval(state.timer);
    updateTimerDisplay();
    validateLoginInputs(); // Re-validate after restart for exam time check
  }

  function continueExam() {
    avatar.style.backgroundImage = `url('https://placehold.co/48x48/00a884/ffffff?text=${getInitials(state.nama)}')`;

    loginScreen.classList.add('hidden');
    header.classList.remove('hidden');
    examScreen.classList.remove('hidden');
    statsContainer.classList.remove('hidden');

    chatMessages.innerHTML = '';
    statsList.innerHTML = '';

    questionCounter.textContent = `Soal ${state.currentQuestionIndex + 1} / ${state.questions.length}`;
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';

    state.examStarted = true; // Set exam started flag for continuation

    startTimer();

    appendBotMessage(`Selamat datang kembali, ${state.nama}!`);
    appendBotMessage('Anda dapat melanjutkan ujian dari sebelumnya.');

    setTimeout(() => {
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        if (state.questions.length > 0) {
            showQuestion(state.currentQuestionIndex);
        } else {
            appendBotMessage('Tidak ada soal yang tersedia. Harap hubungi administrator.');
            nextBtn.disabled = true;
        }
        updateStats();
      }, 1200);
    }, 1000);
  }

  function showLoginScreen() {
    loginScreen.classList.remove('hidden');
    header.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    adminScreen.classList.add('hidden');
    statsContainer.classList.add('hidden');
    validateLoginInputs(); // Re-validate when returning to login screen
  }

  // --- Admin Functions ---

  async function showAdminScreen() {
    loginScreen.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    header.classList.add('hidden');
    adminScreen.classList.remove('hidden');

    showCustomModal('Memuat Data', 'Sedang memuat data hasil ujian...', false);
    await fetchAllInitialData();
    populateAdminResultsTable();
    hideCustomModal();
  }

  async function fetchAllInitialData() {
      try {
          const response = await fetch(API_URL);
          const data = await response.json();
          if (data.status !== 'success' || !data.data) {
              throw new Error('Failed to load initial data from Google Sheet.');
          }
          state.settings = data.data.settings || {};
          state.participants = data.data.participants || [];
          state.questions = data.data.questions || [];
          state.allResults = data.data.results || [];

          // Re-parse start and end times after re-fetching settings
          if (state.settings['Waktu Mulai']) {
              state.settings.parsedStartTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Mulai']);
          }
          if (state.settings['Waktu Selesai']) {
              state.settings.parsedEndTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Selesai']);
          }

      } catch (e) {
          showCustomModal('Error', `Failed to reload data: ${e.message}.`, true);
          console.error('Error fetching initial data for admin:', e);
      }
  }

  function populateAdminResultsTable() {
    resultsTableBody.innerHTML = '';

    if (state.allResults.length === 0) {
      const row = resultsTableBody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 6;
      cell.textContent = 'Belum ada hasil ujian.';
      cell.style.textAlign = 'center';
      return;
    }

    state.allResults.forEach(result => {
      const row = resultsTableBody.insertRow();
      row.insertCell().textContent = result.noPeserta;
      row.insertCell().textContent = result.nama;
      row.insertCell().textContent = result.kelas;
      // Display score as normalized score, if question length is available
      const displayScore = state.questions.length > 0 ?
          `${result.score} (Nilai: ${Math.round((result.score / state.questions.length) * 100)})` :
          result.score; // If no questions, just show raw score
      row.insertCell().textContent = displayScore;

      const timestamp = new Date(result.timestamp);
      row.insertCell().textContent = timestamp.toLocaleString('id-ID', {
          year: 'numeric', month: 'numeric', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
      });

      const detailCell = row.insertCell();
      const detailButton = document.createElement('button');
      detailButton.textContent = 'Lihat Detail';
      detailButton.className = 'btn view-detail-btn';
      detailButton.onclick = () => showAnswerDetailsModal(result.answers);
      detailCell.appendChild(detailButton);
    });
  }

  function showAnswerDetailsModal(answersJson) {
    let answers;
    try {
      answers = JSON.parse(answersJson);
    } catch (e) {
      showCustomModal('Error', 'Gagal memparsing detail jawaban.', true);
      console.error('Error parsing answers JSON:', e);
      return;
    }

    const modalContent = document.createElement('div');
    modalContent.id = 'detail-answers-content';

    answers.forEach((ans, index) => {
      const p = document.createElement('p');
      p.innerHTML = `<strong>Soal ${index + 1}:</strong> ${ans.question}`;
      if (isImageUrl(ans.question)) {
          p.innerHTML = `<strong>Soal ${index + 1}:</strong> `;
          p.appendChild(createImageElement(ans.question));
      }

      const selectedAnswerText = isImageUrl(ans.selectedAnswer) ?
          `Jawaban Anda: <img src="${ans.selectedAnswer}" alt="Jawaban Anda" style="max-width: 80px; height: auto;">` :
          `Jawaban Anda: ${ans.selectedAnswer}`;
      const correctAnswerText = isImageUrl(ans.correctAnswer) ?
          `Jawaban Benar: <img src="${ans.correctAnswer}" alt="Jawaban Benar" style="max-width: 80px; height: auto;">` :
          `Jawaban Benar: ${ans.correctAnswer}`;

      p.innerHTML += `<br>${selectedAnswerText}`;
      p.innerHTML += `<br>${correctAnswerText}`;

      if (ans.isCorrect) {
        p.className = 'correct';
        p.innerHTML += ' (Benar)';
      } else {
        p.className = 'incorrect';
        p.innerHTML += ' (Salah)';
      }
      modalContent.appendChild(p);
    });

    showCustomModal('Detail Jawaban', modalContent, false, true);
  }

  // --- Local Storage Functions ---

  function saveToStorage() {
    localStorage.setItem('ujian-online-data', JSON.stringify({
      noPeserta: state.noPeserta,
      nama: state.nama,
      kelas: state.kelas,
      questions: state.questions,
      answers: state.answers,
      score: state.score,
      currentQuestionIndex: state.currentQuestionIndex,
      timeLeft: state.timeLeft,
      practiceMode: state.practiceMode,
      settings: state.settings
    }));
  }

  function loadFromStorage() {
    const data = localStorage.getItem('ujian-online-data');
    if (!data) return false;
    try {
      const obj = JSON.parse(data);
      if (obj && obj.nama && obj.kelas && obj.questions && obj.answers && obj.settings) {
        // Only load essential state to avoid overwriting current logic for examStarted
        state.noPeserta = obj.noPeserta;
        state.nama = obj.nama;
        state.kelas = obj.kelas;
        state.questions = obj.questions;
        state.answers = obj.answers;
        state.score = obj.score;
        state.currentQuestionIndex = obj.currentQuestionIndex;
        state.timeLeft = obj.timeLeft;
        state.practiceMode = obj.practiceMode;
        state.settings = obj.settings;

        // Re-parse start and end times after loading settings from storage
        if (state.settings['Waktu Mulai']) {
            state.settings.parsedStartTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Mulai']);
        }
        if (state.settings['Waktu Selesai']) {
            state.settings.parsedEndTime = parseDDMMYYYY_HHMMSS(state.settings['Waktu Selesai']);
        }

        // Do not load examStarted from storage, it's determined by current session
        state.examStarted = false; // Ensure it's false when loaded from storage, then set by continueExam if needed.


        if (state.settings['Mata Pelajaran'] && state.settings['Guru Mapel']) {
          headerName.textContent = `${state.settings['Mata Pelajaran']} - ${state.settings['Guru Mapel']}`;
        } else {
          headerName.textContent = 'Ujian Online';
        }
        headerStatus.textContent = state.settings['Kelas'] ? `Kelas: ${state.settings['Kelas']}` : 'Sedang mengerjakan ujian';
        // Removed validateLoginInputs() here, it's called explicitly at the end of init
        return true;
      }
    } catch (e) {
      console.error("Failed to load from storage:", e);
      return false;
    }
    return false;
  }

  function clearStorage() {
    localStorage.removeItem('ujian-online-data');
  }

  // Initialize the app
  init();
});
</script>

</body>
</html>
