<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Konversi Nilai</title>
    <link rel="icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=128" type="image/png">
    <link rel="apple-touch-icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=192">
    <!-- Vue JS -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- SheetJS untuk Export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome & Ikon -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #0f766e; /* Teal untuk nuansa Akademik/Merdeka */
            --primary-dark: #0d9488;
            --primary-light: #f0fdfa;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* --- HEADER --- */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, #0f766e 100%);
            color: white;
            padding: 1rem;
            flex-shrink: 0;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .header-content { max-width: 1400px; margin: 0 auto; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .logo { font-size: 1.25rem; font-weight: 800; display: flex; align-items: center; gap: 0.8rem; }
        .logo i { background: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 8px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; }
        .stat-card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(4px);
            padding: 0.5rem 1rem; border-radius: 8px; text-align: center;
            border: 1px solid rgba(255,255,255,0.15);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-val { font-weight: 700; font-size: 1.2rem; line-height: 1.1; }
        .stat-lbl { font-size: 0.7rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* --- TOOLBAR --- */
        .toolbar {
            background: var(--bg-surface); padding: 0.5rem 1rem; display: flex; gap: 0.5rem;
            border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0;
            white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;
        }
        .toolbar::-webkit-scrollbar { display: none; }
        
        .tool-btn {
            padding: 0.5rem 0.9rem; border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg-surface); color: var(--text-main); font-size: 0.85rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.2s;
        }
        .tool-btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .tool-btn:active { transform: translateY(1px); }
        .tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tool-btn.primary { background: var(--primary-light); color: var(--primary); border-color: #99f6e4; }
        .tool-btn.primary:hover { background: #ccfbf1; }
        .tool-btn.success { background: #ecfdf5; color: #059669; border-color: #a7f3d0; }
        .tool-btn.info { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .tool-sep { width: 1px; background: var(--border); margin: 0 0.3rem; height: 24px; align-self: center; }
        
        /* --- MAIN LAYOUT --- */
        .main-layout {
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: relative; 
            background: var(--bg-body);
            min-height: 0; /* CRITICAL FIX for Firefox mobile */
        }
        
        /* --- TABS --- */
        .nav-tabs {
            display: flex; 
            background: var(--bg-surface); 
            border-bottom: 1px solid var(--border); 
            flex-shrink: 0;
        }
        .nav-item {
            flex: 1; 
            padding: 1rem; 
            text-align: center; 
            font-size: 0.9rem; 
            font-weight: 600;
            color: var(--text-muted); 
            border-bottom: 3px solid transparent; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
        }
        .nav-item.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8fafc; }
        
        /* --- CONTENT PANELS --- */
        .content-area {
            flex: 1; 
            overflow: hidden; /* Changed from auto to hidden */
            padding: 1rem; 
            display: grid; 
            gap: 1rem;
            height: 100%;
        }
        .mobile-hidden { display: none !important; }
        
        .panel {
            background: var(--bg-surface); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
            border: 1px solid var(--border); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }
        
        /* --- SETTINGS --- */
        .setting-group { 
            padding: 1.5rem; 
            flex: 1;
            overflow-y: auto; /* Enable scroll for settings */
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
        }
        .form-row { margin-bottom: 1.2rem; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; }
        .input-wrapper {
            display: flex; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden;
            transition: 0.2s; background: white;
        }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .input-field { flex: 1; border: none; padding: 0.8rem; font-size: 1rem; outline: none; width: 100%; }
        .input-suffix { background: #f8fafc; padding: 0 1rem; display: flex; align-items: center; font-size: 0.85rem; color: var(--text-muted); border-left: 1px solid #cbd5e1; font-weight: 500; }
        .input-disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        
        .formula-box {
            background: #f0fdfa; padding: 1rem; border-radius: 8px; border: 1px solid #99f6e4;
            font-size: 0.9rem; color: #0f766e; margin-top: 1rem; line-height: 1.6;
        }
        .legend-table {
            width: 100%; font-size: 0.8rem; margin-top: 0.5rem; border-collapse: collapse;
        }
        .legend-table td { padding: 4px; border-bottom: 1px solid #e2e8f0; }
        .legend-table tr:last-child td { border: none; }
        
        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
        }
        .modal-content {
            background: white; border-radius: var(--radius); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header {
            padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .modal-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); text-align: right; }
        
        /* --- GUIDE STYLES --- */
        .guide-section { margin-bottom: 2rem; }
        .guide-title { color: var(--primary); font-weight: 700; margin-bottom: 0.8rem; font-size: 1rem; }
        .guide-content { color: var(--text-main); line-height: 1.6; }
        .guide-step { margin-bottom: 0.8rem; padding-left: 1.2rem; position: relative; }
        .guide-step:before { content: "→"; position: absolute; left: 0; color: var(--primary); }
        .guide-hotkey { background: #f1f5f9; padding: 0.2rem 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; }
        .formula-display {
            background: #1e293b; color: white; padding: 1rem; border-radius: 8px;
            font-family: monospace; font-size: 0.95rem; margin: 1rem 0; overflow-x: auto;
        }
        .formula-var { color: #60a5fa; }
        .formula-num { color: #fbbf24; }
        .formula-op { color: #34d399; }
        
        /* --- GRID --- */
        .grid-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            min-height: 300px; 
        }
        .grid-container { 
            flex: 1; 
            overflow: auto; 
            border-bottom: 1px solid var(--border);
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
        }
        .grid-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 450px; }
        
        .grid-th {
            background: #f8fafc; color: var(--text-muted); font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; padding: 0.8rem 0.5rem; text-align: center;
            border-bottom: 1px solid var(--border); border-right: 1px solid var(--border);
            position: sticky; top: 0; z-index: 10;
        }
        .grid-th:last-child { border-right: none; }
        
        .grid-td {
            border-bottom: 1px solid var(--border); border-right: 1px solid var(--border);
            padding: 0; height: 44px; position: relative; background: white;
        }
        .grid-td:last-child { border-right: none; }
        
        .cell-input {
            width: 100%; height: 100%; border: none; outline: none; padding: 0 0.5rem;
            text-align: center; font-family: inherit; font-size: 0.95rem; background: transparent;
        }
        .cell-input:focus { box-shadow: inset 0 0 0 2px var(--primary); background: #f0fdfa; font-weight: 600; }
        .cell-input.invalid { background: #fef2f2; color: var(--danger); font-weight: 700; }
        
        .cell-readonly {
            display: flex; align-items: center; justify-content: center; height: 100%;
            font-size: 0.95rem; font-weight: 600; color: var(--text-main); background: #fdfdfd; cursor: default;
        }
        
        /* CAPAIAN BADGES (Kurikulum Merdeka) */
        .capaian-badge {
            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800;
            display: inline-block; min-width: 40px; text-align: center; letter-spacing: 0.5px;
        }
        /* Sangat Berkembang (SB) */
        .lv-SB { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; } 
        /* Berkembang Sesuai Harapan (BSH) */
        .lv-BSH { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
        /* Mulai Berkembang (MB) */
        .lv-MB { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        /* Perlu Bimbingan (PB) */
        .lv-PB { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        
        /* Col Widths */
        .col-idx { width: 45px; background: #f8fafc; color: #94a3b8; font-size: 0.75rem; text-align: center; }
        .col-val { width: 30%; }
        .col-res { width: 30%; }
        .col-cap { width: 25%; }
        
        .grid-footer {
            padding: 0.8rem; background: var(--bg-surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* --- TOAST & FAB --- */
        .toast-container {
            position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%);
            z-index: 1000; pointer-events: none; width: 90%; max-width: 400px; text-align: center;
        }
        .toast {
            background: #1e293b; color: white; padding: 0.8rem 1.2rem; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.6rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .fab {
            position: fixed; bottom: 1.5rem; right: 1.5rem; width: 56px; height: 56px; border-radius: 50%;
            background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
            font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; z-index: 90;
        }
        .fab:active { transform: scale(0.9); }
        
        /* --- CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 767px) {
            /* Mobile layout */
            body {
                overflow: auto;
                height: auto;
                min-height: 100vh;
            }
            
            .app-container {
                min-height: 100vh;
                height: auto;
            }
            
            /* Mobile tabs handling */
            .content-area {
                display: block;
                padding: 0;
                height: calc(100vh - 120px); /* Adjust based on header height */
                overflow: hidden;
                position: relative;
            }
            
            .panel {
                border-radius: 0;
                border: none;
                box-shadow: none;
                height: 100%;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                display: none;
            }
            
            .panel:not(.mobile-hidden) {
                display: flex;
            }
            
            /* Settings panel scroll fix */
            .panel .setting-group {
                height: 100%;
                overflow-y: auto;
                padding-bottom: 80px; /* Space for tabs */
                -webkit-overflow-scrolling: touch;
            }
            
            /* Grid panel scroll fix */
            .panel.grid-wrapper {
                padding: 0;
                display: flex;
                flex-direction: column;
            }
            
            .grid-container {
                height: calc(100vh - 180px); /* Responsive height */
                min-height: 400px;
            }
            
            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            
            /* Nav tabs sticky */
            .nav-tabs {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
            }
            
            /* Hide FAB on mobile when keyboard is open */
            .fab {
                bottom: 2rem;
            }
            
            /* Better touch targets */
            .cell-input {
                font-size: 1rem;
                padding: 0.8rem;
            }
            
            .tool-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
            
            /* Mobile formula box */
            .formula-box {
                font-size: 0.85rem;
                padding: 0.8rem;
            }
        }
        
        /* --- DESKTOP OPTIMIZATION --- */
        @media (min-width: 768px) {
            body { 
                background: #e2e8f0; 
                padding: 0;
                margin: 0;
            }
            
            .app-header { 
                padding: 0.8rem 1.5rem; 
                border-radius: 0;
            }
            
            .header-content { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
            }
            
            .header-top { 
                margin-bottom: 0; 
                flex: 1; 
            }
            
            .stats-grid { 
                gap: 1.5rem; 
                margin-left: 2rem; 
                grid-template-columns: repeat(4, 1fr);
            }
            
            .nav-tabs, .fab { 
                display: none; 
            }
            
            .main-layout {
                max-width: 1600px; 
                margin: 1.5rem auto; 
                width: 95%; 
                border-radius: 12px;
                overflow: hidden; 
                box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
                background: var(--bg-body); 
                border: 1px solid #cbd5e1;
                height: calc(100vh - 3rem);
                min-height: 700px;
            }
            
            .content-area { 
                padding: 0; 
                display: grid; 
                grid-template-columns: 380px 1fr; 
                gap: 0; 
                background: white; 
                height: 100%;
            }
            
            .panel { 
                border-radius: 0; 
                box-shadow: none; 
                border: none; 
                height: 100%;
            }
            
            .mobile-hidden { 
                display: flex !important; 
            }
            
            .setting-group { 
                background: #f8fafc; 
                border-right: 1px solid var(--border); 
                height: 100%; 
                overflow-y: auto;
                padding-bottom: 2rem;
            }
            
            .mobile-only-btn { 
                display: none !important; 
            }
            
            /* Desktop grid optimization */
            .grid-container {
                max-height: calc(100vh - 200px);
            }
        }
        
        /* --- TABLET OPTIMIZATION --- */
        @media (min-width: 768px) and (max-width: 1024px) {
            .main-layout {
                width: 98%;
                margin: 1rem auto;
            }
            
            .content-area {
                grid-template-columns: 320px 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        
        /* --- FIX FOR IOS SAFARI --- */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific fixes */
            .setting-group {
                padding-bottom: 40px; /* Extra space for iOS */
            }
            
            .grid-container {
                -webkit-overflow-scrolling: touch;
            }
            
            body {
                height: -webkit-fill-available;
            }
            
            .app-container {
                min-height: -webkit-fill-available;
            }
        }
        
        /* --- FIX FOR MOBILE KEYBOARD --- */
        @media (max-height: 500px) and (orientation: landscape) {
            /* Landscape mobile with keyboard */
            .main-layout {
                height: auto;
                min-height: 100vh;
            }
            
            .grid-container {
                height: 300px;
            }
            
            .setting-group {
                padding-bottom: 40px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Konversi Nilai</span>
                    </div>
                    <button class="tool-btn info" @click="showModal = true" style="color: white; background: rgba(255,255,255,0.15);">
                        <i class="fas fa-question-circle"></i> Panduan
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val">{{ XA || '-' }}</div>
                        <div class="stat-lbl">Max Asli (XA)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val">{{ XB || '-' }}</div>
                        <div class="stat-lbl">Min Asli (XB)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val">{{ YA }}</div>
                        <div class="stat-lbl">Target Max (YA)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val">{{ convertedCount }}</div>
                        <div class="stat-lbl">Data Dikonversi</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="tool-btn" @click="undo" :disabled="historyIndex <= 0" title="Ctrl+Z">
                <i class="fas fa-undo"></i> Undo
            </button>
            <button class="tool-btn" @click="redo" :disabled="historyIndex >= history.length - 1" title="Ctrl+Y">
                <i class="fas fa-redo"></i> Redo
            </button>
            <div class="tool-sep"></div>
            <button class="tool-btn primary" @click="exportExcel">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
            <button class="tool-btn" @click="copyResults">
                <i class="fas fa-copy"></i> Copy Hasil
            </button>
            <button class="tool-btn success" @click="showFormulaGuide" title="Lihat Rumus">
                <i class="fas fa-calculator"></i> Rumus
            </button>
            <button class="tool-btn" @click="resetAll">
                <i class="fas fa-trash-alt"></i> Reset
            </button>
            
            <div style="margin-left: auto; display: flex; align-items: center; font-size: 0.75rem; color: #64748b; gap: 0.5rem;">
                <span v-if="saveStatus === 'saved'"><i class="fas fa-check-circle" style="color:#10b981"></i> Tersimpan</span>
                <span v-else-if="saveStatus === 'saving'"><i class="fas fa-spinner fa-spin"></i> Menyimpan...</span>
                <span style="margin-left: 0.5rem;">Auto-save aktif</span>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <div class="nav-tabs">
                <div class="nav-item" :class="{active: activeTab === 'input'}" @click="activeTab = 'input'">
                    <i class="fas fa-sliders-h"></i> Setelan
                </div>
                <div class="nav-item" :class="{active: activeTab === 'data'}" @click="activeTab = 'data'">
                    <i class="fas fa-table"></i> Spreadsheet
                </div>
            </div>

            <div class="content-area">
                <!-- PANEL 1: SETTINGS -->
                <div class="panel" :class="{ 'mobile-hidden': activeTab !== 'input' }">
                    <div class="setting-group">
                        <h3 style="margin-bottom: 1.2rem; color: var(--text-main); font-size: 1.1rem;">
                            <i class="fas fa-bullseye" style="color: var(--primary)"></i> Target Konversi
                        </h3>
                        
                        <div class="form-row">
                            <label class="form-label">Nilai Target Maksimal (YA)</label>
                            <div class="input-wrapper">
                                <input type="number" v-model="YA" class="input-field" @input="handleParamChange" min="0" max="100" step="0.1">
                                <div class="input-suffix">Poin</div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.3rem;">
                                Nilai tertinggi setelah konversi (default: 85)
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Nilai Target Minimal (YB)</label>
                            <div class="input-wrapper">
                                <input type="number" v-model="YB" class="input-field" @input="handleParamChange" min="0" max="100" step="0.1">
                                <div class="input-suffix">Poin</div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.3rem;">
                                Nilai terendah setelah konversi (default: 70)
                            </div>
                        </div>

                        <hr style="border: 0; border-top: 1px dashed #cbd5e1; margin: 2rem 0;">
                        
                        <h3 style="margin-bottom: 1.2rem; color: var(--text-main); font-size: 1.1rem;">
                            <i class="fas fa-chart-line" style="color: var(--primary)"></i> Statistik Data
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-row">
                                <label class="form-label">Max Asli (XA)</label>
                                <div class="input-wrapper">
                                    <input type="number" :value="XA" class="input-field input-disabled" disabled placeholder="-">
                                    <div class="input-suffix">Auto</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.3rem;">
                                    Terdeteksi otomatis
                                </div>
                            </div>
                            <div class="form-row">
                                <label class="form-label">Min Asli (XB)</label>
                                <div class="input-wrapper">
                                    <input type="number" :value="XB" class="input-field input-disabled" disabled placeholder="-">
                                    <div class="input-suffix">Auto</div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.3rem;">
                                    Terdeteksi otomatis
                                </div>
                            </div>
                        </div>

                        <!-- Info Kurikulum Merdeka -->
                        <div class="formula-box" style="margin-top: 2rem;">
                            <strong><i class="fas fa-star" style="color: #fbbf24"></i> Standar Kurikulum Merdeka:</strong>
                            <table class="legend-table" style="margin-top: 0.8rem;">
                                <tr>
                                    <td><span class="capaian-badge lv-SB">SB</span></td>
                                    <td><strong>86 - 100</strong></td>
                                    <td>Sangat Berkembang (Melampaui CP)</td>
                                </tr>
                                <tr>
                                    <td><span class="capaian-badge lv-BSH">BSH</span></td>
                                    <td><strong>76 - 85</strong></td>
                                    <td>Berkembang Sesuai Harapan (Sesuai CP)</td>
                                </tr>
                                <tr>
                                    <td><span class="capaian-badge lv-MB">MB</span></td>
                                    <td><strong>66 - 75</strong></td>
                                    <td>Mulai Berkembang (Sebagian CP)</td>
                                </tr>
                                <tr>
                                    <td><span class="capaian-badge lv-PB">PB</span></td>
                                    <td><strong>≤ 65</strong></td>
                                    <td>Perlu Bimbingan (Belum Mencapai CP)</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Quick Tips -->
                        <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fde047;">
                            <h4 style="color: #92400e; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-lightbulb"></i> Tips Cepat:
                            </h4>
                            <ul style="font-size: 0.8rem; color: #92400e; padding-left: 1rem;">
                                <li>Tekan <span class="guide-hotkey">Enter</span> atau <span class="guide-hotkey">↓</span> untuk pindah ke baris berikutnya</li>
                                <li><span class="guide-hotkey">Ctrl+D</span> untuk menduplikasi nilai dari baris atas</li>
                                <li>Tempel data langsung dari Excel dengan <span class="guide-hotkey">Ctrl+V</span></li>
                            </ul>
                        </div>

                        <div class="mobile-only-btn" style="margin-top: 2rem;">
                            <button class="tool-btn primary" style="width: 100%; justify-content: center;" @click="activeTab = 'data'">
                                Buka Spreadsheet <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PANEL 2: SPREADSHEET -->
                <div class="panel grid-wrapper" :class="{ 'mobile-hidden': activeTab !== 'data' }">
                    <div class="grid-container">
                        <table class="grid-table">
                            <thead>
                                <tr>
                                    <th class="grid-th col-idx">#</th>
                                    <th class="grid-th col-val">NILAI ASLI</th>
                                    <th class="grid-th col-res">HASIL KONVERSI</th>
                                    <th class="grid-th col-cap">CAPAIAN</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, index) in dataRows" :key="row.id">
                                    <td class="grid-td col-idx">
                                        <div class="cell-readonly" style="color: #94a3b8; font-size: 0.8rem;">
                                            {{ index + 1 }}
                                        </div>
                                    </td>
                                    <!-- INPUT -->
                                    <td class="grid-td col-val">
                                        <input 
                                            type="text" 
                                            class="cell-input" 
                                            :class="{ invalid: isInvalid(row.nilaiAsli) }"
                                            v-model="row.nilaiAsli" 
                                            inputmode="decimal"
                                            :id="'cell-' + index"
                                            autocomplete="off"
                                            @input="handleInput(row)"
                                            @keydown="handleKeydown($event, index, row)"
                                            @paste="handlePaste($event, index)"
                                            @focus="focusedIndex = index"
                                            placeholder="-"
                                            :title="isInvalid(row.nilaiAsli) ? 'Nilai harus antara 0-100' : ''"
                                        >
                                    </td>
                                    <!-- RESULT -->
                                    <td class="grid-td col-res">
                                        <div class="cell-readonly" 
                                             :style="{color: row.hasilKonversi ? 'var(--primary)' : '#cbd5e1', 
                                                      'font-weight': '700'}">
                                            {{ row.hasilKonversi || '-' }}
                                        </div>
                                    </td>
                                    <!-- LEVEL (SB/BSH/MB/PB) -->
                                    <td class="grid-td col-cap">
                                        <div class="cell-readonly" style="background: white;">
                                            <div v-if="row.levelCode" 
                                                 class="capaian-badge" 
                                                 :class="'lv-' + row.levelCode"
                                                 :title="row.levelDesc">
                                                {{ row.levelCode }}
                                            </div>
                                            <span v-else style="color: #cbd5e1; font-size: 0.85rem;">-</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="grid-footer">
                        <button class="tool-btn" @click="addNewRow">
                            <i class="fas fa-plus"></i> Tambah Baris ({{ dataRows.length }})
                        </button>
                        <div style="font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: var(--primary)"></i>
                            <span>Kurikulum Merdeka - {{ dataRows.filter(r => r.nilaiAsli !== '').length }} data dimasukkan</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Panduan -->
        <div class="modal-overlay" v-if="showModal" @click.self="showModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-book" style="color: var(--primary); margin-right: 0.5rem;"></i>
                        Panduan Lengkap Konversi Nilai
                    </div>
                    <button class="modal-close" @click="showModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Rumus Konversi -->
                    <div class="guide-section">
                        <div class="guide-title">
                            <i class="fas fa-calculator"></i> Rumus Konversi Nilai
                        </div>
                        <div class="guide-content">
                            <p>Aplikasi ini menggunakan <strong>metode linear transformation</strong> untuk menyesuaikan rentang nilai asli ke rentang target:</p>
                            
                            <div class="formula-display">
                                Y = <span class="formula-var">((YA - YB) / (XA - XB))</span> × <span class="formula-var">(X - XB)</span> + <span class="formula-var">YB</span>
                            </div>
                            
                            <table style="width: 100%; font-size: 0.85rem; margin: 1rem 0;">
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>Y</strong></td>
                                    <td>= Hasil konversi (output)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>X</strong></td>
                                    <td>= Nilai asli (input)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>YA</strong></td>
                                    <td>= Nilai target maksimal (default: 85)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>YB</strong></td>
                                    <td>= Nilai target minimal (default: 70)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>XA</strong></td>
                                    <td>= Nilai maksimal asli (terdeteksi otomatis)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.3rem;"><strong>XB</strong></td>
                                    <td>= Nilai minimal asli (terdeteksi otomatis)</td>
                                </tr>
                            </table>
                            
                            <p><strong>Contoh:</strong> Jika XA=100, XB=60, YA=85, YB=70, dan nilai asli X=80:</p>
                            <div class="formula-display">
                                Y = ((85 - 70) / (100 - 60)) × (80 - 60) + 70<br>
                                Y = (15 / 40) × 20 + 70<br>
                                Y = 0.375 × 20 + 70 = 7.5 + 70 = <span class="formula-num">77.5</span> → dibulatkan menjadi <span class="formula-num">78</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panduan Penggunaan -->
                    <div class="guide-section">
                        <div class="guide-title">
                            <i class="fas fa-user-graduate"></i> Panduan Penggunaan
                        </div>
                        <div class="guide-content">
                            <div class="guide-step">
                                <strong>1. Atur Parameter Target</strong> - Tentukan YA (target maksimal) dan YB (target minimal) di panel Setelan
                            </div>
                            <div class="guide-step">
                                <strong>2. Masukkan Data Nilai</strong> - Input nilai asli di kolom INPUT (bisa paste dari Excel)
                            </div>
                            <div class="guide-step">
                                <strong>3. Hasil Otomatis</strong> - Konversi dan level capaian akan muncul secara real-time
                            </div>
                            <div class="guide-step">
                                <strong>4. Ekspor Data</strong> - Gunakan tombol Export Excel untuk mendapatkan laporan lengkap
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shortcut Keyboard -->
                    <div class="guide-section">
                        <div class="guide-title">
                            <i class="fas fa-keyboard"></i> Shortcut Keyboard
                        </div>
                        <div class="guide-content">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                                <div><span class="guide-hotkey">Enter / ↓</span> Pindah ke baris bawah</div>
                                <div><span class="guide-hotkey">↑</span> Pindah ke baris atas</div>
                                <div><span class="guide-hotkey">Ctrl+Z</span> Undo</div>
                                <div><span class="guide-hotkey">Ctrl+Y</span> Redo</div>
                                <div><span class="guide-hotkey">Ctrl+D</span> Duplikat nilai dari atas</div>
                                <div><span class="guide-hotkey">Ctrl+V</span> Paste data dari Excel</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Level Capaian Kurikulum Merdeka -->
                    <div class="guide-section">
                        <div class="guide-title">
                            <i class="fas fa-chart-bar"></i> Level Capaian (Kurikulum Merdeka)
                        </div>
                        <div class="guide-content">
                            <p>Setelah dikonversi, nilai akan dikategorikan sesuai standar Kurikulum Merdeka:</p>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span class="capaian-badge lv-SB">SB</span>
                                    <div><strong>Sangat Berkembang</strong> (86-100) - Melampaui Capaian Pembelajaran (CP)</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span class="capaian-badge lv-BSH">BSH</span>
                                    <div><strong>Berkembang Sesuai Harapan</strong> (76-85) - Sesuai dengan CP</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span class="capaian-badge lv-MB">MB</span>
                                    <div><strong>Mulai Berkembang</strong> (66-75) - Mencapai sebagian CP</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="capaian-badge lv-PB">PB</span>
                                    <div><strong>Perlu Bimbingan</strong> (≤65) - Belum mencapai CP</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="tool-btn primary" @click="showModal = false">
                        <i class="fas fa-check"></i> Mengerti
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast-container">
            <div class="toast" :class="{show: toast.visible, 'toast-warning': toast.type === 'warning'}">
                <i class="fas" :class="toast.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'"></i>
                {{ toast.message }}
            </div>
        </div>

        <button class="fab" @click="addNewRow" v-if="activeTab === 'data'">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const STORAGE_KEY = 'konversi_merdeka_data_v2';
                const PARAMS_KEY = 'konversi_merdeka_params_v2';
                const MAX_HISTORY = 50;

                // State
                const YA = ref(85);
                const YB = ref(70);
                const XA = ref(null);
                const XB = ref(null);
                const activeTab = ref('data');
                const dataRows = ref([]);
                const focusedIndex = ref(-1);
                const showModal = ref(false);
                
                // History
                const history = ref([]);
                const historyIndex = ref(-1);
                const isUndoRedo = ref(false);

                // UI
                const saveStatus = ref('saved'); 
                const toast = ref({ visible: false, message: '', type: 'info' });

                // --- LOGIC KURIKULUM MERDEKA ---
                const calculateLevel = (score) => {
                    const n = parseFloat(score);
                    if (isNaN(n)) return { code: '', desc: '' };
                    
                    if (n >= 86) return { code: 'SB', desc: 'Sangat Berkembang (Melampaui CP)' };
                    if (n >= 76) return { code: 'BSH', desc: 'Berkembang Sesuai Harapan (Sesuai CP)' };
                    if (n >= 66) return { code: 'MB', desc: 'Mulai Berkembang (Sebagian CP)' };
                    return { code: 'PB', desc: 'Perlu Bimbingan (Belum Mencapai CP)' };
                };

                const updateGlobalParams = () => {
                    const values = dataRows.value
                        .map(r => parseFloat(r.nilaiAsli))
                        .filter(v => !isNaN(v) && v >= 0 && v <= 100);
                    
                    if (values.length > 0) {
                        XA.value = Math.max(...values);
                        XB.value = Math.min(...values);
                    } else {
                        XA.value = null;
                        XB.value = null;
                    }
                };

                const calculate = (val) => {
                    if (val === '' || isNaN(val)) return '';
                    if (XA.value === null || XB.value === null || XA.value === XB.value) return val;
                    const nx = parseFloat(val);
                    const result = ((YA.value - YB.value) / (XA.value - XB.value)) * (nx - XB.value) + YB.value;
                    return Math.round(result);
                };

                const processRow = (row) => {
                    // 1. Calculate Conversion
                    const calc = calculate(row.nilaiAsli);
                    if (row.nilaiAsli !== '' && (calc === '' || isNaN(calc))) {
                        row.hasilKonversi = row.nilaiAsli;
                    } else {
                        row.hasilKonversi = calc;
                    }
                    
                    // 2. Determine Level (Capaian)
                    const level = calculateLevel(row.hasilKonversi);
                    row.levelCode = level.code;
                    row.levelDesc = level.desc;
                };

                const recalculateAll = () => {
                    dataRows.value.forEach(processRow);
                };

                // --- EXCEL EXPORT (UPDATED) ---
                const exportExcel = () => {
                    const validData = dataRows.value.filter(r => r.nilaiAsli !== '' && !isInvalid(r.nilaiAsli));
                    if (validData.length === 0) return showToast('Tabel masih kosong', 'warning');

                    const wsData = [
                        ['LAPORAN KONVERSI NILAI - KURIKULUM MERDEKA'],
                        ['Tanggal Export:', new Date().toLocaleDateString('id-ID')],
                        ['Parameter:', `YA=${YA.value}, YB=${YB.value}, XA=${XA.value || '-'}, XB=${XB.value || '-'}`],
                        [],
                        ['No', 'Nilai Asli', 'Hasil Konversi', 'Level', 'Deskripsi Capaian', 'Status Validasi']
                    ];
                    
                    validData.forEach((row, index) => {
                        wsData.push([
                            index + 1,
                            parseFloat(row.nilaiAsli) || row.nilaiAsli,
                            parseFloat(row.hasilKonversi) || row.hasilKonversi,
                            row.levelCode,
                            row.levelDesc,
                            isInvalid(row.nilaiAsli) ? 'INVALID' : 'VALID'
                        ]);
                    });
                    
                    // Add summary
                    wsData.push([]);
                    wsData.push(['STATISTIK:', '', '', '', '']);
                    wsData.push(['Jumlah Data:', validData.length]);
                    wsData.push(['Rata-rata Hasil:', (validData.reduce((sum, r) => sum + parseFloat(r.hasilKonversi), 0) / validData.length).toFixed(2)]);
                    wsData.push(['Distribusi Level:']);
                    
                    const levelCounts = {};
                    validData.forEach(r => {
                        levelCounts[r.levelCode] = (levelCounts[r.levelCode] || 0) + 1;
                    });
                    
                    Object.entries(levelCounts).forEach(([level, count]) => {
                        wsData.push([`  ${level}:`, count, `(${((count/validData.length)*100).toFixed(1)}%)`]);
                    });
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    
                    // Set column widths
                    const wscols = [
                        {wch: 6},  // No
                        {wch: 12}, // Nilai Asli
                        {wch: 15}, // Hasil Konversi
                        {wch: 10}, // Level
                        {wch: 35}, // Deskripsi
                        {wch: 12}  // Status
                    ];
                    ws['!cols'] = wscols;
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Nilai Merdeka");
                    XLSX.writeFile(wb, `Konversi_Nilai_Merdeka_${new Date().toISOString().slice(0,10)}.xlsx`);
                    showToast('Laporan Excel berhasil diunduh!');
                };

                // --- UNDO/REDO & HISTORY ---
                const saveStateToHistory = () => {
                    if (isUndoRedo.value) return;
                    if (historyIndex.value < history.value.length - 1) {
                        history.value = history.value.slice(0, historyIndex.value + 1);
                    }
                    const snapshot = JSON.parse(JSON.stringify(dataRows.value));
                    history.value.push(snapshot);
                    if (history.value.length > MAX_HISTORY) history.value.shift();
                    historyIndex.value = history.value.length - 1;
                };

                const undo = () => {
                    if (historyIndex.value > 0) {
                        isUndoRedo.value = true;
                        historyIndex.value--;
                        dataRows.value = JSON.parse(JSON.stringify(history.value[historyIndex.value]));
                        updateGlobalParams();
                        showToast('Undo berhasil');
                        nextTick(() => isUndoRedo.value = false);
                    }
                };

                const redo = () => {
                    if (historyIndex.value < history.value.length - 1) {
                        isUndoRedo.value = true;
                        historyIndex.value++;
                        dataRows.value = JSON.parse(JSON.stringify(history.value[historyIndex.value]));
                        updateGlobalParams();
                        showToast('Redo berhasil');
                        nextTick(() => isUndoRedo.value = false);
                    }
                };
                
                let typingTimer;
                const debouncedSaveHistory = () => {
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        saveStateToHistory();
                        saveData();
                    }, 500);
                };

                // --- EVENTS ---
                const handleInput = (row) => {
                    updateGlobalParams();
                    recalculateAll();
                    saveStatus.value = 'saving';
                    debouncedSaveHistory();
                    setTimeout(() => saveStatus.value = 'saved', 800);
                };

                const handleParamChange = () => {
                    // Validasi YA > YB
                    if (parseFloat(YA.value) <= parseFloat(YB.value)) {
                        showToast('YA harus lebih besar dari YB', 'warning');
                        YA.value = parseFloat(YB.value) + 1;
                    }
                    recalculateAll();
                    localStorage.setItem(PARAMS_KEY, JSON.stringify({ YA: YA.value, YB: YB.value }));
                };

                const handleKeydown = (e, index, row) => {
                    if (e.key === 'ArrowDown' || e.key === 'Enter') {
                        e.preventDefault();
                        const nextIdx = index + 1;
                        if (nextIdx < dataRows.value.length) {
                            document.getElementById(`cell-${nextIdx}`).focus();
                        } else {
                            addNewRow();
                            nextTick(() => document.getElementById(`cell-${nextIdx}`).focus());
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (index > 0) document.getElementById(`cell-${index - 1}`).focus();
                    } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'd') {
                        e.preventDefault();
                        if (index > 0) {
                            const prevVal = dataRows.value[index - 1].nilaiAsli;
                            if (prevVal !== '') {
                                row.nilaiAsli = prevVal;
                                handleInput(row);
                                showToast('Nilai diduplikasi dari baris atas');
                            }
                        }
                    } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'h') {
                        e.preventDefault();
                        showModal.value = true;
                    }
                };

                const addNewRow = () => {
                    dataRows.value.push({ id: Date.now(), nilaiAsli: '', hasilKonversi: '', levelCode: '', levelDesc: '' });
                    saveStateToHistory();
                    showToast('Baris baru ditambahkan');
                };

                const handlePaste = (event, startIndex) => {
                    event.preventDefault();
                    const clipboardData = (event.clipboardData || window.clipboardData).getData('text');
                    if (!clipboardData) return;

                    const rows = clipboardData.split(/\r\n|\n|\r/);
                    let currentRowIndex = startIndex;
                    let dataChanged = false;

                    rows.forEach(rowStr => {
                        if (rowStr.trim() === '') return;
                        const val = rowStr.split('\t')[0].trim().replace(',', '.'); 
                        if (currentRowIndex >= dataRows.value.length) {
                            dataRows.value.push({ id: Date.now() + Math.random(), nilaiAsli: '', hasilKonversi: '', levelCode: '', levelDesc: '' });
                        }
                        dataRows.value[currentRowIndex].nilaiAsli = val;
                        dataChanged = true;
                        currentRowIndex++;
                    });

                    if (dataChanged) {
                        updateGlobalParams();
                        recalculateAll();
                        saveStateToHistory();
                        saveData();
                        showToast(`${rows.length} data berhasil ditempel!`);
                    }
                };

                // --- HELPERS ---
                const isInvalid = (val) => {
                    if (val === '') return false;
                    const n = parseFloat(val);
                    return isNaN(n) || n < 0 || n > 100;
                };

                const showToast = (msg, type = 'info') => {
                    toast.value = { visible: true, message: msg, type };
                    setTimeout(() => toast.value.visible = false, 2000);
                };

                const showFormulaGuide = () => {
                    showModal.value = true;
                };

                const copyResults = () => {
                    const text = dataRows.value
                        .filter(r => r.hasilKonversi !== '' && !isInvalid(r.nilaiAsli))
                        .map(r => r.hasilKonversi)
                        .join('\n');
                    if (!text) return showToast('Tidak ada data valid untuk disalin!', 'warning');
                    navigator.clipboard.writeText(text).then(() => showToast('Hasil konversi disalin ke clipboard'));
                };

                const saveData = () => {
                    const cleanData = dataRows.value.map(r => ({ id: r.id, val: r.nilaiAsli }));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanData));
                };

                const loadData = () => {
                    const savedParams = localStorage.getItem(PARAMS_KEY);
                    if (savedParams) {
                        const p = JSON.parse(savedParams);
                        YA.value = p.YA; 
                        YB.value = p.YB;
                    }
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        dataRows.value = parsed.map(p => ({
                            id: p.id || Date.now() + Math.random(),
                            nilaiAsli: p.val,
                            hasilKonversi: '', levelCode: '', levelDesc: ''
                        }));
                    } else {
                        dataRows.value = Array.from({ length: 15 }, (_, i) => ({
                            id: Date.now() + i, 
                            nilaiAsli: '', 
                            hasilKonversi: '', 
                            levelCode: '', 
                            levelDesc: ''
                        }));
                    }
                    saveStateToHistory();
                    updateGlobalParams();
                    recalculateAll();
                };

                const resetAll = () => {
                    if (confirm("Apakah Anda yakin ingin mereset semua data? Data yang tersimpan akan dihapus.")) {
                        localStorage.removeItem(STORAGE_KEY);
                        localStorage.removeItem(PARAMS_KEY);
                        location.reload();
                    }
                };

                onMounted(() => {
                    loadData();
                    window.addEventListener('keydown', (e) => {
                        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
                        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
                        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'h') { e.preventDefault(); showModal.value = true; }
                    });
                });

                return {
                    YA, YB, XA, XB, activeTab, dataRows, toast, saveStatus, historyIndex, history,
                    showModal,
                    convertedCount: computed(() => dataRows.value.filter(r => r.hasilKonversi !== '' && !isInvalid(r.nilaiAsli)).length),
                    handleInput, handleParamChange, addNewRow, resetAll, showFormulaGuide,
                    handleKeydown, handlePaste, copyResults, exportExcel, undo, redo, isInvalid
                };
            }
        }).mount('#app');
    </script>
</body>
</html>