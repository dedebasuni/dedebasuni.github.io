<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f1119">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Web Radio Player - MiniAmp">
    <title>MiniAmp — Radio Streaming Player</title>
    <link rel="icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=128" type="image/png">
    <link rel="apple-touch-icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=192">
    
    <!-- Phosphor Icons (Modern Icon Set) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /**
         * MiniAmp Styles
         * Tema: Midnight Cyberpunk
         */

        :root {
            /* -- Palet Warna -- */
            --bg-dark: #050508;
            --bg-panel: #13141c;
            --bg-surface: #1c1e2a;
            
            --txt-primary: #ffffff;
            --txt-secondary: #949aa6;
            --txt-tertiary: #585d6b;
            
            --accent-primary: #8b5cf6; /* Violet */
            --accent-secondary: #3b82f6; /* Blue */
            --accent-glow: rgba(139, 92, 246, 0.4);
            
            --status-ok: #10b981;
            --status-warn: #f59e0b;
            --status-err: #ef4444;
            
            /* -- Dimensi -- */
            --radius-lg: 24px;
            --radius-md: 16px;
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* -- Reset & Base -- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            height: 100dvh;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            color: var(--txt-primary);
            font-family: var(--font-main);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* -- Container Utama -- */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(19, 20, 28, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .app-container {
                height: 90vh;
                max-height: 850px;
                border-radius: var(--radius-lg);
                border: 1px solid rgba(255,255,255,0.08);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        }

        /* -- Header & Visualizer -- */
        .deck {
            flex: 0 0 auto;
            padding: 20px 20px 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 10;
        }

        .deck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-weight: 800;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #fff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 99px;
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--txt-secondary);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--txt-tertiary);
            transition: 0.3s;
        }
        
        /* Animasi Status */
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.5; transform: scale(1); } }
        .connecting .status-dot { background: var(--status-warn); animation: pulse 1s infinite; }
        .playing .status-dot { background: var(--status-ok); box-shadow: 0 0 8px var(--status-ok); }
        .error .status-dot { background: var(--status-err); }

        .visualizer-wrapper {
            position: relative;
        }

        .visualizer-card {
            position: relative;
            height: 160px;
            background: linear-gradient(180deg, #1e202e, #101116);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.08);
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            transition: transform 0.2s;
        }
        
        /* Tombol ganti mode visualizer */
        .viz-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt-secondary);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }
        .viz-toggle:hover { color: white; background: rgba(255,255,255,0.1); }

        .sleep-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #d8b4fe;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.7rem;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 4px;
            backdrop-filter: blur(4px);
        }

        canvas#visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
            mix-blend-mode: screen;
        }

        .track-info {
            position: relative;
            z-index: 2;
            padding: 16px;
            background: linear-gradient(0deg, rgba(5,5,8,0.9) 0%, transparent 100%);
        }

        #nowTitle {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .track-meta {
            display: flex;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--txt-secondary);
        }

        /* -- Playlist Section -- */
        .playlist-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: rgba(0,0,0,0.2);
            margin: 0 10px;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .search-container {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 8px;
        }

        .search-box {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .search-box:focus { outline: none; border-color: var(--accent-primary); background: rgba(0,0,0,0.4); }
        .search-box::placeholder { color: var(--txt-tertiary); }

        .plist-body {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-surface) transparent;
        }
        
        ul#playlist { list-style: none; margin: 0; padding: 0; }

        #playlist li {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        #playlist li:hover { background: rgba(255,255,255,0.03); }
        
        #playlist li.active { 
            background: rgba(139, 92, 246, 0.1); 
        }
        #playlist li.active::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
            background: var(--accent-primary);
            box-shadow: 2px 0 8px var(--accent-primary);
        }
        
        #playlist li.active .title { color: var(--accent-primary); font-weight: 700; }
        #playlist li.active .num { color: var(--accent-primary); opacity: 1; }

        #playlist li .num {
            font-size: 0.8rem; color: var(--txt-tertiary);
            width: 28px; margin-right: 8px; text-align: center; font-variant-numeric: tabular-nums;
        }
        #playlist li .title {
            flex: 1; font-size: 0.95rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: var(--txt-secondary);
        }
        #playlist li .actions {
            display: flex; gap: 4px;
            opacity: 0.4; transition: 0.2s;
        }
        #playlist li:hover .actions { opacity: 1; }

        .mini-btn {
            background: transparent; border: none; color: var(--txt-tertiary);
            padding: 6px; cursor: pointer; border-radius: 6px; display: flex;
        }
        .mini-btn:hover { color: var(--txt-primary); background: rgba(255,255,255,0.1); }
        .mini-btn.danger:hover { color: var(--status-err); background: rgba(239, 68, 68, 0.1); }

        /* -- Controls Area -- */
        .controls-area {
            flex: 0 0 auto;
            background: rgba(19, 20, 28, 0.9);
            backdrop-filter: blur(15px);
            padding: 16px 20px 30px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 20;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        }

        .utility-bar { display: flex; justify-content: space-between; align-items: center; }

        .volume-group {
            display: flex; align-items: center; gap: 10px;
            flex: 1; max-width: 140px;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px; border-radius: 99px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .volume-slider {
            flex: 1; -webkit-appearance: none; height: 4px;
            background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            border-radius: 50%; background: #fff; cursor: pointer;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .tools-group { display: flex; gap: 8px; }
        .tool-btn {
            width: 38px; height: 38px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            color: var(--txt-secondary);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .tool-btn.active {
            background: var(--accent-primary); color: #fff;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .primary-controls {
            display: flex; justify-content: center; align-items: center; gap: 24px;
        }
        .c-btn {
            border: none; background: transparent; color: var(--txt-primary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .c-btn:active { transform: scale(0.9); }
        
        .c-btn.play {
            width: 68px; height: 68px; border-radius: 50%;
            background: linear-gradient(135deg, #fff, #e0e7ff);
            color: var(--bg-dark);
            box-shadow: 0 8px 25px rgba(255,255,255,0.2);
        }
        .c-btn.play i { font-size: 32px; margin-left: 2px; }
        .c-btn.play.playing i { margin-left: 0; }
        
        .c-btn.secondary {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255,255,255,0.05);
        }
        .c-btn.secondary i { font-size: 24px; color: var(--txt-secondary); }
        .c-btn.secondary:hover { background: rgba(255,255,255,0.1); }
        .c-btn.secondary:hover i { color: #fff; }

        /* -- Overlays -- */
        .menu-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        .menu-overlay.show { opacity: 1; pointer-events: auto; }

        .overlay-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #13141c;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; gap: 8px;
            max-height: 80%; overflow-y: auto;
            z-index: 100;
        }
        .menu-overlay.show .overlay-panel { transform: translateY(0); }

        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .menu-header h3 { margin: 0; font-size: 1.1rem; }

        .menu-btn {
            width: 100%; padding: 14px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: none;
            color: var(--txt-secondary); font-size: 0.95rem; text-align: left;
            display: flex; align-items: center; gap: 14px;
            cursor: pointer; transition: 0.2s;
            font-family: inherit;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.08); color: #fff; padding-left: 18px; }
        .menu-btn i { font-size: 1.2rem; color: var(--txt-tertiary); }
        .menu-btn:hover i { color: var(--accent-primary); }

        /* Toast Notification */
        .toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background: rgba(28, 30, 42, 0.95); 
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 24px; border-radius: 99px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 200; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.ok i { color: var(--status-ok); }
        .toast.err i { color: var(--status-err); }

        /* -- Info Panel -- */
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt-secondary);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            display: none;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(4px);
        }
        
        .info-panel.show {
            display: flex;
        }
        
        .info-panel i {
            font-size: 0.9rem;
        }
        
        /* -- Stats Panel -- */
        .stats-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 5;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt-secondary);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.7rem;
            display: none;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        
        .stats-panel.show {
            display: flex;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* -- Progress Bar -- */
        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.05);
            z-index: 10;
            display: none;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }
        
        /* -- Tooltips -- */
        .tooltip {
            position: absolute;
            background: rgba(28, 30, 42, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 200px;
            text-align: center;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* -- Help Overlay -- */
        .help-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 8, 0.9);
            z-index: 150;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .help-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .help-content {
            background: var(--bg-panel);
            border-radius: var(--radius-md);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .help-section {
            margin-bottom: 20px;
        }
        
        .help-section h4 {
            margin: 0 0 10px 0;
            color: var(--accent-primary);
            font-size: 1rem;
        }
        
        .help-section p {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: var(--txt-secondary);
        }
        
        .help-section ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .help-section li {
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--txt-secondary);
        }
        
        .key-shortcut {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 4px;
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- 1. Top Section: Deck & Visualizer -->
        <div class="deck">
            <div class="deck-header">
                <div class="brand">
                    <i class="ph-fill ph-radio"></i> MiniAmp <span style="font-size:0.7em; opacity:0.5; font-weight:400;">v3</span>
                </div>
                <div class="status-badge">
                    <div id="statusDot" class="status-dot"></div>
                    <span id="statusText">Siap</span>
                </div>
            </div>

            <div class="visualizer-wrapper">
                <div class="visualizer-card">
                    <div id="vizToggle" class="viz-toggle" title="Ganti Visualizer">
                        <i class="ph ph-chart-bar"></i>
                    </div>
                    <div id="sleepIndicator" class="sleep-indicator">
                        <i class="ph-fill ph-moon"></i> <span id="sleepTimerDisplay">00:00</span>
                    </div>
                    
                    <!-- Info Panel -->
                    <div id="infoPanel" class="info-panel">
                        <i class="ph ph-info"></i> <span id="infoText">Info</span>
                    </div>
                    
                    <!-- Stats Panel -->
                    <div id="statsPanel" class="stats-panel">
                        <div class="stat-item">
                            <i class="ph ph-clock"></i> <span id="uptimeDisplay">00:00</span>
                        </div>
                        <div class="stat-item">
                            <i class="ph ph-trend-up"></i> <span id="bitrateDisplay">-</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="progressContainer" class="progress-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    
                    <canvas id="visualizer"></canvas>
                    <div class="track-info">
                        <div id="nowTitle">Pilih Stasiun Radio</div>
                        <div class="track-meta">
                            <span id="techInfo">44.1kHz • Stereo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Middle Section: Playlist -->
        <div class="playlist-container" id="dropZone">
            <div class="search-container">
                <input type="text" id="searchBox" class="search-box" placeholder="Cari stasiun radio...">
            </div>
            <div class="plist-body">
                <ul id="playlist">
                    <!-- Playlist injected via JS -->
                </ul>
                
                <!-- Empty State / Drop Hint -->
                <div id="emptyHint" style="display:none; padding: 30px; text-align: center; color: var(--txt-tertiary); font-size: 0.9rem;">
                    <i class="ph ph-radio" style="font-size: 32px; margin-bottom: 10px; opacity:0.5;"></i><br>
                    Tidak ada stasiun.<br>Tarik file .m3u atau Reset.
                </div>
            </div>
        </div>

        <!-- 3. Bottom Section: Controls -->
        <div class="controls-area">
            <!-- Sliders & Toggles -->
            <div class="utility-bar">
                <div class="volume-group">
                    <i class="ph ph-speaker-high" id="muteIcon"></i>
                    <input type="range" id="volSlider" class="volume-slider" min="0" max="100" value="90">
                </div>
                
                <div class="tools-group">
                    <button id="shuffleBtn" class="tool-btn" title="Acak"><i class="ph ph-shuffle"></i></button>
                    <button id="normBtn" class="tool-btn active" title="Auto Gain (Normalizer)"><i class="ph ph-faders"></i></button>
                    <button id="helpBtn" class="tool-btn" title="Bantuan"><i class="ph ph-question"></i></button>
                    <button id="menuToggleBtn" class="tool-btn" title="Menu"><i class="ph ph-list"></i></button>
                </div>
            </div>

            <!-- Playback Controls -->
            <div class="primary-controls">
                <button id="prevBtn" class="c-btn secondary"><i class="ph-fill ph-skip-back"></i></button>
                <button id="playBtn" class="c-btn play"><i class="ph-fill ph-play"></i></button>
                <button id="nextBtn" class="c-btn secondary"><i class="ph-fill ph-skip-forward"></i></button>
            </div>
        </div>

        <!-- 4. Overlay Menus -->
        <div id="menuOverlay" class="menu-overlay">
            <div class="overlay-panel">
                <div class="menu-header">
                    <h3>Menu</h3>
                    <button id="menuCloseBtn" class="mini-btn"><i class="ph ph-x" style="font-size: 24px;"></i></button>
                </div>
                
                <button id="sleepTimerBtn" class="menu-btn"><i class="ph ph-moon"></i> Sleep Timer: <span id="sleepStatusText" style="margin-left:auto; font-size:0.8em; opacity:0.7;">Off</span></button>
                <button id="addStreamBtn" class="menu-btn"><i class="ph ph-link"></i> Tambah Link Stream</button>
                <button id="loadFileBtn" class="menu-btn"><i class="ph ph-folder-open"></i> Buka File Playlist</button>
                <button id="pasteBtn" class="menu-btn"><i class="ph ph-clipboard-text"></i> Paste dari Clipboard</button>
                <button id="exportBtn" class="menu-btn"><i class="ph ph-export"></i> Export Playlist</button>
                <button id="resetBtn" class="menu-btn" style="color: var(--accent-secondary);"><i class="ph ph-arrows-clockwise"></i> Reset ke Default (Indo)</button>
                <button id="clearBtn" class="menu-btn" style="color: var(--status-err);"><i class="ph ph-trash"></i> Hapus Semua</button>
            </div>
        </div>
        
        <!-- 5. Help Overlay -->
        <div id="helpOverlay" class="help-overlay">
            <div class="help-content">
                <div class="help-header">
                    <h3>Bantuan MiniAmp</h3>
                    <button id="helpCloseBtn" class="mini-btn"><i class="ph ph-x" style="font-size: 24px;"></i></button>
                </div>
                
                <div class="help-section">
                    <h4>Kontrol Pemutaran</h4>
                    <p>Gunakan tombol di bagian bawah untuk mengontrol pemutaran:</p>
                    <ul>
                        <li><span class="key-shortcut">⏮️</span> Sebelumnya</li>
                        <li><span class="key-shortcut">▶️/⏸️</span> Putar/Jeda</li>
                        <li><span class="key-shortcut">⏭️</span> Selanjutnya</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>Fitur Utama</h4>
                    <ul>
                        <li><strong>Auto Gain Control:</strong> Menormalkan volume semua stasiun</li>
                        <li><strong>Shuffle:</strong> Memutar stasiun secara acak</li>
                        <li><strong>Sleep Timer:</strong> Matikan pemutaran otomatis setelah waktu tertentu</li>
                        <li><strong>Visualizer:</strong> Tampilan visual audio dengan dua mode</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>Shortcut Keyboard</h4>
                    <ul>
                        <li><span class="key-shortcut">Spasi</span> Putar/Jeda</li>
                        <li><span class="key-shortcut">→</span> Stasiun berikutnya</li>
                        <li><span class="key-shortcut">←</span> Stasiun sebelumnya</li>
                        <li><span class="key-shortcut">↑</span> Volume naik</li>
                        <li><span class="key-shortcut">↓</span> Volume turun</li>
                        <li><span class="key-shortcut">M</span> Mute/Unmute</li>
                        <li><span class="key-shortcut">S</span> Shuffle On/Off</li>
                        <li><span class="key-shortcut">N</span> Normalizer On/Off</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>Manajemen Playlist</h4>
                    <ul>
                        <li><strong>Tambah Stasiun:</strong> Gunakan menu untuk menambah stasiun baru</li>
                        <li><strong>Import:</strong> Drag & drop file M3U atau gunakan menu Buka File</li>
                        <li><strong>Export:</strong> Simpan playlist Anda ke file M3U</li>
                        <li><strong>Reset:</strong> Kembali ke playlist default</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="toast" class="toast"><i class="ph-fill ph-info"></i> <span>Notification</span></div>
        
        <!-- Tooltip Element -->
        <div id="tooltip" class="tooltip"></div>
    </div>

    <!-- Hidden Input/Audio -->
    <input id="fileInput" type="file" accept=".m3u,.m3u8,.txt" hidden>
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        (function() {
            "use strict";
            
            // --- Default Stations (Indonesia Popular) ---
            const defaultStations = [
                { title: "Ardan Radio 105.9 FM", url: "https://stream.rcs.revma.com/ugpyzu9n5k3vv" },
                { title: "Dahlia 101.5 FM", url: "https://svara-stream.radioddns.net/bandung_dahliafm" },
                { title: "Urban Radio Bandung", url: "https://a1.siar.us/listen/urbanradio/stream" },
                { title: "Hard Rock FM Bandung", url: "http://stream.radiojar.com/fnex9bkswk8uv" },
                { title: "Hits Unikom Radio 103.9 FM", url: "https://streaming.hitsunikomradio.com/" },
                { title: "B Radio 95.6 FM (Bandung)", url: "https://stream.rcs.revma.com/9yp8b9pd6k3vv" },
                { title: "KLCBS Bandung", url: "https://streaming.klcbsofficial.com/listen/klcbs/klcbs" },
                { title: "iRadio Bandung", url: "https://stream.radiojar.com/u6ppe6hswk8uv" },
                { title: "PRFM 107.5 News Channel (Bandung)", url: "https://radio.idh.am/prfm" },
                { title: "Maya FM Bandung", url: "https://svara-stream.radioddns.net/bandung_mayafm_mono" },
                { title: "K-Lite FM Bandung", url: "https://svara-stream.radioddns.net/bandung_klitefm_acc" },
                { title: "Mara FM Bandung", url: "https://svara-stream.radioddns.net/bandung_marafm" },
                { title: "Radio Suara Indah 92.1 FM (Bandung)", url: "https://suaraindahfm.com:8443/live" },
                { title: "Maestro FM Bandung", url: "http://maestro.skyline.net.id:10925/radio.maestro" },
                { title: "102.7 MQFM Bandung", url: "https://mqfmstreaming.kamil.web.id/;" },
                { title: "96.5 Persib Radio", url: "https://s3.vinhostmedia.com:10945/;stream" },
                { title: "Raka FM Bandung", url: "https://cast2.my-control-panel.com/proxy/radioso5/stream" },

                { title: "Brava Radio", url: "https://stream.radiojar.com/5k7t0rq3bnzuv.mp3" },
                { title: "Cosmopolitan Radio", url: "https://stream.radiojar.com/u7d8heq3bnzuv.mp3" },
                { title: "Delta FM 99.1 (Jakarta)", url: "https://s1.cloudmu.id/listen/delta_fm/stream" },
                { title: "Elshinta Jakarta", url: "https://stream-ssl.arenastreaming.com:8000/jakarta" },
                { title: "Female Radio 97.9 FM Jakarta", url: "https://s1.cloudmu.id/listen/female_radio/stream" },
                { title: "Global Radio Jakarta", url: "http://202.147.199.98/;stream.mp3" },
                { title: "Hard Rock FM Jakarta", url: "https://stream-ssl.arenastreaming.com:8004/hardrock" },
                { title: "I-Radio Jakarta", url: "https://n10.radiojar.com/4ywdgup3bnzuv" },
                { title: "RDI Jakarta", url: "http://202.147.199.99:8000/;" },
                { title: "V Radio Jakarta", url: "http://202.147.199.100:8000/;" },
                { title: "Heartline Karawaci", url: "https://svara-stream.radioddns.net/karawaci_heartline_stereo" },
                { title: "OZ Radio Jakarta 90.8 FM", url: "https://streaming.ozradiojakarta.com:8443/ozjakarta" },
                { title: "Smooth 99.5 Jakarta", url: "https://svara-stream.radioddns.net/jakarta_smoothfm_mp3" },
                { title: "Suara Dangdut RRI Jakarta", url: "https://stream-node2.rri.co.id/streaming/40/9340/dangdut.mp3" },
                { title: "Trax FM Palembang (Jakarta Network)", url: "https://stream.radiojar.com/qv4muvhswk8uv" },
                { title: "TRAX FM Semarang (Jakarta Network)", url: "https://stream.radiojar.com/fr9zqhv80k8uv" },
                { title: "PAS FM Jakarta", url: "https://i.klikhost.com/8266/stream" },
                { title: "POP FM Jakarta", url: "https://i.klikhost.com/8272/stream" },
                { title: "Radio Samhan Jakarta", url: "https://a8.siar.us/listen/samhanjakarta/radio.mp3" },
                { title: "Z 99.9 Jakarta", url: "https://svara-stream.radioddns.net/jakarta_z999fm_aac" },
                { title: "Kanal BC Jakarta", url: "https://stream01-ssl.arenastreaming.com:8057/live" }
            ];

            // --- Config & State ---
            const config = {
                fadeIn: 0.8,
                fadeOut: 0.5,
                targetDb: -16,
                limiter: -3
            };
            
            // Elements
            const el = {
                audio: document.getElementById('audio'),
                playBtn: document.getElementById('playBtn'),
                prevBtn: document.getElementById('prevBtn'),
                nextBtn: document.getElementById('nextBtn'),
                shuffleBtn: document.getElementById('shuffleBtn'),
                normBtn: document.getElementById('normBtn'),
                volSlider: document.getElementById('volSlider'),
                muteIcon: document.getElementById('muteIcon'),
                searchBox: document.getElementById('searchBox'),
                
                nowTitle: document.getElementById('nowTitle'),
                statusDot: document.getElementById('statusDot'),
                statusText: document.getElementById('statusText'),
                playlist: document.getElementById('playlist'),
                dropZone: document.getElementById('dropZone'),
                emptyHint: document.getElementById('emptyHint'),
                visualizer: document.getElementById('visualizer'),
                vizToggle: document.getElementById('vizToggle'),
                
                // Info & Stats
                infoPanel: document.getElementById('infoPanel'),
                infoText: document.getElementById('infoText'),
                statsPanel: document.getElementById('statsPanel'),
                uptimeDisplay: document.getElementById('uptimeDisplay'),
                bitrateDisplay: document.getElementById('bitrateDisplay'),
                progressContainer: document.getElementById('progressContainer'),
                progressBar: document.getElementById('progressBar'),
                
                // Menu
                menuOverlay: document.getElementById('menuOverlay'),
                menuToggleBtn: document.getElementById('menuToggleBtn'),
                menuCloseBtn: document.getElementById('menuCloseBtn'),
                
                // Help
                helpOverlay: document.getElementById('helpOverlay'),
                helpBtn: document.getElementById('helpBtn'),
                helpCloseBtn: document.getElementById('helpCloseBtn'),
                
                // Actions
                sleepTimerBtn: document.getElementById('sleepTimerBtn'),
                sleepIndicator: document.getElementById('sleepIndicator'),
                sleepTimerDisplay: document.getElementById('sleepTimerDisplay'),
                sleepStatusText: document.getElementById('sleepStatusText'),
                
                addStreamBtn: document.getElementById('addStreamBtn'),
                loadFileBtn: document.getElementById('loadFileBtn'),
                fileInput: document.getElementById('fileInput'),
                pasteBtn: document.getElementById('pasteBtn'),
                exportBtn: document.getElementById('exportBtn'),
                resetBtn: document.getElementById('resetBtn'),
                clearBtn: document.getElementById('clearBtn'),
                toast: document.getElementById('toast'),
                tooltip: document.getElementById('tooltip')
            };

            // State
            let state = {
                playlist: [],
                filteredPlaylist: [], // For search
                index: -1,
                volume: 0.9,
                shuffled: false,
                normalized: true,
                muted: false,
                vizMode: 0, // 0: Bars, 1: Wave
                sleepTimeLeft: 0, // Seconds
                filterText: "",
                startTime: Date.now(),
                bitrate: 0,
                buffering: false
            };

            // Audio Globals
            let audioCtx, sourceNode, gainNode, analyserNode, compressorNode, volumeNode, fadeNode;
            let retryTimeout = null;
            let sleepInterval = null;
            let isAudioInit = false;
            let uptimeInterval = null;
            let tooltipTimeout = null;

            // --- Initialization ---
            function init() {
                loadStorage();
                
                // Load default if empty
                if (state.playlist.length === 0) {
                    state.playlist = [...defaultStations];
                    saveStorage();
                }
                
                setupEventListeners();
                setupVisualizer();
                applyFilter(); // Render playlist
                
                // Set initial UI
                el.volSlider.value = state.volume * 100;
                updateVolumeUI();
                el.shuffleBtn.classList.toggle("active", state.shuffled);
                el.normBtn.classList.toggle("active", state.normalized);
                
                // Start uptime counter
                startUptimeCounter();
            }

            // --- Audio Engine ---
            function initAudio() {
                if (isAudioInit) return;
                
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContext();
                    
                    sourceNode = audioCtx.createMediaElementSource(el.audio);
                    gainNode = audioCtx.createGain(); // AGC
                    analyserNode = audioCtx.createAnalyser();
                    compressorNode = audioCtx.createDynamicsCompressor();
                    fadeNode = audioCtx.createGain(); 
                    volumeNode = audioCtx.createGain(); 

                    // Signal Chain: Source -> Gain(AGC) -> Analyser -> Compressor -> Fade -> Volume -> Out
                    sourceNode.connect(gainNode);
                    gainNode.connect(analyserNode);
                    analyserNode.connect(compressorNode);
                    compressorNode.connect(fadeNode);
                    fadeNode.connect(volumeNode);
                    volumeNode.connect(audioCtx.destination);

                    // Defaults
                    analyserNode.fftSize = 1024;
                    analyserNode.smoothingTimeConstant = 0.85;
                    
                    // Limiter/Compressor Settings
                    compressorNode.threshold.value = config.limiter;
                    compressorNode.knee.value = 30;
                    compressorNode.ratio.value = 12;
                    compressorNode.attack.value = 0.003;
                    compressorNode.release.value = 0.25;

                    gainNode.gain.value = 1;
                    fadeNode.gain.value = 1;
                    volumeNode.gain.value = state.volume;

                    isAudioInit = true;
                    startAgcLoop();
                    startVisualizerLoop();
                } catch(e) {
                    console.error("Audio Init Failed:", e);
                }
            }

            // --- Playback Logic ---
            async function playStation(realIndex) {
                if (!state.playlist[realIndex]) return;
                
                initAudio();
                if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();

                stopRetry();
                
                // Update State
                state.index = realIndex;
                const station = state.playlist[realIndex];
                
                el.nowTitle.textContent = station.title;
                setStatus("Menghubungkan...", "warn");
                highlightPlaylist();
                
                // Show info panel
                showInfoPanel(`Memuat: ${station.title}`);
                showProgressBar(true);

                // Crossfade Out
                if (audioCtx) {
                    const now = audioCtx.currentTime;
                    fadeNode.gain.cancelScheduledValues(now);
                    fadeNode.gain.setValueAtTime(fadeNode.gain.value, now);
                    fadeNode.gain.linearRampToValueAtTime(0, now + 0.2);
                }

                setTimeout(async () => {
                    try {
                        el.audio.src = station.url;
                        el.audio.load();
                        
                        await el.audio.play();
                        
                        // Crossfade In
                        if (audioCtx) {
                            const later = audioCtx.currentTime;
                            fadeNode.gain.cancelScheduledValues(later);
                            fadeNode.gain.setValueAtTime(0, later);
                            fadeNode.gain.linearRampToValueAtTime(1, later + config.fadeIn);
                        }
                        
                        setStatus("Streaming", "playing");
                        updatePlayBtn(true);
                        hideInfoPanel();
                        showStatsPanel(true);
                        
                    } catch (e) {
                        console.error("Play error:", e);
                        setStatus("Error Stream", "err");
                        hideInfoPanel();
                        showProgressBar(false);
                        // Auto retry logic
                        startRetry();
                    }
                }, 250);
            }

            function togglePlay() {
                if (!state.playlist.length) return showToast("Playlist kosong!", "err");
                
                initAudio();
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

                if (el.audio.paused) {
                    if (state.index === -1) state.index = 0;
                    playStation(state.index);
                } else {
                    el.audio.pause();
                    setStatus("Jeda", "warn");
                    updatePlayBtn(false);
                }
            }

            function playNext() {
                if (!state.playlist.length) return;
                let next;
                if (state.shuffled) {
                    next = Math.floor(Math.random() * state.playlist.length);
                } else {
                    next = state.index + 1;
                    if (next >= state.playlist.length) next = 0;
                }
                playStation(next);
            }

            function playPrev() {
                if (!state.playlist.length) return;
                let prev = state.index - 1;
                if (prev < 0) prev = state.playlist.length - 1;
                playStation(prev);
            }

            function startRetry() {
                clearTimeout(retryTimeout);
                retryTimeout = setTimeout(() => {
                    if (!el.audio.paused) return; // Already playing
                    setStatus("Mencoba lagi...", "warn");
                    playStation(state.index);
                }, 3000);
            }

            function stopRetry() {
                clearTimeout(retryTimeout);
            }

            // --- Sleep Timer ---
            function toggleSleepTimer() {
                const options = [0, 15, 30, 60]; // minutes
                const currentMin = state.sleepTimeLeft / 60;
                
                // Find next option
                let nextIdx = options.findIndex(m => m > currentMin);
                if (nextIdx === -1) nextIdx = 0; // Reset to 0 if max reached
                
                const minutes = options[nextIdx];
                state.sleepTimeLeft = minutes * 60;
                
                clearInterval(sleepInterval);
                
                if (state.sleepTimeLeft > 0) {
                    el.sleepIndicator.style.display = "flex";
                    el.sleepStatusText.textContent = `${minutes} min`;
                    showToast(`Sleep timer: ${minutes} menit`, "ok");
                    
                    sleepInterval = setInterval(() => {
                        state.sleepTimeLeft--;
                        if (state.sleepTimeLeft <= 0) {
                            clearInterval(sleepInterval);
                            el.audio.pause();
                            updatePlayBtn(false);
                            setStatus("Tidur", "warn");
                            el.sleepIndicator.style.display = "none";
                            el.sleepStatusText.textContent = "Off";
                            state.sleepTimeLeft = 0;
                        }
                        updateSleepDisplay();
                    }, 1000);
                } else {
                    el.sleepIndicator.style.display = "none";
                    el.sleepStatusText.textContent = "Off";
                    showToast("Sleep timer mati");
                }
                updateSleepDisplay();
            }

            function updateSleepDisplay() {
                const m = Math.floor(state.sleepTimeLeft / 60);
                const s = state.sleepTimeLeft % 60;
                el.sleepTimerDisplay.textContent = `${m}:${s.toString().padStart(2,'0')}`;
            }

            // --- Volume & AGC ---
            function setVolume(val) {
                state.volume = val;
                state.muted = false;
                if (volumeNode) {
                    volumeNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
                }
                updateVolumeUI();
                saveStorage();
            }

            function toggleMute() {
                state.muted = !state.muted;
                if (volumeNode) {
                    volumeNode.gain.setTargetAtTime(state.muted ? 0 : state.volume, audioCtx.currentTime, 0.1);
                }
                updateVolumeUI();
            }

            function updateVolumeUI() {
                const val = state.muted ? 0 : state.volume * 100;
                el.volSlider.value = val;
                
                if (state.muted || val === 0) el.muteIcon.className = "ph ph-speaker-x";
                else if (val < 50) el.muteIcon.className = "ph ph-speaker-low";
                else el.muteIcon.className = "ph ph-speaker-high";
            }

            function startAgcLoop() {
                const dataArray = new Float32Array(analyserNode.fftSize);
                function loop() {
                    if (!state.normalized || el.audio.paused) {
                        requestAnimationFrame(loop);
                        return;
                    }
                    
                    analyserNode.getFloatTimeDomainData(dataArray);
                    let sum = 0;
                    // RMS calculation
                    for(let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
                    let rms = Math.sqrt(sum / dataArray.length);
                    let db = 20 * Math.log10(rms || 0.0001);

                    // Makeup Gain logic
                    let targetGain = 1;
                    if (db < config.targetDb) {
                        targetGain = Math.pow(10, (config.targetDb - db) / 20);
                        targetGain = Math.min(targetGain, 3.5); // Max boost limit
                    }
                    
                    gainNode.gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.3);
                    requestAnimationFrame(loop);
                }
                loop();
            }

            // --- Visualizer ---
            function setupVisualizer() {
                const canvas = el.visualizer;
                function resize() {
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width * 1.5; // HiDPI ish
                    canvas.height = rect.height * 1.5;
                }
                window.addEventListener('resize', resize);
                resize();
            }

            function startVisualizerLoop() {
                const canvas = el.visualizer;
                const ctx = canvas.getContext('2d');
                const bufferLength = analyserNode.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const timeArray = new Uint8Array(bufferLength);

                function draw() {
                    requestAnimationFrame(draw);
                    if (el.audio.paused) {
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        return;
                    }

                    const w = canvas.width;
                    const h = canvas.height;
                    ctx.clearRect(0, 0, w, h);

                    if (state.vizMode === 0) {
                        // MODE 0: Frequency Bars
                        analyserNode.getByteFrequencyData(dataArray);
                        const bars = 40;
                        const barW = w / bars;
                        // Use lower frequency range usually more active
                        const step = Math.floor((bufferLength * 0.6) / bars); 

                        for(let i=0; i<bars; i++) {
                            const val = dataArray[i*step];
                            const percent = val / 255;
                            const barH = percent * h * 0.9;
                            
                            const x = i * barW;
                            const y = h - barH;

                            // Gradient
                            const hue = 250 + (i * 2); // Purple/Blue range
                            ctx.fillStyle = `hsla(${hue}, 80%, 65%, 0.8)`;
                            
                            // Rounded top rect
                            ctx.beginPath();
                            ctx.roundRect(x + 2, y, barW - 4, barH, [4,4,0,0]);
                            ctx.fill();
                        }
                    } else {
                        // MODE 1: Oscilloscope (Wave)
                        analyserNode.getByteTimeDomainData(timeArray);
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = '#8b5cf6'; // Violet accent
                        ctx.beginPath();

                        const sliceWidth = w * 1.0 / bufferLength;
                        let x = 0;

                        for(let i = 0; i < bufferLength; i++) {
                            const v = timeArray[i] / 128.0;
                            const y = v * h / 2;

                            if(i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);

                            x += sliceWidth;
                        }
                        ctx.stroke();
                    }
                }
                draw();
            }

            // --- Info & Stats Panels ---
            function showInfoPanel(text) {
                el.infoText.textContent = text;
                el.infoPanel.classList.add('show');
            }
            
            function hideInfoPanel() {
                el.infoPanel.classList.remove('show');
            }
            
            function showStatsPanel(show) {
                if (show) {
                    el.statsPanel.classList.add('show');
                } else {
                    el.statsPanel.classList.remove('show');
                }
            }
            
            function showProgressBar(show) {
                if (show) {
                    el.progressContainer.classList.add('show');
                    el.progressBar.style.width = '0%';
                    
                    // Simulate progress
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 10;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(interval);
                            setTimeout(() => {
                                el.progressContainer.classList.remove('show');
                            }, 500);
                        }
                        el.progressBar.style.width = `${progress}%`;
                    }, 200);
                } else {
                    el.progressContainer.classList.remove('show');
                }
            }
            
            function startUptimeCounter() {
                uptimeInterval = setInterval(() => {
                    const uptime = Math.floor((Date.now() - state.startTime) / 1000);
                    const minutes = Math.floor(uptime / 60);
                    const seconds = uptime % 60;
                    el.uptimeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
            
            function updateBitrate(bitrate) {
                if (bitrate > 0) {
                    el.bitrateDisplay.textContent = `${Math.round(bitrate / 1000)} kbps`;
                } else {
                    el.bitrateDisplay.textContent = '-';
                }
            }

            // --- List & Filter Logic ---
            function applyFilter() {
                const text = el.searchBox.value.toLowerCase().trim();
                if (!text) {
                    state.filteredPlaylist = state.playlist.map((item, index) => ({...item, originalIndex: index}));
                } else {
                    state.filteredPlaylist = state.playlist
                        .map((item, index) => ({...item, originalIndex: index}))
                        .filter(item => item.title.toLowerCase().includes(text));
                }
                renderPlaylist();
            }

            function renderPlaylist() {
                el.playlist.innerHTML = "";
                
                if (state.filteredPlaylist.length === 0) {
                    el.emptyHint.style.display = "block";
                } else {
                    el.emptyHint.style.display = "none";
                }

                state.filteredPlaylist.forEach((item) => {
                    const li = document.createElement("li");
                    const isPlaying = (item.originalIndex === state.index);
                    if (isPlaying) li.classList.add("active");
                    
                    li.innerHTML = `
                        <span class="num">${isPlaying ? '<i class="ph-fill ph-speaker-high"></i>' : item.originalIndex + 1}</span>
                        <span class="title">${item.title}</span>
                        <div class="actions">
                            <button class="mini-btn delete-btn" title="Hapus"><i class="ph ph-x"></i></button>
                        </div>
                    `;
                    
                    // Play click
                    li.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-btn')) {
                            playStation(item.originalIndex);
                        }
                    });

                    // Delete click
                    li.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeStation(item.originalIndex);
                    });
                    
                    el.playlist.appendChild(li);
                });
                
                highlightPlaylist();
            }

            function removeStation(originalIndex) {
                if (confirm("Hapus stasiun ini?")) {
                    state.playlist.splice(originalIndex, 1);
                    
                    if (state.index === originalIndex) {
                        el.audio.pause();
                        el.audio.src = "";
                        setStatus("Berhenti");
                        state.index = -1;
                        updatePlayBtn(false);
                    } else if (state.index > originalIndex) {
                        state.index--;
                    }
                    
                    saveStorage();
                    applyFilter(); // Re-render
                }
            }

            function highlightPlaylist() {
                // Scroll to active item
                const activeEl = el.playlist.querySelector('.active');
                if (activeEl) {
                    activeEl.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }

            // --- Export Playlist ---
            function exportPlaylist() {
                if (state.playlist.length === 0) {
                    showToast("Playlist kosong!", "err");
                    return;
                }
                
                let m3uContent = "#EXTM3U\n";
                
                state.playlist.forEach(station => {
                    m3uContent += `#EXTINF:-1,${station.title}\n`;
                    m3uContent += `${station.url}\n`;
                });
                
                const blob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'miniamp-playlist.m3u';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast("Playlist berhasil diexport", "ok");
            }

            // --- Tooltip System ---
            function showTooltip(text, element) {
                clearTimeout(tooltipTimeout);
                
                const rect = element.getBoundingClientRect();
                const tooltip = el.tooltip;
                
                tooltip.textContent = text;
                tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
                tooltip.style.top = `${rect.top - 10}px`;
                tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
                
                tooltip.classList.add('show');
                
                tooltipTimeout = setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 3000);
            }
            
            function hideTooltip() {
                clearTimeout(tooltipTimeout);
                el.tooltip.classList.remove('show');
            }

            // --- Utils ---
            function setStatus(text, type = "neutral") {
                el.statusText.textContent = text;
                el.statusDot.className = "status-dot";
                document.querySelector('.deck').className = "deck";

                if (type === "playing") {
                    document.querySelector('.deck').classList.add("playing");
                } else if (type === "warn") {
                    document.querySelector('.deck').classList.add("connecting");
                } else if (type === "err") {
                    document.querySelector('.deck').classList.add("error");
                }
            }

            function updatePlayBtn(isPlaying) {
                const icon = isPlaying ? "ph-pause" : "ph-play";
                el.playBtn.innerHTML = `<i class="ph-fill ${icon}"></i>`;
                el.playBtn.classList.toggle("playing", isPlaying);
            }

            function showToast(msg, type="ok") {
                el.toast.querySelector('span').textContent = msg;
                el.toast.className = `toast show ${type}`;
                el.toast.querySelector('i').className = type === 'ok' ? "ph-fill ph-check-circle" : "ph-fill ph-warning-circle";
                setTimeout(() => el.toast.classList.remove('show'), 3000);
            }

            function extractName(url) {
                try {
                    return new URL(url).pathname.split('/').pop() || "Stream";
                } catch { return "Radio Stream"; }
            }

            function parseM3u(text) {
                const lines = text.split(/\r?\n/);
                const res = [];
                let info = null;
                for(let line of lines) {
                    line = line.trim();
                    if(!line) continue;
                    if(line.startsWith("#EXTINF")) {
                        info = line.split(",")[1];
                    } else if(!line.startsWith("#")) {
                        res.push({ title: info || extractName(line), url: line });
                        info = null;
                    }
                }
                return res;
            }

            // --- Event Listeners ---
            function setupEventListeners() {
                // Media
                el.playBtn.onclick = togglePlay;
                el.nextBtn.onclick = playNext;
                el.prevBtn.onclick = playPrev;
                
                // Sliders & Toggles
                el.volSlider.oninput = (e) => setVolume(e.target.value / 100);
                el.muteIcon.onclick = toggleMute;
                
                el.shuffleBtn.onclick = () => {
                    state.shuffled = !state.shuffled;
                    el.shuffleBtn.classList.toggle("active", state.shuffled);
                    saveStorage();
                    showToast(state.shuffled ? "Acak: ON" : "Acak: OFF");
                };
                
                el.normBtn.onclick = () => {
                    state.normalized = !state.normalized;
                    el.normBtn.classList.toggle("active", state.normalized);
                    saveStorage();
                    showToast(state.normalized ? "Auto Gain: ON" : "Auto Gain: OFF");
                };

                el.vizToggle.onclick = () => {
                    state.vizMode = state.vizMode === 0 ? 1 : 0;
                    const icons = ["ph-chart-bar", "ph-wave-sine"];
                    el.vizToggle.innerHTML = `<i class="ph ${icons[state.vizMode]}"></i>`;
                    showToast(`Visualizer: ${state.vizMode === 0 ? 'Bars' : 'Wave'}`);
                };

                // Search
                el.searchBox.addEventListener('input', applyFilter);

                // Menu Handling
                const toggleMenu = (show) => el.menuOverlay.classList.toggle("show", show);
                el.menuToggleBtn.onclick = () => toggleMenu(true);
                el.menuCloseBtn.onclick = () => toggleMenu(false);
                el.menuOverlay.onclick = (e) => {
                    if(e.target === el.menuOverlay) toggleMenu(false);
                };
                
                // Help Handling
                const toggleHelp = (show) => el.helpOverlay.classList.toggle("show", show);
                el.helpBtn.onclick = () => toggleHelp(true);
                el.helpCloseBtn.onclick = () => toggleHelp(false);
                el.helpOverlay.onclick = (e) => {
                    if(e.target === el.helpOverlay) toggleHelp(false);
                };

                // Menu Actions
                el.resetBtn.onclick = () => {
                    if(confirm("Reset playlist ke stasiun bawaan (Indo)?")) {
                        state.playlist = [...defaultStations];
                        el.audio.pause();
                        state.index = -1;
                        updatePlayBtn(false);
                        saveStorage();
                        applyFilter();
                        toggleMenu(false);
                        showToast("Playlist di-reset!", "ok");
                    }
                };

                el.clearBtn.onclick = () => {
                    if(confirm("Hapus SEMUA stasiun?")) {
                        state.playlist = [];
                        el.audio.pause();
                        state.index = -1;
                        saveStorage();
                        applyFilter();
                        toggleMenu(false);
                    }
                };

                el.sleepTimerBtn.onclick = toggleSleepTimer;
                
                el.exportBtn.onclick = () => {
                    exportPlaylist();
                    toggleMenu(false);
                };

                el.addStreamBtn.onclick = () => {
                    const url = prompt("Masukkan URL Stream (.mp3/.aac):");
                    if (url) {
                        const name = prompt("Nama Stasiun:", extractName(url)) || "Stream Baru";
                        state.playlist.push({ title: name, url: url });
                        saveStorage();
                        applyFilter();
                        toggleMenu(false);
                        showToast("Stasiun ditambahkan", "ok");
                    }
                };

                el.pasteBtn.onclick = async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        if(text) processTextImport(text);
                    } catch(e) {
                        // Fallback if clipboard denied
                        const text = prompt("Paste isi playlist (M3U) di sini:");
                        if(text) processTextImport(text);
                    }
                    toggleMenu(false);
                };

                function processTextImport(text) {
                    const items = parseM3u(text);
                    if(items.length) {
                        state.playlist.push(...items);
                        saveStorage();
                        applyFilter();
                        showToast(`${items.length} stasiun ditambahkan`, "ok");
                    } else {
                        showToast("Format tidak valid", "err");
                    }
                }

                // File handling
                el.loadFileBtn.onclick = () => el.fileInput.click();
                el.fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        const text = await file.text();
                        processTextImport(text);
                    }
                };

                // Drag & Drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
                    document.body.addEventListener(name, e => { e.preventDefault(); e.stopPropagation(); });
                });
                document.body.addEventListener('drop', async (e) => {
                    const file = e.dataTransfer.files[0];
                    if(file && (file.name.endsWith('.m3u') || file.name.endsWith('.txt'))) {
                        const text = await file.text();
                        processTextImport(text);
                    }
                });

                // Audio Events
                el.audio.onerror = () => {
                    setStatus("Error", "err");
                    startRetry();
                };
                el.audio.onended = () => playNext();
                el.audio.onwaiting = () => {
                    state.buffering = true;
                    showInfoPanel("Buffering...");
                };
                el.audio.oncanplay = () => {
                    state.buffering = false;
                    hideInfoPanel();
                };
                
                // Tooltips for buttons
                const tooltipElements = document.querySelectorAll('[title]');
                tooltipElements.forEach(el => {
                    el.addEventListener('mouseenter', (e) => {
                        showTooltip(e.target.getAttribute('title'), e.target);
                    });
                    el.addEventListener('mouseleave', hideTooltip);
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Prevent default if we're handling the key
                    if ([' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'm', 'M', 's', 'S', 'n', 'N'].includes(e.key)) {
                        e.preventDefault();
                    }
                    
                    switch(e.key) {
                        case ' ':
                            togglePlay();
                            break;
                        case 'ArrowRight':
                            playNext();
                            break;
                        case 'ArrowLeft':
                            playPrev();
                            break;
                        case 'ArrowUp':
                            setVolume(Math.min(state.volume + 0.1, 1));
                            break;
                        case 'ArrowDown':
                            setVolume(Math.max(state.volume - 0.1, 0));
                            break;
                        case 'm':
                        case 'M':
                            toggleMute();
                            break;
                        case 's':
                        case 'S':
                            state.shuffled = !state.shuffled;
                            el.shuffleBtn.classList.toggle("active", state.shuffled);
                            saveStorage();
                            showToast(state.shuffled ? "Acak: ON" : "Acak: OFF");
                            break;
                        case 'n':
                        case 'N':
                            state.normalized = !state.normalized;
                            el.normBtn.classList.toggle("active", state.normalized);
                            saveStorage();
                            showToast(state.normalized ? "Auto Gain: ON" : "Auto Gain: OFF");
                            break;
                    }
                });
            }

            // --- Storage ---
            function saveStorage() {
                localStorage.setItem("miniamp", JSON.stringify({
                    playlist: state.playlist,
                    volume: state.volume,
                    shuffled: state.shuffled,
                    normalized: state.normalized
                }));
            }

            function loadStorage() {
                try {
                    const d = JSON.parse(localStorage.getItem("miniamp") || "{}");
                    if (d.playlist) state.playlist = d.playlist;
                    if (d.volume != null) state.volume = d.volume;
                    if (d.shuffled != null) state.shuffled = d.shuffled;
                    if (d.normalized != null) state.normalized = d.normalized;
                } catch(e) { console.log("New session"); }
            }

            // Run
            init();

        })();
    </script>
</body>
</html>