<!doctype html>
<html lang="id" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <title>MiniAmp Ultimate v2.2</title>
    <meta name="description" content="Web Audio Player with 3D Visualizer & Sleep Timer">
    
    <!-- Pustaka Font & Ikon -->
    <link rel="icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=128" type="image/png">
    <link rel="apple-touch-icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=192">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* =========================================
           1. VARIABEL & TEMA
           Mengatur warna global dan properti tampilan
           ========================================= */
        :root {
            /* Tema Terang (Default) */
            --bg-body: #f8f9fa;
            --bg-image: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.08);
            --text-main: #202124;
            --text-muted: #5f6368;
            --accent: #1a73e8;
            --accent-glow: rgba(26, 115, 232, 0.15);
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --font-stack: 'Space Grotesk', system-ui, sans-serif;
            --shadow-xl: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 1px 3px rgba(0, 0, 0, 0.12);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --surface: #ffffff;
            --surface-hover: #f8f9fa;
            --surface-active: #e8f0fe;
        }

        /* Tema Gelap */
        [data-theme="dark"] {
            --bg-body: #202124;
            --bg-image: radial-gradient(circle at 50% -20%, #303134 0%, #202124 100%);
            --glass: rgba(32, 33, 36, 0.9);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #e8eaed;
            --text-muted: #9aa0a6;
            --accent: #8ab4f8;
            --accent-glow: rgba(138, 180, 248, 0.15);
            --surface: #303134;
            --surface-hover: #3c4043;
            --surface-active: #1e3a5f;
        }

        /* Tema Trippy (Animasi) */
        [data-theme="trippy"] {
            --bg-body: #000;
            --bg-image: repeating-conic-gradient(#000 0% 5%, #111 0% 10%);
            --glass: rgba(0, 0, 0, 0.9);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #fff;
            --text-muted: #ddd;
            --accent: #00ff00;
            --accent-glow: rgba(0, 255, 0, 0.5);
            --surface: #111;
            --surface-hover: #222;
            --surface-active: #003300;
            animation: rainbow-bg 20s linear infinite;
        }

        @keyframes rainbow-bg {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* =========================================
           2. RESET & DASAR
           Normalisasi tampilan browser
           ========================================= */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }
        
        body {
            margin: 0; 
            padding: 0;
            background-color: var(--bg-body);
            background-image: var(--bg-image);
            background-size: cover; 
            background-position: center;
            color: var(--text-main); 
            font-family: var(--font-stack);
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            display: grid; 
            place-items: center;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* =========================================
           3. KOMPONEN UI UTAMA
           Overlay, App Shell, Header
           ========================================= */
        
        /* Overlay Drag & Drop */
        #dropOverlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.8); 
            z-index: 9999;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            transition: 0.3s; 
            backdrop-filter: blur(8px);
        }
        #dropOverlay.active { 
            opacity: 1; 
            pointer-events: all; 
        }
        #dropOverlay h2 { 
            color: var(--accent); 
            font-size: 24px; 
            margin-bottom: 10px; 
        }

        /* Wadah Utama Aplikasi (App Shell) */
        .app-shell {
            width: 100%; 
            max-width: 460px; 
            height: 100%; 
            max-height: 920px;
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            display: flex; 
            flex-direction: column;
            position: relative; 
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            transition: border-radius 0.3s ease;
        }
        @media (min-width: 480px) { 
            .app-shell { 
                height: 95vh; 
                border-radius: var(--radius-lg); 
            } 
        }

        /* Bagian Header */
        .header {
            padding: 16px 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--glass-border); 
            flex-shrink: 0;
        }
        .brand { 
            font-weight: 700; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.5px; 
        }
        .brand span { 
            font-size: 9px; 
            background: var(--accent); 
            color: #fff; 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-weight: 800; 
            letter-spacing: 0.5px; 
        }
        
        /* Tombol Ikon Header */
        .hdr-actions { 
            display: flex; 
            gap: 8px; 
        }
        .icon-btn {
            background: var(--surface); 
            border: 1px solid var(--glass-border);
            color: var(--text-muted); 
            width: 38px; 
            height: 38px; 
            border-radius: var(--radius-md);
            cursor: pointer; 
            display: grid; 
            place-items: center; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 18px;
            box-shadow: var(--shadow-md);
        }
        .icon-btn:hover { 
            background: var(--surface-hover); 
            color: var(--text-main); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .icon-btn:active { 
            transform: scale(0.95); 
        }

        /* =========================================
           4. VISUALIZER & VINYL ART
           Area tengah pemutar musik
           ========================================= */
        .viz-container {
            flex: 0 0 240px; 
            position: relative; 
            margin: 10px 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        canvas.viz-canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        
        /* Piringan Hitam (Vinyl) */
        .vinyl-art {
            width: 140px; 
            height: 140px; 
            border-radius: 50%;
            background: conic-gradient(from 0deg, #111 0%, #222 25%, #111 50%, #222 75%, #111 100%);
            border: 4px solid #080808;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 2px var(--glass-border);
            position: relative; 
            z-index: 2;
            display: grid; 
            place-items: center; 
            transition: transform 0.5s ease;
        }
        .vinyl-art::before { 
            content:''; 
            position: absolute; 
            width: 95%; 
            height: 95%; 
            border-radius: 50%; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: repeating-radial-gradient(#111 0, #111 2px, #1a1a1a 3px, #1a1a1a 4px);
        }
        .vinyl-art::after { 
            content:''; 
            width: 30px; 
            height: 30px; 
            background: var(--accent); 
            border-radius: 50%; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); 
            z-index: 3; 
        }
        .vinyl-art.playing { 
            animation: spin 6s linear infinite; 
        }
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }

        /* Indikator Mode Visualizer */
        .mode-pills {
            position: absolute; 
            top: 10px; 
            display: flex; 
            gap: 5px; 
            z-index: 10;
            background: rgba(0,0,0,0.1); 
            padding: 4px; 
            border-radius: 20px;
        }
        .mode-pill { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: rgba(0,0,0,0.2); 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .mode-pill.active { 
            background: var(--accent); 
            transform: scale(1.2); 
            box-shadow: 0 0 8px var(--accent); 
        }

        /* Informasi Lagu */
        .track-info { 
            position: absolute; 
            bottom: 10px; 
            z-index: 2; 
            text-align: center; 
            width: 80%; 
            pointer-events: none;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px;
        }
        .track-title { 
            font-size: 16px; 
            font-weight: 700; 
            color: var(--text-main); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
        }
        .track-meta { 
            font-size: 11px; 
            color: var(--accent); 
            font-weight: 500; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        /* =========================================
           5. KONTROL PEMUTAR
           Tombol Play, Progress Bar, Volume
           ========================================= */
        .controls { 
            padding: 0 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            flex-shrink: 0; 
            margin-bottom: 10px;
        }
        
        .time-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 11px; 
            font-family: monospace; 
            color: var(--text-muted); 
            font-weight: 500;
        }
        .progress-bg { 
            flex: 1; 
            height: 6px; 
            background: rgba(0,0,0,0.1); 
            border-radius: 10px; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden; 
            transition: height 0.2s;
        }
        .progress-bg:hover { 
            height: 10px; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent), #8ab4f8); 
            width: 0%; 
            border-radius: 10px; 
            position: relative; 
            transition: width 0.1s linear;
        }
        .progress-fill::after { 
            content:''; 
            position: absolute; 
            right: 0; 
            top: 0; 
            bottom: 0; 
            width: 4px; 
            background: #fff; 
            box-shadow: 0 0 10px #fff; 
            opacity: 0.8; 
        }
        
        /* Tombol-tombol Player */
        .btn-row { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 24px; 
        }
        .btn { 
            background: transparent; 
            border: none; 
            color: var(--text-main); 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 24px; 
            opacity: 0.8; 
            display: flex; 
        }
        .btn:hover { 
            color: var(--accent); 
            opacity: 1; 
            transform: scale(1.1); 
        }
        .btn:active { 
            transform: scale(0.95); 
        }
        
        .btn-play { 
            width: 64px; 
            height: 64px; 
            border-radius: 50%; 
            background: var(--accent); 
            color: #fff; 
            opacity: 1;
            box-shadow: 0 4px 12px var(--accent-glow); 
            display:grid; 
            place-items:center; 
            font-size: 28px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-play:hover { 
            color: #fff; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px var(--accent-glow); 
        }
        
        .btn.active { 
            color: var(--accent); 
            opacity: 1; 
            position: relative; 
        }
        .btn.active::after { 
            content:''; 
            position: absolute; 
            bottom: -8px; 
            width: 4px; 
            height: 4px; 
            border-radius: 50%; 
            background: currentColor; 
            left: 50%; 
            transform: translateX(-50%); 
        }

        /* Baris Alat Tambahan (Volume, FX) */
        .tools-row { 
            display: grid; 
            grid-template-columns: 1fr auto 1fr; 
            align-items: center; 
            gap: 10px; 
        }
        .vol-wrap { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: var(--surface); 
            padding: 8px 12px; 
            border-radius: var(--radius-md); 
            width: fit-content;
            box-shadow: var(--shadow-md);
        }
        .vol-icon { 
            font-size: 16px; 
            color: var(--text-muted); 
        }
        
        .fx-toggle { 
            font-size: 10px; 
            font-weight: 700; 
            color: var(--accent); 
            background: var(--surface-active); 
            padding: 8px 16px; 
            border-radius: var(--radius-md); 
            border: 1px solid var(--glass-border); 
            cursor: pointer; 
            letter-spacing: 0.5px;
            display: flex; 
            align-items: center; 
            gap: 6px;
            transition: all 0.2s ease;
        }
        .fx-toggle:hover { 
            background: var(--surface-hover); 
        }

        /* Custom Slider Input */
        input[type=range] { 
            -webkit-appearance: none; 
            background: transparent; 
            cursor: pointer; 
        }
        input[type=range]::-webkit-slider-runnable-track { 
            height: 4px; 
            background: var(--glass-border); 
            border-radius: 2px; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 12px; 
            width: 12px; 
            border-radius: 50%; 
            background: var(--accent); 
            margin-top: -4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }

        /* =========================================
           6. PLAYLIST & PENCARIAN
           Area daftar lagu
           ========================================= */
        .playlist-wrap { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            border-top: 1px solid var(--glass-border); 
            min-height: 0; 
            background: var(--surface); 
        }
        .search-bar { 
            padding: 12px 24px; 
            border-bottom: 1px solid var(--glass-border); 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .search-input { 
            flex: 1; 
            background: var(--surface); 
            border: 1px solid var(--glass-border); 
            padding: 10px 14px; 
            border-radius: var(--radius-md); 
            color: var(--text-main); 
            font-family: inherit; 
            font-size: 13px; 
            outline: none; 
            transition: 0.2s;
            box-shadow: var(--shadow-md);
        }
        .search-input:focus { 
            background: var(--surface-hover); 
            border-color: var(--accent); 
            box-shadow: 0 0 0 2px var(--accent-glow); 
        }

        .playlist { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 16px; 
            scroll-behavior: smooth; 
        }
        .playlist::-webkit-scrollbar { 
            width: 4px; 
        }
        .playlist::-webkit-scrollbar-thumb { 
            background: rgba(0,0,0,0.1); 
            border-radius: 4px; 
        }
        
        .pl-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 10px 12px; 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            transition: 0.2s; 
            margin-bottom: 4px; 
            border: 1px solid transparent;
        }
        .pl-item:hover { 
            background: var(--surface-hover); 
            border-color: var(--glass-border); 
        }
        .pl-item.active { 
            background: var(--surface-active); 
            border-color: var(--accent); 
        }
        
        /* Animasi Equalizer Kecil di Playlist */
        .playing-indicator {
            display: flex; 
            gap: 2px; 
            height: 12px; 
            align-items: flex-end; 
            width: 14px;
        }
        .bar { 
            width: 3px; 
            background: var(--accent); 
            animation: bounce 0.5s infinite alternate; 
        }
        .bar:nth-child(2) { animation-delay: 0.1s; } 
        .bar:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { 
            from { height: 2px; } 
            to { height: 12px; } 
        }

        .pl-idx { 
            font-size: 10px; 
            color: var(--text-muted); 
            width: 20px; 
            text-align: center; 
        }
        .pl-info { 
            flex: 1; 
            min-width: 0; 
        }
        .pl-title { 
            font-size: 13px; 
            font-weight: 500; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .pl-sub { 
            font-size: 10px; 
            color: var(--text-muted); 
            margin-top: 2px; 
        }
        
        /* =========================================
           7. PANEL FX (Audio Effects)
           Drawer slide-up untuk pengaturan efek
           ========================================= */
        .fx-drawer { 
            background: var(--surface); 
            border-radius: var(--radius-md) var(--radius-md) 0 0; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            transform: translateY(110%); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid var(--glass-border); 
            z-index: 50; 
            padding-bottom: calc(20px + var(--safe-area-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        .fx-drawer.open { 
            transform: translateY(0); 
        }
        .fx-header { 
            padding: 16px 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--glass-border); 
        }
        .fx-title { 
            font-weight: 700; 
            font-size: 14px; 
            display:flex; 
            align-items:center; 
            gap:8px; 
        }
        
        .fx-content { 
            padding: 20px 24px; 
            display: grid; 
            gap: 20px; 
        }
        .fx-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .fx-label { 
            font-size: 10px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: flex; 
            justify-content: space-between;
        }
        
        /* =========================================
           8. TOOLBAR BAWAH
           Menu cepat: Add, Stream, Rec, Game
           ========================================= */
        .toolbar { 
            padding: 12px 24px; 
            padding-bottom: calc(12px + var(--safe-area-bottom));
            border-top: 1px solid var(--glass-border); 
            display: flex; 
            justify-content: space-around; 
            background: var(--surface); 
            flex-shrink: 0; 
        }
        .tool-btn { 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            font-size: 9px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-weight: 500;
        }
        .tool-btn i { 
            font-size: 22px; 
            margin-bottom: 2px; 
        }
        .tool-btn:hover, .tool-btn.active { 
            color: var(--accent); 
        }
        .tool-btn.rec.active { 
            color: #d93025; 
        }
        /* Indikator Recording (Titik merah berkedip) */
        .rec-dot { 
            width: 8px; 
            height: 8px; 
            background: #d93025; 
            border-radius: 50%; 
            display: none; 
        }
        .tool-btn.rec.active .rec-dot { 
            display: block; 
            animation: pulse-red 1s infinite; 
        }
        
        @keyframes pulse-red { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.5; transform: scale(1.2); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        /* =========================================
           9. KOMPONEN LAIN (Notifikasi, Modal, Game)
           ========================================= */
        .toast { 
            position: absolute; 
            bottom: 100px; 
            left: 50%; 
            transform: translateX(-50%) translateY(20px); 
            background: var(--surface); 
            border: 1px solid var(--glass-border); 
            color: var(--text-main); 
            padding: 10px 20px; 
            border-radius: 30px; 
            font-size: 12px; 
            font-weight: 500;
            opacity: 0; 
            pointer-events: none; 
            z-index: 100; 
            transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }

        /* Game Overlay */
        .game-overlay { 
            position: absolute; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: #000; 
            z-index:60; 
            transform:translateY(100%); 
            transition:0.4s cubic-bezier(0.8, 0, 0.2, 1); 
            display:flex; 
            flex-direction:column; 
        }
        .game-overlay.active { 
            transform:translateY(0); 
        }
        .game-header { 
            padding:20px; 
            display:flex; 
            justify-content:space-between; 
            align-items: center; 
            position:absolute; 
            top:0; 
            width:100%; 
            z-index:10; 
        }
        .score-box { 
            font-size:28px; 
            font-weight:800; 
            color:#fff; 
            font-family:monospace; 
            text-shadow:0 0 15px var(--accent); 
        }

        /* Sleep Timer Modal */
        .modal-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px);
            z-index: 200; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            transition: 0.3s;
        }
        .modal-overlay.active { 
            opacity: 1; 
            pointer-events: all; 
        }
        .modal {
            background: var(--surface); 
            border: 1px solid var(--glass-border); 
            padding: 24px;
            border-radius: 20px; 
            width: 85%; 
            max-width: 320px; 
            text-align: center;
            transform: scale(0.9); 
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-overlay.active .modal { 
            transform: scale(1); 
        }
        .modal h3 { 
            margin: 0 0 16px 0; 
            font-size: 18px; 
        }
        .timer-opts { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 16px; 
        }
        .t-btn { 
            background: var(--surface); 
            border: 1px solid var(--glass-border); 
            padding: 10px; 
            color: var(--text-main); 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        .t-btn:hover, .t-btn.active { 
            background: var(--accent); 
            color: white;
        }
        .modal-close { 
            background: transparent; 
            border: 1px solid var(--glass-border); 
            color: var(--text-muted); 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .modal-close:hover {
            background: var(--surface-hover);
        }
        
        /* Panduan Penggunaan */
        .guide-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
            text-align: left;
        }
        .guide-content h4 {
            margin: 15px 0 8px 0;
            font-size: 14px;
            color: var(--accent);
        }
        .guide-content p {
            margin: 5px 0;
            font-size: 12px;
            line-height: 1.4;
        }
        .guide-content ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .guide-content li {
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 5px;
        }
        .guide-content code {
            background: var(--surface-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Drag & Drop Overlay -->
    <div id="dropOverlay">
        <i class="ph ph-upload-simple" style="font-size: 48px; color: var(--accent); margin-bottom: 10px;"></i>
        <h2>Drop Audio / M3U</h2>
    </div>
    
    <!-- Notifikasi Toast -->
    <div id="toast" class="toast">
        <i class="ph ph-info"></i> <span id="toastMsg">Action</span>
    </div>

    <!-- Modal Sleep Timer -->
    <div id="sleepModal" class="modal-overlay">
        <div class="modal">
            <h3><i class="ph ph-moon"></i> Sleep Timer</h3>
            <div class="timer-opts">
                <button class="t-btn" onclick="App.setSleep(15)">15m</button>
                <button class="t-btn" onclick="App.setSleep(30)">30m</button>
                <button class="t-btn" onclick="App.setSleep(60)">60m</button>
            </div>
            <div id="sleepStatus" style="font-size: 12px; color: var(--accent); margin-bottom: 16px; min-height: 16px;"></div>
            <button class="modal-close" onclick="document.getElementById('sleepModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- Modal Panduan Penggunaan -->
    <div id="guideModal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <h3><i class="ph ph-question"></i> Panduan MiniAmp</h3>
            <div class="guide-content">
                <h4>üéµ Memutar Musik</h4>
                <p>‚Ä¢ Klik tombol <strong>Add</strong> untuk menambahkan file audio dari komputer</p>
                <p>‚Ä¢ Drag & drop file audio langsung ke aplikasi</p>
                <p>‚Ä¢ Klik <strong>Stream</strong> untuk menambahkan URL streaming audio</p>
                <p>‚Ä¢ Klik lagu di playlist untuk memutar</p>
                
                <h4>üéõÔ∏è Kontrol Pemutar</h4>
                <p>‚Ä¢ <strong>Space</strong> - Play/Pause</p>
                <p>‚Ä¢ <strong>‚Üí</strong> - Lagu berikutnya</p>
                <p>‚Ä¢ <strong>‚Üê</strong> - Lagu sebelumnya</p>
                <p>‚Ä¢ Klik progress bar untuk melompat ke bagian tertentu</p>
                <p>‚Ä¢ <strong>Shuffle</strong> - Acak urutan lagu</p>
                <p>‚Ä¢ <strong>Loop</strong> - Ulang lagu saat ini</p>
                
                <h4>üé® Visualizer</h4>
                <p>‚Ä¢ Klik titik di atas visualizer untuk mengganti mode:</p>
                <ul>
                    <li><strong>Mode 1</strong>: Bars (Batang frekuensi)</li>
                    <li><strong>Mode 2</strong>: Wave (Gelombang audio)</li>
                    <li><strong>Mode 3</strong>: Circular (Visualizer melingkar)</li>
                </ul>
                
                <h4>üéöÔ∏è Efek Audio (FX Studio)</h4>
                <p>‚Ä¢ <strong>Playback Speed</strong>: Mengatur kecepatan pemutaran</p>
                <p>‚Ä¢ <strong>Reverb</strong>: Menambahkan efek gema</p>
                <p>‚Ä¢ <strong>Pan</strong>: Mengatur keseimbangan stereo kiri/kanan</p>
                <p>‚Ä¢ <strong>EQ Preset</strong>: Pilih preset equalizer yang sesuai</p>
                
                <h4>üîß Fitur Lainnya</h4>
                <p>‚Ä¢ <strong>Background</strong> - Ganti latar belakang aplikasi</p>
                <p>‚Ä¢ <strong>Themes</strong> - Berganti tema (Light/Dark/Trippy)</p>
                <p>‚Ä¢ <strong>Sleep Timer</strong> - Atur timer untuk berhenti otomatis</p>
                <p>‚Ä¢ <strong>Recording</strong> - Rekam audio yang sedang diputar</p>
                <p>‚Ä¢ <strong>Game</strong> - Mini game ritme sederhana</p>
                
                <h4>üìã Format yang Didukung</h4>
                <p>‚Ä¢ File audio: MP3, WAV, OGG, AAC, dll.</p>
                <p>‚Ä¢ Playlist: M3U, M3U8</p>
                <p>‚Ä¢ Streaming: URL MP3, AAC, M3U streams</p>
            </div>
            <button class="modal-close" onclick="document.getElementById('guideModal').classList.remove('active')" style="margin-top: 16px;">Tutup</button>
        </div>
    </div>

    <!-- Input Tersembunyi (File & Audio) -->
    <input type="file" id="fileInput" multiple hidden accept="audio/*,.m3u,.m3u8">
    <input type="file" id="bgInput" hidden accept="image/*">
    <audio id="mainAudio" crossorigin="anonymous"></audio>

    <!-- Kontainer Utama Aplikasi -->
    <div class="app-shell">
        <!-- Header -->
        <div class="header">
            <div class="brand">
                <i class="ph-fill ph-music-notes-simple" style="color:var(--accent)"></i>
                MiniAmp <span>v2.2</span>
            </div>
            <div class="hdr-actions">
                <button class="icon-btn" id="btnHelp" title="Panduan Penggunaan"><i class="ph ph-question"></i></button>
                <button class="icon-btn" id="btnBg" title="Set Background"><i class="ph ph-image"></i></button>
                <button class="icon-btn" id="btnTheme" title="Cycle Theme"><i class="ph ph-paint-brush-broad"></i></button>
                <button class="icon-btn" id="btnSleep" title="Sleep Timer"><i class="ph ph-moon"></i></button>
            </div>
        </div>

        <!-- Visualizer & Vinyl -->
        <div class="viz-container" id="vizContainer">
            <div class="mode-pills" id="modePills">
                <div class="mode-pill active" onclick="App.setVizMode(0)"></div>
                <div class="mode-pill" onclick="App.setVizMode(1)"></div>
                <div class="mode-pill" onclick="App.setVizMode(2)"></div>
            </div>

            <canvas id="vizCanvas" class="viz-canvas"></canvas>
            
            <div class="vinyl-art" id="vinylArt"></div>
            
            <div class="track-info">
                <div id="nowTitle" class="track-title">Ready to Play</div>
                <div id="nowMeta" class="track-meta">Local / Stream</div>
            </div>
        </div>

        <!-- Kontrol Utama -->
        <div class="controls">
            <div class="time-wrapper">
                <span id="tCurr">0:00</span>
                <div class="progress-bg" id="pBar"><div class="progress-fill" id="pFill"></div></div>
                <span id="tDur">0:00</span>
            </div>

            <div class="btn-row">
                <button class="btn" id="btnShuffle" title="Shuffle"><i class="ph ph-shuffle"></i></button>
                <button class="btn" id="btnPrev"><i class="ph-fill ph-skip-back"></i></button>
                <button class="btn btn-play" id="btnPlay">
                    <i id="icPlay" class="ph-fill ph-play" style="margin-left: 4px;"></i>
                    <i id="icPause" class="ph-fill ph-pause hidden"></i>
                </button>
                <button class="btn" id="btnNext"><i class="ph-fill ph-skip-forward"></i></button>
                <button class="btn" id="btnLoop" title="Loop"><i class="ph ph-repeat"></i></button>
            </div>

            <div class="tools-row">
                <div class="vol-wrap">
                    <i class="ph ph-speaker-high vol-icon"></i>
                    <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.8" style="width:70px">
                </div>
                <div></div>
                <button class="fx-toggle" id="btnFx">
                    <i class="ph ph-faders"></i> FX STUDIO
                </button>
            </div>
        </div>

        <!-- Playlist & Search -->
        <div class="playlist-wrap">
            <div class="search-bar">
                <i class="ph ph-magnifying-glass" style="color:var(--text-muted)"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search tracks...">
                <span id="plCount" style="font-size:10px; color:var(--text-muted)">0</span>
            </div>
            <div class="playlist" id="playlist"></div>
        </div>

        <!-- Toolbar Bawah -->
        <div class="toolbar">
            <button class="tool-btn" id="btnAdd"><i class="ph ph-plus-circle"></i>Add</button>
            <button class="tool-btn" id="btnStream"><i class="ph ph-broadcast"></i>Stream</button>
            <button class="tool-btn rec" id="btnRec">
                <i class="ph ph-microphone-stage"></i>
                <div class="rec-dot"></div>
                Rec
            </button>
            <button class="tool-btn" id="btnGame"><i class="ph ph-game-controller"></i>Game</button>
        </div>

        <!-- FX Drawer -->
        <div id="fxDrawer" class="fx-drawer">
            <div class="fx-header">
                <div class="fx-title"><i class="ph-fill ph-equalizer" style="color:var(--accent)"></i> Audio FX</div>
                <button class="icon-btn" style="width:30px;height:30px" onclick="document.getElementById('fxDrawer').classList.remove('open')"><i class="ph ph-x"></i></button>
            </div>
            <div class="fx-content">
                <div class="fx-group">
                    <div class="fx-label"><span>Playback Speed</span> <span id="valSpeed" style="color:var(--accent)">1.0x</span></div>
                    <input type="range" id="rngSpeed" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                     <div class="fx-group">
                        <div class="fx-label"><span>Reverb</span> <span id="valReverb" style="color:var(--accent)">0%</span></div>
                        <input type="range" id="rngReverb" min="0" max="1" step="0.1" value="0">
                    </div>
                    <div class="fx-group">
                        <div class="fx-label"><span>Pan (L/R)</span> <span id="valPan" style="color:var(--accent)">C</span></div>
                        <input type="range" id="rngPan" min="-1" max="1" step="0.1" value="0">
                    </div>
                </div>
                <div class="fx-group">
                    <div class="fx-label"><span>Equalizer Preset</span></div>
                    <select id="eqSelect" style="width:100%; background:var(--surface); border:1px solid var(--glass-border); color:var(--text-main); padding:10px; border-radius:8px; outline:none">
                        <option value="flat">EQ: Flat (Default)</option>
                        <option value="bass">Bass Booster</option>
                        <option value="vocal">Vocal Enhancer</option>
                        <option value="treble">Treble & Crisp</option>
                        <option value="rock">Rock / Punchy</option>
                    </select>
                </div>
                <label style="display:flex; align-items:center; gap:10px; font-size:12px; color:var(--text-muted); cursor:pointer">
                    <input type="checkbox" id="chkPitch"> Preserve Pitch when changing speed
                </label>
            </div>
        </div>
    </div>

    <!-- Game UI Overlay -->
    <div id="gameUI" class="game-overlay">
        <div class="game-header">
            <div class="score-box"><span style="font-size:14px; color:#888; display:block">SCORE</span><span id="scoreVal">0</span></div>
            <button class="fx-toggle" id="btnCloseGame">EXIT GAME</button>
        </div>
        <canvas id="gameCanvas" style="width:100%;height:100%"></canvas>
    </div>

    <script>
        /**
         * =========================================================
         * MODUL UTAMA APLIKASI
         * Mengatur inisialisasi, state global, dan loop animasi.
         * =========================================================
         */
        const App = {
            // State: Menyimpan seluruh konfigurasi dan data aplikasi
            state: {
                playlist: [],
                filteredPlaylist: [],
                index: -1,
                isPlaying: false,
                isShuffle: false,
                isLoop: false,
                vizMode: 0, // 0: Bars, 1: Wave, 2: Circular
                themeIdx: 0,
                themes: ['light', 'dark', 'trippy'],
                fx: { speed: 1, reverb: 0, pan: 0, pitch: false, eq: 'flat' },
                sleepTimer: null
            },

            // Init: Fungsi pertama yang dijalankan saat aplikasi dimuat
            init() {
                UI.cacheDOM();          // Simpan referensi elemen HTML ke memori
                UI.bindEvents();        // Pasang event listener (klik, input, drag-drop)
                this.loadState();       // Muat data dari LocalStorage
                this.updateTheme();     // Terapkan tema
                this.loop();            // Jalankan loop animasi (Visualizer/Game)
                
                // Set mode visualizer awal di UI
                this.setVizMode(this.state.vizMode);
            },

            // Loop: Dijalankan setiap frame (sekitar 60fps)
            loop() {
                requestAnimationFrame(App.loop);
                if (AudioEngine.analyser) Visualizer.draw();
                if (Game.active) Game.draw();
            },

            // Load State: Membaca pengaturan terakhir pengguna
            loadState() {
                try {
                    const s = JSON.parse(localStorage.getItem('miniamp_v2.2') || '{}');
                    this.state.themeIdx = s.themeIdx || 0;
                    this.state.vizMode = s.vizMode || 0;
                    
                    if (s.volume !== undefined) {
                        UI.dom.audio.volume = s.volume;
                        UI.dom.volSlide.value = s.volume;
                    }

                    // Muat playlist tersimpan atau gunakan demo default
                    if (s.playlist && s.playlist.length) {
                        this.state.playlist = s.playlist;
                    } else {
                        this.state.playlist = [
                            { title: "Mettaswara 2000", url: "https://mettaswara.com:8700/theonest", meta: "Stream" },
                            { title: "Mettaswara 2000", url: "https://mettaswara.com:8700/theonest", meta: "Stream" },
                            { title: "Mettaswara 90s", url: "https://mettaswara.com:8700/metta90", meta: "Stream" },
                            { title: "Mettaswara Campursari", url: "https://mettaswara.com:8700/cps", meta: "Stream" },
                            { title: "Mettaswara Dangdut", url: "https://mettaswara.com:8700/d4d", meta: "Stream" },
                            { title: "Mettaswara Hits", url: "https://mettaswara.com:8700/hits", meta: "Stream" },
                            { title: "Mettaswara Indo 2000", url: "https://mettaswara.com:8700/indo00", meta: "Stream" },
                            { title: "Mettaswara Indo Gold", url: "https://mettaswara.com:8700/disco", meta: "Stream" },
                            { title: "Mettaswara Indonesia", url: "https://mettaswara.com:8700/indo", meta: "Stream" },
                            { title: "Mettaswara Java", url: "https://mettaswara.com:8700/java", meta: "Stream" },
                            { title: "Mettaswara Koplo", url: "https://mettaswara.com:8700/koplo", meta: "Stream" },
                            { title: "Mettaswara Love", url: "https://mettaswara.com:8700/love", meta: "Stream" },
                            { title: "Mettaswara Mix", url: "https://mettaswara.com:8700/mix", meta: "Stream" },
                            { title: "Mettaswara Relax", url: "https://mettaswara.com:8700/metta", meta: "Stream" },
                            { title: "Mettaswara Slow", url: "https://mettaswara.com:8700/slow", meta: "Stream" },
                            { title: "Mettaswara Smooth", url: "https://mettaswara.com:8700/smooth", meta: "Stream" },
                            { title: "Mettaswara Softrock", url: "https://mettaswara.com:8700/slowrock", meta: "Stream" },
                            { title: "Mettaswara Throwback 70", url: "https://mettaswara.com:8700/throw70", meta: "Stream" },
                            { title: "Mettaswara Throwback 80", url: "https://mettaswara.com:8700/mettatrow", meta: "Stream" },
                            { title: "Mettaswara Top 40", url: "https://mettaswara.com:8700/theone", meta: "Stream" }
                        ];
                    }
                } catch (e) { console.error("Gagal memuat state", e); }
                PlaylistManager.render();
            },

            // Save State: Menyimpan pengaturan ke LocalStorage
            saveState() {
                // Filter URL blob lokal agar tidak error saat disimpan
                const clean = this.state.playlist.filter(x => !x.url.startsWith('blob:'));
                localStorage.setItem('miniamp_v2.2', JSON.stringify({
                    themeIdx: this.state.themeIdx,
                    vizMode: this.state.vizMode,
                    volume: UI.dom.audio.volume,
                    playlist: clean
                }));
            },

            // Fungsi Logika Kontrol Tema & Timer
            updateTheme() {
                document.documentElement.setAttribute('data-theme', this.state.themes[this.state.themeIdx]);
                UI.showToast(`Theme: ${this.state.themes[this.state.themeIdx].toUpperCase()}`, "ph-paint-brush");
                this.saveState();
            },

            setVizMode(m) {
                this.state.vizMode = m;
                document.querySelectorAll('.mode-pill').forEach((el, i) => el.classList.toggle('active', i === m));
                this.saveState();
            },

            setSleep(min) {
                clearTimeout(this.state.sleepTimer);
                if (min === 0) {
                    document.getElementById('sleepStatus').innerText = "";
                    UI.showToast("Sleep Timer Off", "ph-moon");
                    return;
                }
                const ms = min * 60 * 1000;
                UI.showToast(`Sleep in ${min} min`, "ph-moon-stars");
                document.getElementById('sleepStatus').innerText = `Closing in ${min} mins...`;
                document.getElementById('sleepModal').classList.remove('active');
                
                this.state.sleepTimer = setTimeout(() => {
                    PlaylistManager.stop();
                    UI.showToast("Sleep Timer: Stopped", "ph-zzz");
                    document.getElementById('sleepStatus').innerText = "";
                }, ms);
            }
        };

        /**
         * =========================================================
         * MODUL AUDIO ENGINE
         * Mengelola Web Audio API, Nodes, dan Efek (DSP)
         * =========================================================
         */
        const AudioEngine = {
            ctx: null,
            gain: null,
            analyser: null,
            panner: null,
            comp: null,
            dry: null,
            wet: null,
            conv: null,
            eq: { l: null, m: null, h: null },

            // Inisialisasi Audio Context
            init() {
                if (this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                
                // Sumber Audio dari elemen HTML <audio>
                const src = this.ctx.createMediaElementSource(UI.dom.audio);
                
                // Inisialisasi Node Dasar
                this.gain = this.ctx.createGain();
                this.analyser = this.ctx.createAnalyser();
                this.analyser.smoothingTimeConstant = 0.85;
                this.analyser.fftSize = 512;
                this.panner = this.ctx.createStereoPanner();
                this.comp = this.ctx.createDynamicsCompressor(); // Kompresor agar suara tidak pecah
                
                // Inisialisasi Node Reverb
                this.dry = this.ctx.createGain();
                this.wet = this.ctx.createGain();
                this.conv = this.ctx.createConvolver();
                this.createImpulse();

                // Inisialisasi Node Equalizer (3-Band)
                this.eq.l = this.ctx.createBiquadFilter(); this.eq.l.type = 'lowshelf'; this.eq.l.frequency.value = 320;
                this.eq.m = this.ctx.createBiquadFilter(); this.eq.m.type = 'peaking'; this.eq.m.frequency.value = 1000;
                this.eq.h = this.ctx.createBiquadFilter(); this.eq.h.type = 'highshelf'; this.eq.h.frequency.value = 3200;

                // Routing / Menghubungkan Kabel Audio
                // Source -> EQ -> Panner
                src.connect(this.eq.l).connect(this.eq.m).connect(this.eq.h).connect(this.panner);
                
                // Panner -> Split (Kering & Basah/Reverb)
                this.panner.connect(this.dry);
                this.panner.connect(this.conv);
                this.conv.connect(this.wet);
                
                // Gabungkan Kembali (Merge) -> Gain Utama
                this.dry.connect(this.gain);
                this.wet.connect(this.gain);
                
                // Output Akhir: Gain -> Kompresor -> Analyser -> Speaker
                this.gain.connect(this.comp);
                this.comp.connect(this.analyser);
                this.comp.connect(this.ctx.destination);
                
                // Inisialisasi Visualizer dengan Analyser Node
                Visualizer.init(this.analyser);
            },

            // Membuat buffer suara impuls buatan untuk efek Reverb
            createImpulse() {
                const rate = this.ctx.sampleRate;
                const len = rate * 2.5; // Ekor reverb sepanjang 2.5 detik
                const buff = this.ctx.createBuffer(2, len, rate);
                for (let c = 0; c < 2; c++) {
                    const d = buff.getChannelData(c);
                    for (let i = 0; i < len; i++) {
                        // Noise meluruh secara eksponensial
                        d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, 4);
                    }
                }
                this.conv.buffer = buff;
            },

            // Memperbarui parameter DSP (Speed, EQ, Reverb, Pan)
            updateDSP() {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                const fx = App.state.fx;
                
                // Speed & Pitch
                UI.dom.audio.playbackRate = fx.speed;
                UI.dom.audio.preservesPitch = fx.pitch;
                
                // Mix Reverb (Dry vs Wet)
                this.wet.gain.setTargetAtTime(fx.reverb, t, 0.1);
                this.dry.gain.setTargetAtTime(1 - (fx.reverb * 0.6), t, 0.1);
                
                // Panning
                this.panner.pan.setTargetAtTime(fx.pan, t, 0.1);
                
                // Preset Equalizer (Gain dalam dB)
                const presets = {
                    flat: [0, 0, 0], 
                    bass: [15, -3, -5], 
                    vocal: [-8, 10, 2], 
                    treble: [-8, 0, 15], 
                    rock: [8, -4, 8]
                };
                const p = presets[fx.eq] || presets.flat;
                
                this.eq.l.gain.setTargetAtTime(p[0], t, 0.2);
                this.eq.m.gain.setTargetAtTime(p[1], t, 0.2);
                this.eq.h.gain.setTargetAtTime(p[2], t, 0.2);
            }
        };

        /**
         * =========================================================
         * MODUL USER INTERFACE (UI)
         * Menangani DOM, Event Listener, dan Update Tampilan
         * =========================================================
         */
        const UI = {
            dom: {},

            // Cache elemen DOM untuk performa
            cacheDOM() {
                this.dom = {
                    audio: document.getElementById('mainAudio'),
                    pFill: document.getElementById('pFill'),
                    tCurr: document.getElementById('tCurr'),
                    tDur: document.getElementById('tDur'),
                    pl: document.getElementById('playlist'),
                    playBtn: document.getElementById('btnPlay'),
                    icPlay: document.getElementById('icPlay'),
                    icPause: document.getElementById('icPause'),
                    vinyl: document.getElementById('vinylArt'),
                    toast: document.getElementById('toast'),
                    toastMsg: document.getElementById('toastMsg'),
                    volSlide: document.getElementById('volSlider'),
                    search: document.getElementById('searchInput'),
                    plCount: document.getElementById('plCount')
                };
            },

            // Tampilkan notifikasi toast di layar
            showToast(msg, icon = "ph-info") {
                const t = this.dom.toast;
                this.dom.toastMsg.innerText = msg; 
                t.querySelector('i').className = `ph ${icon}`;
                t.classList.add('show');
                clearTimeout(this.toastTimer);
                this.toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
            },

            // Format detik ke MM:SS
            fmtTime(s) {
                if (!isFinite(s)) return "--:--";
                const m = Math.floor(s / 60), sc = Math.floor(s % 60);
                return `${m}:${sc < 10 ? '0' : ''}${sc}`;
            },

            // Update status UI (Play/Pause, Judul, Progress)
            updateState() {
                const isPlaying = App.state.isPlaying;
                this.dom.icPlay.classList.toggle('hidden', isPlaying);
                this.dom.icPause.classList.toggle('hidden', !isPlaying);
                this.dom.vinyl.classList.toggle('playing', isPlaying);
                PlaylistManager.render(); // Update indikator di playlist
            },

            // Update Metadata Lagu yang sedang diputar
            updateMeta() {
                const item = App.state.playlist[App.state.index];
                document.getElementById('nowTitle').innerText = item ? item.title : "Ready to Play";
                document.getElementById('nowMeta').innerText = item ? (item.meta || "Local Audio") : "";
                document.title = item ? "‚ñ∂ " + item.title : "MiniAmp v2.2";
            },

            // Pasang semua Event Listener
            bindEvents() {
                const d = this.dom;
                
                // Kontrol Player
                d.playBtn.onclick = () => PlaylistManager.toggle();
                document.getElementById('btnNext').onclick = () => PlaylistManager.next();
                document.getElementById('btnPrev').onclick = () => PlaylistManager.prev();
                
                // Shuffle & Loop
                const shuf = document.getElementById('btnShuffle');
                shuf.onclick = () => {
                    App.state.isShuffle = !App.state.isShuffle;
                    shuf.classList.toggle('active', App.state.isShuffle);
                    this.showToast(`Shuffle: ${App.state.isShuffle ? 'ON' : 'OFF'}`);
                };
                
                const loop = document.getElementById('btnLoop');
                loop.onclick = () => {
                    App.state.isLoop = !App.state.isLoop;
                    loop.classList.toggle('active', App.state.isLoop);
                    d.audio.loop = App.state.isLoop;
                    this.showToast(`Loop: ${App.state.isLoop ? 'ON' : 'OFF'}`);
                };

                // Volume Slider
                d.volSlide.oninput = (e) => {
                    d.audio.volume = parseFloat(e.target.value);
                    App.saveState();
                };
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', e => {
                    if (e.target.tagName === 'INPUT') return;
                    if (e.code === 'Space') { e.preventDefault(); PlaylistManager.toggle(); }
                    if (e.code === 'ArrowRight') PlaylistManager.next();
                    if (e.code === 'ArrowLeft') PlaylistManager.prev();
                });

                // Seek Progress Bar
                document.getElementById('pBar').onclick = e => {
                    if (!d.audio.duration) return;
                    const r = e.currentTarget.getBoundingClientRect();
                    d.audio.currentTime = ((e.clientX - r.left) / r.width) * d.audio.duration;
                };

                // Update Progress Timer
                d.audio.ontimeupdate = () => {
                    const c = d.audio.currentTime, dur = d.audio.duration;
                    if (dur) {
                        d.pFill.style.width = (c / dur * 100) + '%';
                        d.tDur.innerText = this.fmtTime(dur);
                    }
                    d.tCurr.innerText = this.fmtTime(c);
                };
                
                // Auto Next saat lagu habis
                d.audio.onended = () => { if (!App.state.isLoop) PlaylistManager.next(); };

                // Tombol Header
                document.getElementById('btnHelp').onclick = () => document.getElementById('guideModal').classList.add('active');
                document.getElementById('btnBg').onclick = () => document.getElementById('bgInput').click();
                document.getElementById('bgInput').onchange = e => {
                    const f = e.target.files[0];
                    if (f) document.body.style.backgroundImage = `url(${URL.createObjectURL(f)})`;
                };
                document.getElementById('btnTheme').onclick = () => {
                    App.state.themeIdx = (App.state.themeIdx + 1) % App.state.themes.length;
                    App.updateTheme();
                };
                document.getElementById('btnSleep').onclick = () => document.getElementById('sleepModal').classList.add('active');

                // Playlist & Add Files
                d.search.oninput = () => PlaylistManager.render();
                document.getElementById('btnAdd').onclick = () => document.getElementById('fileInput').click();
                document.getElementById('fileInput').onchange = e => PlaylistManager.addFiles(e.target.files);
                document.getElementById('btnStream').onclick = () => {
                    const u = prompt("Enter Stream URL (M3U / MP3 / AAC):");
                    if (u) PlaylistManager.addFiles([{ name: "Web Stream", url: u }]); 
                };
                
                // Drag & Drop
                const ol = document.getElementById('dropOverlay');
                document.body.ondragover = e => { e.preventDefault(); ol.classList.add('active'); };
                ol.ondragleave = () => ol.classList.remove('active');
                ol.ondrop = e => {
                    e.preventDefault(); ol.classList.remove('active');
                    PlaylistManager.addFiles(e.dataTransfer.files);
                };

                // FX Panel Logic
                document.getElementById('btnFx').onclick = () => document.getElementById('fxDrawer').classList.add('open');
                
                // Binding Slider FX
                ['rngSpeed', 'rngReverb', 'rngPan'].forEach(id => {
                    document.getElementById(id).oninput = e => {
                        App.state.fx[id.replace('rng', '').toLowerCase()] = parseFloat(e.target.value);
                        let suffix = id === 'rngSpeed' ? 'x' : '';
                        if (id === 'rngReverb') suffix = '%';
                        let dispVal = e.target.value + suffix;
                        if (id === 'rngReverb') dispVal = Math.round(e.target.value * 100) + '%';
                        
                        e.target.previousElementSibling.querySelector('span:last-child').innerText = dispVal;
                        AudioEngine.updateDSP();
                    };
                });
                document.getElementById('eqSelect').onchange = e => { App.state.fx.eq = e.target.value; AudioEngine.updateDSP(); };
                document.getElementById('chkPitch').onchange = e => { App.state.fx.pitch = e.target.checked; AudioEngine.updateDSP(); };

                // Game & Recorder Buttons
                document.getElementById('btnRec').onclick = () => Recorder.toggle(AudioEngine.ctx, AudioEngine.comp);
                document.getElementById('btnGame').onclick = () => Game.toggle();
                document.getElementById('btnCloseGame').onclick = () => Game.toggle();
            }
        };

        /**
         * =========================================================
         * MODUL PLAYLIST MANAGER
         * Logika Playlist, Playback, Import File/M3U
         * =========================================================
         */
        const PlaylistManager = {
            // Tambah file ke playlist
            addFiles(files) {
                const newItems = [];
                Array.from(files).forEach(f => {
                    if (f.name && (f.name.endsWith('.m3u') || f.name.endsWith('.m3u8'))) {
                        const r = new FileReader();
                        r.onload = e => this.parseM3U(e.target.result);
                        r.readAsText(f);
                    } else {
                        // Jika input manual (bukan file object), sesuaikan struktur
                        const name = f.name || "Stream";
                        const url = f.url || URL.createObjectURL(f);
                        const meta = f.size ? (f.size / 1024 / 1024).toFixed(1) + " MB" : "Stream";
                        newItems.push({
                            title: name.replace(/\.[^/.]+$/, ""), 
                            url: url,
                            meta: meta
                        });
                    }
                });
                
                if (newItems.length > 0) {
                    App.state.playlist.push(...newItems);
                    this.render();
                    UI.showToast(`${newItems.length} Tracks Added`, "ph-check-circle");
                }
            },

            // Parsing file playlist M3U
            parseM3U(txt) {
                const lines = txt.split('\n');
                let count = 0;
                let lastTitle = null;

                lines.forEach(line => {
                    const l = line.trim();
                    if (!l) return;
                    if (l.startsWith('#EXTINF:')) {
                        const commaIdx = l.indexOf(',');
                        if (commaIdx > -1) lastTitle = l.substring(commaIdx + 1).trim();
                    } else if (!l.startsWith('#')) {
                        let url = l.replace(/^http:/, 'https:'); // Paksa HTTPS
                        const title = lastTitle || l.split('/').pop() || `Track ${App.state.playlist.length + 1}`;
                        App.state.playlist.push({ title: title, url: url, meta: "M3U Stream" });
                        count++;
                        lastTitle = null;
                    }
                });
                this.render();
                UI.showToast(`${count} Streams Imported`, "ph-list-plus");
                App.saveState();
            },

            // Render HTML Playlist
            render() {
                const q = UI.dom.search.value.toLowerCase();
                App.state.filteredPlaylist = App.state.playlist.map((item, i) => ({ ...item, origIdx: i }))
                    .filter(item => item.title.toLowerCase().includes(q));
                
                UI.dom.plCount.innerText = App.state.filteredPlaylist.length;

                UI.dom.pl.innerHTML = App.state.filteredPlaylist.map(item => {
                    const isActive = item.origIdx === App.state.index;
                    // Indikator animasi jika sedang main
                    const indicator = isActive && App.state.isPlaying 
                        ? `<div class="playing-indicator"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>`
                        : `<span class="pl-idx">${item.origIdx + 1}</span>`;

                    return `
                    <div class="pl-item ${isActive ? 'active' : ''}" onclick="PlaylistManager.play(${item.origIdx})">
                        ${indicator}
                        <div class="pl-info">
                            <div class="pl-title">${item.title}</div>
                            <div class="pl-sub">${item.meta || 'Unknown'}</div>
                        </div>
                        <div style="padding:4px" onclick="event.stopPropagation(); PlaylistManager.remove(${item.origIdx})">
                            <i class="ph ph-x" style="color:var(--text-muted); font-size:12px"></i>
                        </div>
                    </div>`;
                }).join('');
            },

            remove(i) {
                if (i === App.state.index) return UI.showToast("Can't remove playing track", "ph-warning");
                App.state.playlist.splice(i, 1);
                if (i < App.state.index) App.state.index--;
                this.render();
                App.saveState();
            },

            // Logika Play
            play(idx) {
                AudioEngine.init(); // Pastikan AudioContext jalan
                if (AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
                
                if (idx < 0 || idx >= App.state.playlist.length) return;
                App.state.index = idx;
                
                const item = App.state.playlist[idx];
                UI.dom.audio.src = item.url;
                
                // Cek HTTPS Upgrade
                if (item.url.startsWith('http:')) {
                    UI.dom.audio.src = item.url.replace('http:', 'https:');
                }

                UI.dom.audio.play().then(() => {
                    App.state.isPlaying = true;
                    UI.updateMeta();
                    UI.updateState();
                }).catch(e => {
                    console.error(e);
                    UI.showToast("Stream Error. Skipping...", "ph-warning-circle");
                    setTimeout(() => this.next(), 2000);
                });
                
                this.render();
            },

            toggle() {
                if (App.state.index === -1) return this.play(0);
                if (UI.dom.audio.paused) {
                    UI.dom.audio.play();
                    App.state.isPlaying = true;
                } else {
                    UI.dom.audio.pause();
                    App.state.isPlaying = false;
                }
                UI.updateState();
            },

            stop() {
                UI.dom.audio.pause();
                UI.dom.audio.currentTime = 0;
                App.state.isPlaying = false;
                UI.updateState();
            },

            next() {
                if (App.state.isShuffle) {
                    this.play(Math.floor(Math.random() * App.state.playlist.length));
                } else {
                    this.play((App.state.index + 1) % App.state.playlist.length);
                }
            },

            prev() {
                this.play((App.state.index - 1 + App.state.playlist.length) % App.state.playlist.length);
            }
        };

        /**
         * =========================================================
         * MODUL VISUALIZER
         * Menggambar grafik audio ke elemen Canvas
         * =========================================================
         */
        const Visualizer = {
            ctx: null, data: null, analyser: null,
            
            init(node) {
                const cvs = document.getElementById('vizCanvas');
                this.ctx = cvs.getContext('2d');
                this.analyser = node;
                this.data = new Uint8Array(node.frequencyBinCount);
            },
            
            draw() {
                const cvs = document.getElementById('vizCanvas');
                const w = cvs.width = cvs.clientWidth;
                const h = cvs.height = cvs.clientHeight;
                const mode = App.state.vizMode;
                // Ambil warna aksen dari CSS Variable
                const accent = getComputedStyle(document.body).getPropertyValue('--accent');
                
                this.ctx.clearRect(0, 0, w, h);

                if (mode === 0) { // MODE BARS
                    this.analyser.getByteFrequencyData(this.data);
                    const bars = 64;
                    const step = Math.floor(this.data.length / bars);
                    const barW = w / bars;
                    
                    for (let i = 0; i < bars; i++) {
                        const v = this.data[i * step];
                        const barH = (v / 255) * h * 0.8;
                        this.ctx.fillStyle = accent;
                        this.ctx.globalAlpha = 0.6;
                        // Efek Cermin (Kiri Kanan)
                        this.ctx.fillRect(w / 2 + i * barW / 2, h / 2 - barH / 2, (barW / 2) - 1, barH);
                        this.ctx.fillRect(w / 2 - i * barW / 2, h / 2 - barH / 2, (barW / 2) - 1, barH);
                    }
                } else if (mode === 1) { // MODE WAVEFORM
                    this.analyser.getByteTimeDomainData(this.data);
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeStyle = accent;
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = accent;
                    this.ctx.beginPath();
                    const slice = w / this.data.length;
                    let x = 0;
                    for (let i = 0; i < this.data.length; i++) {
                        const v = this.data[i] / 128.0;
                        const y = v * h / 2;
                        if (i === 0) this.ctx.moveTo(x, y); else this.ctx.lineTo(x, y);
                        x += slice;
                    }
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                } else if (mode === 2) { // MODE CIRCULAR
                    this.analyser.getByteFrequencyData(this.data);
                    const cx = w / 2, cy = h / 2, radius = 75; // Radius di luar piringan vinyl
                    const bars = 60;
                    const step = Math.floor(this.data.length / bars);
                    
                    this.ctx.fillStyle = accent;
                    for (let i = 0; i < bars; i++) {
                        const v = this.data[i * step];
                        const len = (v / 255) * 60;
                        const angle = (i / bars) * Math.PI * 2;
                        
                        this.ctx.save();
                        this.ctx.translate(cx, cy);
                        this.ctx.rotate(angle);
                        this.ctx.globalAlpha = 0.5 + (v / 512);
                        this.ctx.fillRect(0, radius, 4, len);
                        this.ctx.restore();
                    }
                }
            }
        };

        /**
         * =========================================================
         * MODUL RECORDER
         * Merekam output audio ke file .webm
         * =========================================================
         */
        const Recorder = {
            rec: null, chunks: [], isRecording: false,
            
            toggle(ctx, node) {
                if (this.isRecording) { this.stop(); return; }
                if (!ctx || ctx.state === 'suspended') return UI.showToast("Play audio first", "ph-warning");
                
                // Buat destination node baru khusus rekaman
                const dest = ctx.createMediaStreamDestination();
                node.connect(dest);
                
                // Cek dukungan codec opus
                const opts = MediaRecorder.isTypeSupported("audio/webm;codecs=opus") 
                    ? { mimeType: "audio/webm;codecs=opus", audioBitsPerSecond: 256000 } 
                    : {};

                try { this.rec = new MediaRecorder(dest.stream, opts); } catch (e) { return UI.showToast("Rec Error", "ph-x"); }

                this.chunks = [];
                this.rec.ondataavailable = e => { if (e.data.size > 0) this.chunks.push(e.data); };
                this.rec.onstop = () => {
                    const blob = new Blob(this.chunks, { type: 'audio/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob); 
                    a.download = `Rec_${new Date().getTime()}.webm`;
                    a.click();
                    UI.showToast("Recording Saved", "ph-download-simple");
                };
                
                this.rec.start(100);
                this.isRecording = true;
                document.getElementById('btnRec').classList.add('active');
                UI.showToast("Recording Started...", "ph-record");
            },
            
            stop() {
                if (this.rec && this.isRecording) {
                    this.rec.stop();
                    this.isRecording = false;
                    document.getElementById('btnRec').classList.remove('active');
                }
            }
        };

        /**
         * =========================================================
         * MODUL MINI GAME
         * Game ritme sederhana berdasarkan beat audio
         * =========================================================
         */
        const Game = {
            active: false, drops: [], score: 0, lastSpawn: 0,
            
            toggle() {
                this.active = !this.active;
                document.getElementById('gameUI').classList.toggle('active', this.active);
                if (this.active) {
                    this.drops = []; this.score = 0;
                    const c = document.getElementById('gameCanvas');
                    c.width = c.clientWidth; c.height = c.clientHeight;
                    c.onclick = e => {
                        const r = c.getBoundingClientRect();
                        this.checkHit(e.clientX - r.left, e.clientY - r.top);
                    };
                }
            },
            
            // Cek apakah klik mengenai target
            checkHit(x, y) {
                this.drops.forEach((d, i) => {
                    if (Math.hypot(d.x - x, d.y - y) < d.r + 30) {
                        this.drops.splice(i, 1);
                        this.score += 100;
                        this.updateScore();
                    }
                });
            },
            
            updateScore() {
                document.getElementById('scoreVal').innerText = this.score;
            },
            
            draw() {
                const c = document.getElementById('gameCanvas');
                const ctx = c.getContext('2d');
                const w = c.width, h = c.height;
                const now = Date.now();
                
                // Efek Jejak (Trail)
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(0, 0, w, h);
                
                let bass = 0;
                if (AudioEngine.analyser) {
                    const arr = new Uint8Array(4);
                    AudioEngine.analyser.getByteFrequencyData(arr);
                    bass = arr[1]; // Ambil frekuensi bass rendah
                }
                
                // Spawn target jika bass tinggi (beat)
                if (bass > 210 && now - this.lastSpawn > 300) {
                    this.drops.push({
                        x: Math.random() * (w - 60) + 30, 
                        y: -30, 
                        r: 10 + (bass / 10), 
                        color: `hsl(${Math.random() * 360},100%,60%)`,
                        speed: 3 + (App.state.fx.speed * 2)
                    });
                    this.lastSpawn = now;
                }
                
                // Gambar garis batas bawah
                ctx.strokeStyle = '#fff'; ctx.beginPath(); ctx.moveTo(0, h - 100); ctx.lineTo(w, h - 100); 
                ctx.setLineDash([5, 15]); ctx.stroke(); ctx.setLineDash([]);

                this.drops.forEach((d, i) => {
                    d.y += d.speed;
                    // Denyut berdasarkan musik
                    const pulse = d.r + (bass / 40);
                    
                    ctx.beginPath(); ctx.arc(d.x, d.y, pulse, 0, Math.PI * 2);
                    ctx.fillStyle = d.color; ctx.fill();
                    ctx.shadowBlur = 15; ctx.shadowColor = d.color;
                    
                    // Jika target lewat batas, kurangi skor
                    if (d.y > h) { 
                        this.drops.splice(i, 1); 
                        this.score = Math.max(0, this.score - 50); 
                        this.updateScore();
                    }
                });
                ctx.shadowBlur = 0;
            }
        };

        // Jalankan Aplikasi saat window selesai dimuat
        window.onload = () => App.init();
    </script>
</body>
</html>
