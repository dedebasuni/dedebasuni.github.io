<!doctype html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MiniAmp</title>
    <meta name="description" content="Pemutar Musik Web Hibrida dengan Rekam, Visualizer dan EQ">
    <link rel="icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=128" type="image/png">
    <link rel="apple-touch-icon" href="https://www.google.com/s2/favicons?domain=google.com&sz=192">
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
        /* =========================================
           VARIBEL CSS & TEMA
           ========================================= */
        :root {
            /* --- Variabel Dasar (Mode Gelap Default) --- */
            --bg-body: #0f172a;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 70%);
            --surface: rgba(30, 41, 59, 0.7);
            --surface-hover: rgba(51, 65, 85, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        /* --- Mode Terang --- */
        [data-theme="light"] {
            --bg-body: #f1f5f9;
            --bg-gradient: radial-gradient(circle at 50% 0%, #ffffff 0%, #f1f5f9 70%);
            --surface: rgba(255, 255, 255, 0.8);
            --surface-hover: rgba(248, 250, 252, 0.9);
            --border: rgba(0, 0, 0, 0.08);
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            --accent: #2563eb;
            --accent-glow: rgba(37, 99, 235, 0.2);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
        }
        
        /* --- Mode Trippy (Neon) --- */
        [data-theme="trippy"] {
            --bg-body: #0f0f23;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #0f0f23 70%);
            --surface: rgba(26, 26, 46, 0.7);
            --surface-hover: rgba(42, 42, 74, 0.8);
            --border: rgba(255, 0, 255, 0.2);
            --text-main: #e2e8f0;
            --text-muted: #a78bfa;
            --accent: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.4);
        }
        
        /* =========================================
           RESET & LAYOUT UTAMA
           ========================================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; overflow: hidden; }
        
        body {
            margin: 0;
            color: var(--text-main);
            background: var(--bg-body);
            background-image: var(--bg-gradient);
            font-family: var(--font-stack);
            display: grid;
            place-items: center;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        svg { width: 20px; height: 20px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        /* Kontainer Aplikasi */
        .app {
            width: min(94vw, 500px);
            height: min(92vh, 800px);
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* =========================================
           HEADER & DECK VISUAL
           ========================================= */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            font-weight: 800;
            font-size: 18px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand svg { color: var(--accent); }

        .theme-toggle {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .theme-toggle:hover { color: var(--text-main); background: var(--border); }

        /* Area Visualizer & Info */
        .deck {
            background: rgba(0,0,0,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 140px;
            justify-content: center;
            overflow: hidden;
        }

        .viz-canvas {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 60px;
            opacity: 0.4;
            pointer-events: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .viz-interactive {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .status-badge {
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
            font-weight: 700; color: var(--text-muted);
            display: flex; align-items: center; gap: 6px;
            margin-bottom: 4px; z-index: 2;
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--text-muted); transition: 0.3s;
        }
        .status-dot.active { background: var(--success); box-shadow: 0 0 12px var(--success); animation: pulse 2s infinite; }
        .status-dot.warn { background: var(--warning); box-shadow: 0 0 12px var(--warning); }
        .status-dot.error { background: var(--danger); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .title-display {
            font-size: 16px; font-weight: 600; line-height: 1.4;
            color: var(--text-main); width: 100%;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            z-index: 2; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .tech-info {
            font-size: 11px; color: var(--text-muted);
            font-family: monospace; opacity: 0.7; z-index: 2;
        }

        /* =========================================
           KONTROL AUDIO
           ========================================= */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            align-items: center;
        }
        
        .btn {
            appearance: none; border: none; cursor: pointer;
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text-main); height: 44px;
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .btn:hover { background: var(--surface-hover); transform: translateY(-2px); border-color: var(--accent); }
        .btn:active { transform: translateY(0); }
        
        .btn.primary {
            background: var(--accent); color: white;
            border-color: transparent; box-shadow: 0 4px 12px var(--accent-glow);
        }
        .btn.active { background: var(--surface-hover); color: var(--accent); border-color: var(--accent); }

        .btn-large { grid-column: span 1; height: 50px; }
        .btn-play { grid-column: span 1; height: 56px; border-radius: 28px; }

        /* Volume & EQ */
        .volume-container {
            grid-column: span 5;
            display: flex; align-items: center; gap: 12px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.02);
            border-radius: var(--radius-md);
            margin-top: 8px;
        }
        
        .vol-label { font-size: 12px; font-weight: 600; min-width: 36px; text-align: center; }
        
        .tool-select {
            background: transparent; color: var(--text-muted);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 6px 12px; font-size: 11px; font-weight: 600;
            outline: none; cursor: pointer; text-align: center;
        }
        .tool-select option { background: var(--bg-body); color: var(--text-main); }

        /* =========================================
           PLAYLIST & NAVIGASI
           ========================================= */
        .playlist-container {
            flex: 1; 
            min-height: 0;
            border-top: 1px solid var(--border);
            padding-top: 12px;
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            overflow: hidden;
        }

        .search-box {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text-main); padding: 8px 12px;
            border-radius: var(--radius-sm); width: 100%;
            font-size: 13px; outline: none; transition: 0.2s;
            flex-shrink: 0;
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        .playlist-scroll {
            flex: 1; 
            overflow-y: auto; 
            padding-right: 4px;
            min-height: 0;
        }
        /* Custom Scrollbar */
        .playlist-scroll::-webkit-scrollbar { width: 4px; }
        .playlist-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        .playlist-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.2s;
            border: 1px solid transparent; position: relative;
        }
        .playlist-item:hover { background: rgba(0,0,0,0.03); }
        .playlist-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
        }
        .playlist-item.active .item-title { color: var(--accent); font-weight: 600; }

        .item-num { font-size: 11px; color: var(--text-muted); width: 20px; }
        .item-title { font-size: 13px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .item-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .playlist-item:hover .item-actions { opacity: 1; }
        
        .btn-mini {
            width: 24px; height: 24px; padding: 0;
            border-radius: 6px; background: transparent;
            color: var(--text-muted); border: none; cursor: pointer;
        }
        .btn-mini:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* =========================================
           TOOLBAR COMPACT - MOBILE RESPONSIVE
           ========================================= */
        .toolbar-compact {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: auto;
            width: 100%;
            flex-shrink: 0;
        }

        .toolbar-main {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            padding: 8px;
            width: 100%;
        }

        .tool-btn {
            appearance: none;
            border: none;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

        .tool-btn.danger {
            color: var(--danger);
            background: transparent;
        }

        .tool-btn.danger:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-1px);
        }

        /* Efek tombol recording */
        #recordBtn.recording {
            background: var(--danger);
            color: white;
            animation: pulse-rec 1s infinite;
        }

        @keyframes pulse-rec {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Ikon dalam tombol */
        .tool-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        /* Notifikasi */
        .notification {
            position: absolute; bottom: 24px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-main); color: var(--bg-body);
            padding: 10px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100; white-space: nowrap;
        }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification.error { background: var(--danger); color: white; }

        /* Komponen Overlay (Game & Skin) */
        .overlay-modal {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; color: white;
        }
        .overlay-modal.active { opacity: 1; pointer-events: all; }

        .game-canvas { background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 20px; }
        
        .skin-panel {
            background: var(--surface); padding: 24px;
            border-radius: var(--radius-lg); width: 300px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .skin-preview {
            width: 100%; height: 120px; background-color: #333;
            border-radius: var(--radius-sm); margin-bottom: 15px;
            background-size: cover; background-position: center;
        }

        /* =========================================
           RESPONSIVE BREAKPOINTS
           ========================================= */
        @media (max-width: 480px) {
            .app {
                width: 100%; 
                height: 100%; 
                border: none; 
                border-radius: 0; 
                padding: 16px;
                gap: 12px;
            }

            .toolbar-compact {
                gap: 6px;
                margin-top: auto;
                padding-top: 12px;
                border-top: 1px solid var(--border);
            }

            .toolbar-main {
                gap: 10px;
                padding: 6px 4px;
            }

            .playlist-container {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .playlist-scroll {
                flex: 1;
                overflow-y: auto;
                padding-right: 4px;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>

    <div class="app" role="application">
        
        <!-- Header -->
        <div class="top-bar">
            <div class="brand">
                <svg viewBox="0 0 24 24"><path d="M12 2c-5.5 0-10 4.5-10 10s4.5 10 10 10 10-4.5 10-10-5.5-10-10-10zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"/><path d="M10 16.5l6-4.5-6-4.5v9zM12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1-10-10z" fill="currentColor"/></svg>
                MiniAmp
            </div>
            <button id="themeToggle" class="theme-toggle" title="Ganti Tema">
                <svg id="iconMoon" style="display:none" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="iconSun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </div>

        <!-- Deck Informasi & Visualizer -->
        <div class="deck">
            <canvas id="vizCanvas" class="viz-canvas"></canvas>
            <canvas id="vizInteractive" class="viz-interactive" title="Sentuh untuk ubah EQ"></canvas>
            <div class="status-badge">
                <div id="statusDot" class="status-dot"></div>
                <span id="statusText">IDLE</span>
            </div>
            <div id="nowTitle" class="title-display" title="Sedang Diputar">Pilih stasiun</div>
            <div class="tech-info">
                <span id="featureBadge">Audio Init</span> â€¢ <span id="corsBadge">CORS Ready</span>
            </div>
        </div>

        <!-- Kontrol Utama -->
        <div class="controls-grid">
            <button id="prevBtn" class="btn btn-large" title="Sebelumnya">
                <svg viewBox="0 0 24 24"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
            </button>
            <button id="stopBtn" class="btn btn-large" title="Berhenti">
                <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"></rect></svg>
            </button>
            <button id="playBtn" class="btn btn-primary btn-play" title="Putar">
                <svg id="iconPlay" viewBox="0 0 24 24" style="fill: currentColor; stroke: none;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg id="iconPause" viewBox="0 0 24 24" style="display:none; fill: currentColor; stroke: none;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
            </button>
            <button id="nextBtn" class="btn btn-large" title="Berikutnya">
                <svg viewBox="0 0 24 24"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
            </button>
            <button id="shuffleBtn" class="btn btn-large" title="Acak">
                <svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
            </button>

            <!-- Volume & EQ -->
            <div class="volume-container">
                <button id="muteBtn" class="btn btn-mini" title="Bisukan">
                    <svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                </button>
                <button id="volDown" class="btn btn-mini" title="Vol -">-</button>
                <div id="volNum" class="vol-label">50%</div>
                <button id="volUp" class="btn btn-mini" title="Vol +">+</button>
        
                <!-- Tombol REC -->
                <button id="recordBtn" class="btn btn-mini" title="Rekam ke MP3">
                    <svg id="iconRec" viewBox="0 0 24 24" style="fill: currentColor; stroke: none;">
                        <circle cx="12" cy="12" r="6"/>
                    </svg>
                    <svg id="iconRecStop" viewBox="0 0 24 24" style="display:none; fill: currentColor; stroke: none;">
                       <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                </button>
        
                <div style="flex:1"></div>
        
                <!-- Pilihan EQ -->
                <select id="eqSelect" class="tool-select" title="Preset Equalizer">
                    <option value="flat">EQ: Flat</option>
                    <option value="bass">EQ: Bass</option>
                    <option value="treble">EQ: Treble</option>
                    <option value="vocal">EQ: Vokal</option>
                    <option value="rock">EQ: Rock</option>
                </select>
        
                <button id="normBtn" class="tool-btn active" title="Auto Gain Control (Penyeimbang Volume)">AGC ON</button>
            </div>
        </div>

        <!-- Playlist & Pencarian -->
        <div class="playlist-container">
            <input type="text" id="searchInput" class="search-box" placeholder="Cari stasiun...">
            
            <div style="display: flex; justify-content: space-between; padding: 0 4px; font-size: 12px; color: var(--text-muted); font-weight: 600;">
                <span id="stationCount">0 STASIUN</span>
                <button id="loadPresetBtn" class="tool-btn" style="padding: 2px 8px; font-size: 10px;">+ DEMO</button>
            </div>
            
            <div class="playlist-scroll">
                <ul id="playlist" style="list-style:none; padding:0; margin:0;"></ul>
            </div>
        </div>

        <!-- Toolbar Bawah -->
        <div class="toolbar-compact">
            <div class="toolbar-main">
                <button id="addStreamBtn" class="tool-btn" title="URL">
                    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                </button>
                <button id="loadUrlBtn" class="tool-btn" title="M3U">
                    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                </button>
                <button id="loadFileBtn" class="tool-btn" title="File">
                    <svg viewBox="0 0 24 24" width="14" height="14"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                </button>
                <button id="gameBtn" class="tool-btn" title="Game">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="8" width="18" height="10" rx="3" />
                        <circle cx="9" cy="13" r="1.5" />
                        <circle cx="15" cy="13" r="1.5" />
                    </svg>
                </button>
                <button id="skinBtn" class="tool-btn" title="Tema">
                    <svg viewBox="0 0 24 24" width="16" height="16"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                </button>
                <button id="clearBtn" class="tool-btn danger" title="Hapus">
                    <svg viewBox="0 0 24 24" width="14" height="14"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <!-- Elemen Tersembunyi & Overlay -->
    <div id="notification" class="notification"></div>
    <input id="fileInput" type="file" accept="audio/*,.m3u,.m3u8,.txt" multiple hidden>
    <audio id="audio" crossorigin="anonymous"></audio>
    
    <!-- Overlay: Mini Game -->
    <div id="miniGame" class="overlay-modal">
        <h2 style="margin-bottom: 20px;">Beat Tap Challenge</h2>
        <canvas id="gameCanvas" class="game-canvas" width="300" height="400"></canvas>
        <div style="font-size: 18px; margin-bottom: 20px;">Skor: <span id="gameScore">0</span></div>
        <button id="gameClose" class="btn primary" style="padding: 0 20px;">Tutup Game</button>
    </div>
    
    <!-- Overlay: Upload Skin -->
    <div id="skinOverlay" class="overlay-modal">
        <div class="skin-panel">
            <h3 style="margin-top:0; color: var(--text-main);">Kustomisasi Latar</h3>
            <div id="skinPreview" class="skin-preview"></div>
            <input type="file" id="skinFile" accept="image/*" style="width:100%; margin-bottom:15px; color: var(--text-muted);">
            <div style="display:flex; gap:10px;">
                <button id="skinApply" class="btn primary" style="flex:1">Terapkan</button>
                <button id="skinReset" class="btn" style="flex:1">Reset</button>
                <button id="skinCancel" class="btn" style="flex:1">Batal</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            /* =========================================
               MODUL: KONFIGURASI (Config)
               Pengaturan dasar aplikasi
               ========================================= */
            const Config = {
                fadeIn: 0.7,
                fadeOut: 0.6,
                targetDb: -18,
                limiter: -14,
                maxRetries: 6,
                storageKey: "miniamp.state",
                skinKey: "miniamp.skin"
            };

            /* =========================================
               MODUL: STATE APLIKASI (AppState)
               Menyimpan status runtime
               ========================================= */
            const AppState = {
                playlist: [],
                displayPlaylist: [],
                currentIndex: -1,
                isShuffled: false,
                isNormalized: true,
                volume: 0.5,
                currentEq: "flat",
                currentMetadata: "",
                isStopped: false,
                isRecording: false,
                metadataTimeout: null,
                retryCount: 0,
                retryTimeout: null
            };

            /* =========================================
               MODUL: MESIN AUDIO (AudioEngine)
               Menangani Web Audio API, Node, dan Efek
               ========================================= */
            const AudioEngine = {
                ctx: null,
                nodes: {},
                eqFilters: [],

                async init() {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!this.ctx) {
                        this.ctx = new AudioContextClass();
                        const elAudio = document.getElementById('audio');
                        elAudio.volume = AppState.volume;
                        
                        // Membuat Node
                        this.nodes.source = this.ctx.createMediaElementSource(elAudio);
                        this.nodes.gain = this.ctx.createGain();
                        this.nodes.analyser = this.ctx.createAnalyser();
                        this.nodes.compressor = this.ctx.createDynamicsCompressor();
                        this.nodes.fadeIn = this.ctx.createGain();
                        this.nodes.masterVol = this.ctx.createGain();
                        
                        // Konfigurasi EQ
                        this.eqFilters = [100, 1000, 5000].map(freq => {
                            const f = this.ctx.createBiquadFilter();
                            f.type = 'peaking';
                            f.frequency.value = freq;
                            f.Q.value = 1;
                            return f;
                        });

                        // Konfigurasi Analyser & Kompresor
                        this.nodes.analyser.fftSize = 256;
                        this.nodes.compressor.threshold.value = Config.limiter;
                        this.nodes.compressor.ratio.value = 12;

                        // Rantai Koneksi
                        let lastNode = this.nodes.source;
                        this.eqFilters.forEach(node => {
                            lastNode.connect(node);
                            lastNode = node;
                        });
                        
                        lastNode.connect(this.nodes.gain);
                        this.nodes.gain.connect(this.nodes.analyser);
                        this.nodes.analyser.connect(this.nodes.compressor);
                        this.nodes.compressor.connect(this.nodes.fadeIn);
                        this.nodes.fadeIn.connect(this.nodes.masterVol);
                        this.nodes.masterVol.connect(this.ctx.destination);

                        // Mulai sistem pendukung
                        this.startAGC();
                        Visualizer.start(this.nodes.analyser);
                        Visualizer.initInteractive();
                        this.applyEq(AppState.currentEq);
                        this.setVolume(AppState.volume);
                        
                        document.getElementById('featureBadge').textContent = "Audio: Aktif";
                    }
                    if (this.ctx.state === 'suspended') await this.ctx.resume();
                },

                applyEq(presetName) {
                    const presets = {
                        flat: { bass: 1.0, mid: 1.0, treble: 1.0 },
                        bass: { bass: 1.5, mid: 1.0, treble: 0.8 },
                        treble: { bass: 0.8, mid: 1.0, treble: 1.5 },
                        vocal: { bass: 0.9, mid: 1.4, treble: 1.1 },
                        rock: { bass: 1.3, mid: 0.8, treble: 1.3 }
                    };
                    const p = presets[presetName] || presets.flat;
                    AppState.currentEq = presetName;
                    
                    if (this.ctx && this.eqFilters.length === 3) {
                        const now = this.ctx.currentTime;
                        this.eqFilters[0].gain.setTargetAtTime(p.bass, now, 0.1);
                        this.eqFilters[1].gain.setTargetAtTime(p.mid, now, 0.1);
                        this.eqFilters[2].gain.setTargetAtTime(p.treble, now, 0.1);
                    }
                    Storage.save();
                },

                startAGC() {
                    const buffer = new Float32Array(256);
                    let gainVal = 0;
                    
                    const loop = () => {
                        if (!this.ctx || AppState.isStopped) { requestAnimationFrame(loop); return; }
                        
                        if (AppState.isNormalized && !document.getElementById('audio').paused) {
                            this.nodes.analyser.getFloatTimeDomainData(buffer);
                            let sum = 0;
                            for(let i=0; i<buffer.length; i++) sum += buffer[i]*buffer[i];
                            const rms = Math.sqrt(sum/buffer.length) || 1e-6;
                            const db = 20 * Math.log10(rms);
                            
                            const adj = Math.max(-8, Math.min(8, Config.targetDb - db));
                            gainVal = gainVal + (adj - gainVal) * 0.08;
                            
                            this.nodes.gain.gain.setTargetAtTime(Math.pow(10, gainVal/20), this.ctx.currentTime, 0.12);
                        } else {
                            this.nodes.gain.gain.setTargetAtTime(1, this.ctx.currentTime, 0.15);
                        }
                        requestAnimationFrame(loop);
                    };
                    loop();
                },

                setVolume(val) {
                    const safeVal = Math.max(0, Math.min(0.8, val));
                    AppState.volume = safeVal;

                    if (this.nodes.masterVol) {
                        this.nodes.masterVol.gain.setTargetAtTime(AppState.volume, this.ctx.currentTime, 0.05);
                    }

                    const elAudio = document.getElementById('audio');
                    elAudio.volume = AppState.volume;

                    UI.updateVolumeDisplay();
                    Storage.save();
                },

                fade(target, duration) {
                    if (!this.ctx || !this.nodes.fadeIn) return;
                    const now = this.ctx.currentTime;
                    this.nodes.fadeIn.gain.cancelScheduledValues(now);
                    this.nodes.fadeIn.gain.setValueAtTime(this.nodes.fadeIn.gain.value, now);
                    this.nodes.fadeIn.gain.linearRampToValueAtTime(target, now + duration);
                }
            };

            /* =========================================
               MODUL: RECORDER (Rekam Audio ke MP3)
               Menangani Rekaman dan download MP3 Audio
               ========================================= */
            const Recorder = {
                isRecording: false,
                mediaRecorder: null,
                audioChunks: [],
                audioContext: null,
                scriptProcessor: null,
                lameWorker: null,
                mp3Encoder: null,
                startTime: 0,

                async start() {
                    if (typeof lamejs === 'undefined') {
                        UI.notify("Error: Library MP3 encoder tidak tersedia", "error");
                        console.error("lamejs not found");
                        return;
                    }

                    if (!AudioEngine.ctx) {
                        UI.notify("Audio engine belum siap", "error");
                        return;
                    }

                    this.isRecording = true;
                    this.audioChunks = [];
                    this.startTime = Date.now();

                    try {
                        if (!lamejs || !lamejs.Mp3Encoder) {
                            throw new Error("MP3 encoder tidak tersedia");
                        }
            
                        this.mp3Encoder = new lamejs.Mp3Encoder(2, 44100, 128);

                        this.scriptProcessor = AudioEngine.ctx.createScriptProcessor(4096, 2, 2);

                        AudioEngine.nodes.masterVol.connect(this.scriptProcessor);
                        this.scriptProcessor.connect(AudioEngine.ctx.destination);

                        this.scriptProcessor.onaudioprocess = (event) => {
                            if (!this.isRecording || !this.mp3Encoder) return;

                            const left = event.inputBuffer.getChannelData(0);
                            const right = event.inputBuffer.getChannelData(1);

                            const leftInt16 = this.floatTo16BitPCM(left);
                            const rightInt16 = this.floatTo16BitPCM(right);

                            try {
                                const mp3Buffer = this.mp3Encoder.encodeBuffer(leftInt16, rightInt16);
                                if (mp3Buffer.length > 0) {
                                    this.audioChunks.push(new Int8Array(mp3Buffer));
                                }
                            } catch (encodeError) {
                                console.error("Encoding error:", encodeError);
                            }
                        };

                        UI.setStatus("REC", "error");
                        UI.updateRecordButton();
                        UI.notify("ðŸŸ¥ Recording dimulai...");

                    } catch (error) {
                        console.error("Error starting recording:", error);
                        UI.notify("Gagal memulai recording: " + error.message, "error");
                        this.stop();
                    }
                },

                stop() {
                    if (!this.isRecording) return;

                    this.isRecording = false;

                    if (this.scriptProcessor) {
                        this.scriptProcessor.disconnect();
                        this.scriptProcessor.onaudioprocess = null;
                    }

                    if (this.mp3Encoder) {
                        try {
                            const finalBuffer = this.mp3Encoder.flush();
                            if (finalBuffer.length > 0) {
                                this.audioChunks.push(new Int8Array(finalBuffer));
                            }
                        } catch (flushError) {
                            console.error("Flush error:", flushError);
                        }
                    }

                    this.createMP3File();

                    UI.setStatus("ON AIR", "ok");
                    UI.updateRecordButton();
                },

                floatTo16BitPCM(input) {
                    const output = new Int16Array(input.length);
                    for (let i = 0; i < input.length; i++) {
                        const s = Math.max(-1, Math.min(1, input[i]));
                        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    return output;
                },

                createMP3File() {
                    if (this.audioChunks.length === 0) {
                        UI.notify("Tidak ada data audio yang direkam", "warn");
                        return;
                    }

                    try {
                        const totalLength = this.audioChunks.reduce((total, chunk) => total + chunk.length, 0);
                        const mp3Data = new Int8Array(totalLength);

                        let offset = 0;
                        for (const chunk of this.audioChunks) {
                            mp3Data.set(chunk, offset);
                            offset += chunk.length;
                        }

                        const now = new Date();
                        const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
                        const stationName = AppState.playlist[AppState.currentIndex]?.title || 'Unknown';
                        const filename = `MiniAmp_${stationName}_${timestamp}.mp3`;

                        const blob = new Blob([mp3Data], { type: 'audio/mpeg' });
                        const url = URL.createObjectURL(blob);

                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        const duration = Math.round((Date.now() - this.startTime) / 1000);
                        UI.notify(`âœ… Rekaman selesai: ${filename} (${duration} detik)`);

                    } catch (error) {
                        console.error("Error creating MP3 file:", error);
                        UI.notify("Error membuat file MP3", "error");
                    }
                },

                toggle() {
                    if (this.isRecording) {
                        this.stop();
                    } else {
                        this.start();
                    }
                }
            };

            /* =========================================
               MODUL: UTILIITAS (Utils)
               Fungsi bantu umum
               ========================================= */
            const Utils = {
                getNameFromUrl(url) {
                    try {
                        const u = new URL(url);
                        const path = u.pathname.split("/").pop() || "";
                        return decodeURIComponent(path).replace(/\.(mp3|aac|ogg|m4a)$/i, "") || u.hostname;
                    } catch { return url; }
                },

                async fetchLiveMetadata(url) {
                    if (url.startsWith('blob:') || AppState.isStopped) return;
                    
                    try {
                        const u = new URL(url);
                        const statusUrl = u.origin + "/status-json.xsl";
                        
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 2000);

                        const res = await fetch(statusUrl, { signal: controller.signal });
                        clearTimeout(id);

                        if (res.ok) {
                            const data = await res.json();
                            const src = [].concat(data.icestats?.source || [])
                                .find(s => s.listenurl?.includes(u.pathname)) || data.icestats?.source?.[0];
                                
                            if (src && (src.title || src.yp_currently_playing)) {
                                const meta = src.title || src.yp_currently_playing;
                                if (meta !== AppState.currentMetadata) {
                                    AppState.currentMetadata = meta;
                                    UI.updateNowPlaying();
                                }
                            }
                        }
                    } catch (e) { }
                    
                    if(AppState.playlist[AppState.currentIndex]?.url === url && !AppState.isStopped) {
                         AppState.metadataTimeout = setTimeout(() => this.fetchLiveMetadata(url), 15000);
                    }
                },

                parseM3U(content) {
                    const stations = [];
                    let currentTitle = null;
                    const lines = content.replace(/^\uFEFF/, "").split(/\r?\n/);
                    
                    lines.forEach(line => {
                        const t = line.trim();
                        if (!t || t.startsWith("#EXTM3U")) return;
                        
                        if (t.startsWith("#EXTINF")) {
                            const parts = t.split(",");
                            currentTitle = parts.length > 1 ? parts.slice(1).join(",").trim() : null;
                        } else if (!t.startsWith("#")) {
                            stations.push({ title: currentTitle || this.getNameFromUrl(t), url: t });
                            currentTitle = null;
                        }
                    });
                    return stations;
                }
            };

            /* =========================================
               MODUL: VISUALIZER
               Menangani Canvas dan animasi
               ========================================= */
            const Visualizer = {
                frameId: 0,
                start(analyser) {
                    if (this.frameId) cancelAnimationFrame(this.frameId);
                    const canvas = document.getElementById('vizCanvas');
                    const ctx = canvas.getContext('2d');
                    const bufferLen = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLen);
                    
                    const draw = () => {
                        this.frameId = requestAnimationFrame(draw);
                        if (document.getElementById('audio').paused) return;

                        if (canvas.width !== canvas.offsetWidth) {
                            canvas.width = canvas.offsetWidth;
                            canvas.height = canvas.offsetHeight;
                        }

                        const w = canvas.width;
                        const h = canvas.height;
                        ctx.clearRect(0, 0, w, h);
                        analyser.getByteFrequencyData(dataArray);
                        
                        const barWidth = w / 64;
                        let x = 0;
                        const isTrippy = document.documentElement.getAttribute('data-theme') === 'trippy';
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        let baseColor = isDark ? '240, 240, 255' : '37, 99, 235';

                        if (isTrippy) baseColor = `hsl(${(Date.now()/50)%360}, 100%, 70%)`;

                        for(let i = 0; i < 64; i++) {
                            const index = Math.floor(i * (bufferLen / 128));
                            const val = dataArray[index];
                            const barH = (val / 255) * h;
                            
                            ctx.fillStyle = isTrippy ? baseColor : `rgba(${baseColor}, ${val/400})`;
                            ctx.fillRect(x, h - barH, barWidth - 1, barH);
                            x += barWidth;
                        }
                    };
                    draw();
                },

                initInteractive() {
                    const canvas = document.getElementById('vizInteractive');
                    let isDragging = false;
                    let lastX = 0;

                    const start = (e) => { isDragging = true; lastX = (e.touches ? e.touches[0].clientX : e.offsetX); };
                    const end = () => { isDragging = false; };
                    const move = (e) => {
                        if (!isDragging || AudioEngine.eqFilters.length < 3) return;
                        e.preventDefault();
                        const clientX = e.touches ? e.touches[0].clientX : e.offsetX;
                        const delta = clientX - lastX;
                        
                        if (Math.abs(delta) > 2) {
                            const node = delta > 0 ? AudioEngine.eqFilters[2] : AudioEngine.eqFilters[0];
                            const current = node.gain.value;
                            node.gain.setTargetAtTime(Math.max(0.2, Math.min(2.5, current + delta/200)), AudioEngine.ctx.currentTime, 0.1);
                            lastX = clientX;
                        }
                    };

                    canvas.addEventListener('mousedown', start);
                    canvas.addEventListener('touchstart', start);
                    window.addEventListener('mousemove', move);
                    window.addEventListener('touchmove', move, {passive: false});
                    window.addEventListener('mouseup', end);
                    window.addEventListener('touchend', end);
                }
            };

            /* =========================================
               MODUL: ANTARMUKA PENGGUNA (UI)
               Interaksi DOM, Playlist, dan Kontrol
               ========================================= */
            const UI = {
                el: {},

                init() {
                    const ids = ['audio', 'playBtn', 'stopBtn', 'prevBtn', 'nextBtn', 'shuffleBtn', 
                               'muteBtn', 'volDown', 'volUp', 'volNum', 'eqSelect', 'normBtn', 'recordBtn',
                               'playlist', 'searchInput', 'stationCount', 'nowTitle', 
                               'statusDot', 'statusText', 'addStreamBtn', 'loadUrlBtn', 'loadFileBtn',
                               'gameBtn', 'skinBtn', 'clearBtn', 'loadPresetBtn',
                               'fileInput', 'notification', 'miniGame', 'gameCanvas', 'gameScore', 'gameClose',
                               'skinOverlay', 'skinFile', 'skinPreview', 'skinApply', 'skinReset', 'skinCancel',
                               'themeToggle'];
            
                    ids.forEach(id => this.el[id] = document.getElementById(id));
                    
                    this.bindEvents();
                    this.loadTheme();
                    SkinManager.init();
                    GameManager.init();
                },
                
                updateNowPlaying() {
                    const station = AppState.playlist[AppState.currentIndex];
                    if (!station) return;
                    
                    let text = station.title;
                    if (AppState.currentMetadata) {
                        text += ` â€” ${AppState.currentMetadata}`;
                    }
                    
                    this.el.nowTitle.textContent = text;
                    this.el.nowTitle.title = text;
                    document.title = "â–¶ " + text;
                },

                bindEvents() {
                    // Toolbar Events
                    this.el.gameBtn.onclick = () => {
                        document.getElementById('miniGame').classList.add('active');
                        GameManager.start();
                    };

                    this.el.skinBtn.onclick = () => {
                        document.getElementById('skinOverlay').classList.add('active');
                    };

                    this.el.addStreamBtn.onclick = () => {
                        const url = prompt("Masukkan URL Stream:");
                        if(url) this.addToPlaylist([{title: Utils.getNameFromUrl(url), url}]);
                    };

                    this.el.loadUrlBtn.onclick = () => {
                        const url = prompt("Masukkan URL M3U:");
                        if(url) {
                            fetch(url)
                                .then(r => r.text())
                                .then(text => {
                                    const items = Utils.parseM3U(text);
                                    if(items.length) this.addToPlaylist(items);
                                })
                                .catch(() => this.notify("Gagal memuat M3U", "error"));
                        }
                    };

                    this.el.loadFileBtn.onclick = () => this.el.fileInput.click();

                    this.el.clearBtn.onclick = () => {
                        if(confirm("Hapus semua stasiun dari playlist?")) {
                            AppState.playlist = []; 
                            AppState.displayPlaylist = [];
                            AppState.currentIndex = -1;
                            Player.stop();
                            this.renderPlaylist();
                            this.notify("Playlist dikosongkan");
                        }
                    };

                    // Audio Controls
                    this.el.recordBtn.onclick = () => Recorder.toggle();
                    this.el.playBtn.onclick = () => Player.toggle();
                    this.el.stopBtn.onclick = () => Player.stop();
                    this.el.prevBtn.onclick = () => Player.playPrev();
                    this.el.nextBtn.onclick = () => Player.playNext();
                    
                    // PERBAIKAN: Volume step dikurangi dari 0.5 ke 0.05 (5%)
                    this.el.volDown.onclick = () => AudioEngine.setVolume(AppState.volume - 0.05);
                    this.el.volUp.onclick = () => AudioEngine.setVolume(AppState.volume + 0.05);
                    
                    this.el.muteBtn.onclick = () => { 
                        this.el.audio.muted = !this.el.audio.muted; 
                        this.updateControls(); 
                        Storage.save(); 
                    };
                    
                    this.el.shuffleBtn.onclick = () => { 
                        AppState.isShuffled = !AppState.isShuffled; 
                        this.updateControls(); 
                        Storage.save(); 
                    };
                    
                    this.el.normBtn.onclick = () => { 
                        AppState.isNormalized = !AppState.isNormalized; 
                        this.updateControls(); 
                        Storage.save(); 
                    };

                    this.el.eqSelect.onchange = (e) => {
                        AudioEngine.applyEq(e.target.value);
                        this.notify(`EQ: ${e.target.value.toUpperCase()}`);
                    };

                    // Pencarian Playlist
                    this.el.searchInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        AppState.displayPlaylist = AppState.playlist.filter(s => 
                            (s.title && s.title.toLowerCase().includes(term)) || s.url.toLowerCase().includes(term)
                        );
                        this.renderPlaylist();
                    });

                    // Event Audio Native
                    this.el.audio.onplaying = () => { 
                        this.setStatus("ON AIR", "ok"); 
                        Player.resetRetry(); 
                        this.updatePlayButton(); 
                    };
                    this.el.audio.onwaiting = () => this.setStatus("BUFFER", "warn");
                    this.el.audio.onended = () => { this.setStatus("SELESAI", "warn"); Player.retry(true); };
                    this.el.audio.onerror = () => { this.setStatus("ERROR", "err"); Player.retry(); };

                    // Load Preset Button
                    this.el.loadPresetBtn.onclick = () => {
                        const demos = [
                            { title: "Lofi Girl (Hip Hop)", url: "https://play.streamafrica.net/lofiradio" },
                            { title: "Smooth Jazz Florida", url: "https://us4.internet-radio.com/proxy/wsjf?mp=/stream;" },
                            { title: "BBC World Service", url: "https://stream.live.vc.bbcmedia.co.uk/bbc_world_service" }
                        ];
                        this.addToPlaylist(demos);
                        this.notify("Demo dimuat!");
                    };

                    // File Input
                    this.el.fileInput.onchange = () => {
                        if(this.el.fileInput.files.length) Player.handleFiles(this.el.fileInput.files);
                        this.el.fileInput.value = '';
                    };

                    // Drag & Drop
                    document.body.ondragover = e => e.preventDefault();
                    document.body.ondrop = e => {
                        e.preventDefault();
                        if(e.dataTransfer.files.length) Player.handleFiles(e.dataTransfer.files);
                    };
                    
                    // Theme Toggle
                    this.el.themeToggle.onclick = () => this.cycleTheme();
                },

                updateRecordButton() {
                    const isRecording = Recorder.isRecording;
                    this.el.recordBtn.classList.toggle("recording", isRecording);
                    document.getElementById('iconRec').style.display = isRecording ? 'none' : 'block';
                    document.getElementById('iconRecStop').style.display = isRecording ? 'block' : 'none';
    
                    const paused = this.el.audio.paused;
                    document.getElementById('iconPlay').style.display = paused ? 'block' : 'none';
                    document.getElementById('iconPause').style.display = paused ? 'none' : 'block';
                },

                addToPlaylist(items) {
                    AppState.playlist.push(...items);
                    AppState.displayPlaylist = [...AppState.playlist];
                    this.el.searchInput.value = "";
                    this.renderPlaylist();
                    this.notify(`${items.length} stasiun ditambahkan`, "ok");
                    Storage.save();
                },

                renderPlaylist() {
                    const list = AppState.displayPlaylist.length > 0 || this.el.searchInput.value ? AppState.displayPlaylist : AppState.playlist;
                    this.el.playlist.innerHTML = "";
    
                    list.forEach((item, idx) => {
                        const realIdx = AppState.playlist.indexOf(item);
                        const li = document.createElement("li");
                        li.className = `playlist-item ${realIdx === AppState.currentIndex ? 'active' : ''}`;
                        li.innerHTML = `
                            <span class="item-num">${idx + 1}</span>
                            <span class="item-title">${item.title}</span>
                            <div class="item-actions">
                                <button class="btn-mini remove-btn" data-index="${realIdx}">âœ•</button>
                            </div>
                        `;
                        li.onclick = () => Player.play(realIdx);
                        this.el.playlist.appendChild(li);
                    });
    
                    this.addRemoveEventListeners();
                    this.el.stationCount.textContent = `${list.length} STASIUN`;
    
                    if (AppState.currentIndex >= 0) {
                         const active = this.el.playlist.querySelector('.active');
                         if(active) active.scrollIntoView({behavior: "smooth", block: "nearest"});
                    }
                },

                addRemoveEventListeners() {
                    const removeButtons = this.el.playlist.querySelectorAll('.remove-btn');
                    removeButtons.forEach(btn => {
                        btn.onclick = (e) => {
                            e.stopPropagation();
                            const index = parseInt(btn.getAttribute('data-index'));
                            this.removeStation(index);
                        };
                    });
                },

                removeStation(index) {
                    AppState.playlist.splice(index, 1);
                    AppState.displayPlaylist = [...AppState.playlist];
                    this.renderPlaylist();
                    Storage.save();
                },

                updateControls() {
                    this.el.shuffleBtn.classList.toggle("active", AppState.isShuffled);
                    this.el.normBtn.classList.toggle("active", AppState.isNormalized);
                    this.el.normBtn.textContent = AppState.isNormalized ? "AGC ON" : "AGC OFF";
                    this.el.muteBtn.style.opacity = this.el.audio.muted ? "0.5" : "1";
                },

                updateVolumeDisplay() {
                    this.el.volNum.textContent = Math.round(AppState.volume * 100) + "%";
                },

                updatePlayButton() {
                    const paused = this.el.audio.paused;
                    document.getElementById('iconPlay').style.display = paused ? 'block' : 'none';
                    document.getElementById('iconPause').style.display = paused ? 'none' : 'block';
                },

                setStatus(msg, type) {
                    this.el.statusText.textContent = msg;
                    this.el.statusDot.className = `status-dot ${type}`;
                },

                notify(msg, type="info") {
                    this.el.notification.textContent = msg;
                    this.el.notification.className = `notification ${type} show`;
                    setTimeout(() => this.el.notification.classList.remove("show"), 3000);
                },

                loadTheme() {
                    const theme = localStorage.getItem('miniamp_theme') || 'dark';
                    document.documentElement.setAttribute('data-theme', theme);
                    this.updateThemeIcon(theme);
                },
                cycleTheme() {
                    const current = document.documentElement.getAttribute('data-theme');
                    const next = current === 'dark' ? 'light' : (current === 'light' ? 'trippy' : 'dark');
                    document.documentElement.setAttribute('data-theme', next);
                    localStorage.setItem('miniamp_theme', next);
                    this.updateThemeIcon(next);
                },
                updateThemeIcon(theme) {
                    const sun = document.getElementById('iconSun');
                    const moon = document.getElementById('iconMoon');
                    sun.style.display = theme === 'dark' ? 'block' : 'none';
                    moon.style.display = theme !== 'dark' ? 'block' : 'none';
                }
            };

            /* =========================================
               MODUL: PEMUTAR UTAMA (Player)
               Logika bisnis pemutaran musik
               ========================================= */
            const Player = {
                async toggle() {
                    if (!AppState.playlist.length) return UI.notify("Playlist kosong!", "error");
                    await AudioEngine.init();
                    
                    if (UI.el.audio.paused) {
                        AppState.isStopped = false;
                        if (AppState.currentIndex < 0) AppState.currentIndex = 0;
                        this.play(AppState.currentIndex);
                    } else {
                        this.pause();
                    }
                },

                async play(index) {
                    if (!AppState.playlist[index]) return;
                    
                    await AudioEngine.init();
                    this.resetRetry();
                    
                    clearTimeout(AppState.metadataTimeout);
                    AppState.currentMetadata = "";
                    
                    AppState.currentIndex = index;
                    UI.renderPlaylist();
                    UI.updateNowPlaying();
                    
                    const station = AppState.playlist[index];
                    UI.setStatus("KONEKSI...", "warn");

                    try {
                        await this.attemptStream(station.url);
                        Utils.fetchLiveMetadata(station.url);
                    } catch (e) {
                        console.warn("Error Pemutaran:", e);
                        UI.setStatus("ERROR", "err");
                    }
                    Storage.save();
                },

                async attemptStream(url) {
                    const audio = UI.el.audio;
                    
                    try {
                        audio.src = url;
                        audio.setAttribute('crossorigin', 'anonymous');
                        await this.loadAndPlay(audio);
                        UI.notify("Mode: CORS Aktif (Visualizer OK)");
                        return;
                    } catch (e) {
                        console.log("Gagal mode CORS, mencoba fallback...");
                    }

                    if (url.startsWith("http:") && location.protocol === "https:") {
                        try {
                            const secureUrl = url.replace("http:", "https:");
                            UI.setStatus("UPGRADE HTTPS...", "warn");
                            audio.src = secureUrl;
                            audio.setAttribute('crossorigin', 'anonymous');
                            await this.loadAndPlay(audio);
                            UI.notify("Smart Upgrade: HTTPS Aktif", "ok");
                            AppState.playlist[AppState.currentIndex].url = secureUrl;
                            return;
                        } catch (e) { console.log("Gagal upgrade HTTPS"); }
                    }

                    UI.setStatus("RETRY NO-CORS", "warn");
                    audio.removeAttribute('crossorigin');
                    audio.src = url;
                    await this.loadAndPlay(audio);
                    UI.notify("Visualizer nonaktif (Batasan Browser)", "warn");
                },

                loadAndPlay(audio) {
                    return new Promise((resolve, reject) => {
                        const timer = setTimeout(() => reject("Timeout"), 10000);
                        
                        const onPlay = () => {
                            clearTimeout(timer);
                            cleanup();
                            AudioEngine.fade(1, Config.fadeIn);
                            resolve();
                        };
                        const onError = (e) => {
                            clearTimeout(timer);
                            cleanup();
                            reject(e);
                        };
                        
                        const cleanup = () => {
                            audio.removeEventListener('playing', onPlay);
                            audio.removeEventListener('error', onError);
                        };

                        audio.addEventListener('playing', onPlay);
                        audio.addEventListener('error', onError);
                        
                        audio.load();
                        audio.play().catch(onError);
                    });
                },

                pause() {
                    AppState.isStopped = true;
                    AudioEngine.fade(0, Config.fadeOut);
                    setTimeout(() => UI.el.audio.pause(), Config.fadeOut * 1000);
                    UI.setStatus("JEDA", "warn");
                    UI.updatePlayButton();
                },

                stop() {
                    AppState.isStopped = true;
                    this.resetRetry();
                    AudioEngine.fade(0, Config.fadeOut);
                    setTimeout(() => {
                        UI.el.audio.pause();
                        UI.el.audio.src = "";
                        UI.setStatus("BERHENTI", "warn");
                        UI.updatePlayButton();
                    }, Config.fadeOut * 1000);
                },

                playNext() {
                    if (!AppState.playlist.length) return;
                    let next = AppState.isShuffled 
                        ? Math.floor(Math.random() * AppState.playlist.length)
                        : (AppState.currentIndex + 1) % AppState.playlist.length;
                    this.play(next);
                },

                playPrev() {
                    if (!AppState.playlist.length) return;
                    let prev = AppState.currentIndex <= 0 
                        ? AppState.playlist.length - 1 
                        : AppState.currentIndex - 1;
                    this.play(prev);
                },

                retry(isEnded) {
                    if (AppState.isStopped) return;
                    AppState.retryCount++;
                    
                    if (AppState.retryCount > Config.maxRetries) {
                        UI.setStatus("GAGAL TOTAL", "err");
                        return;
                    }

                    const delay = 1000 * Math.pow(2, AppState.retryCount);
                    UI.setStatus(`RETRY (${AppState.retryCount})...`, "warn");
                    
                    AppState.retryTimeout = setTimeout(() => {
                        if (isEnded) this.playNext();
                        else this.play(AppState.currentIndex);
                    }, delay);
                },

                resetRetry() {
                    clearTimeout(AppState.retryTimeout);
                    AppState.retryCount = 0;
                },

                async handleFiles(files) {
                    const newItems = [];
                    for (const file of files) {
                        if (file.name.match(/\.(m3u|m3u8|txt)$/i)) {
                            const text = await file.text();
                            newItems.push(...Utils.parseM3U(text));
                        } 
                        else if (file.type.startsWith('audio/') || file.name.match(/\.(mp3|wav|ogg|aac|flac|m4a)$/i)) {
                            newItems.push({
                                title: file.name.replace(/\.[^/.]+$/, ""),
                                url: URL.createObjectURL(file)
                            });
                        }
                    }
                    if (newItems.length) UI.addToPlaylist(newItems);
                }
            };

            /* =========================================
               MODUL: STORAGE (Penyimpanan Lokal)
               Logika penyimpanan lokal MiniAmp
               ========================================= */
            const Storage = {
                save() {
                    const data = {
                        playlist: AppState.playlist.filter(s => !s.url.startsWith('blob:')),
                        idx: AppState.currentIndex,
                        vol: AppState.volume,
                        shuf: AppState.isShuffled,
                        norm: AppState.isNormalized,
                        eq: AppState.currentEq
                    };
                    localStorage.setItem(Config.storageKey, JSON.stringify(data));
                },
                load() {
                    try {
                        const data = JSON.parse(localStorage.getItem(Config.storageKey) || "{}");
                        if (Array.isArray(data.playlist)) {
                            AppState.playlist = data.playlist;
                            AppState.displayPlaylist = [...AppState.playlist];
                        }
                        if (data.idx !== undefined) AppState.currentIndex = data.idx;

                        if (data.vol !== undefined) {
                            AppState.volume = Math.min(0.8, data.vol);
                        } else {
                            AppState.volume = 0.5;
                        }

                        if (data.shuf !== undefined) AppState.isShuffled = data.shuf;
                        if (data.norm !== undefined) AppState.isNormalized = data.norm;
                        if (data.eq) AppState.currentEq = data.eq;

                        AudioEngine.setVolume(AppState.volume);
                        
                        UI.renderPlaylist();
                        UI.el.eqSelect.value = AppState.currentEq;
                        UI.updateVolumeDisplay();
                        UI.updateControls();
                    } catch (e) { 
                        console.error("Gagal memuat penyimpanan", e);
                        AudioEngine.setVolume(0.5);
                    }
                }
            };

            /* =========================================
               MODUL: FITUR TAMBAHAN (Skin & Game)
               Pengaturan Skin dan Play Game Sederhana
               ========================================= */
            const SkinManager = {
                init() {
                    const overlay = document.getElementById('skinOverlay');
                    const preview = document.getElementById('skinPreview');
                    
                    document.getElementById('skinBtn').onclick = () => overlay.classList.add('active');
                    document.getElementById('skinCancel').onclick = () => overlay.classList.remove('active');
                    
                    document.getElementById('skinFile').onchange = (e) => {
                        const file = e.target.files[0];
                        if(file) {
                            const reader = new FileReader();
                            reader.onload = ev => preview.style.backgroundImage = `url(${ev.target.result})`;
                            reader.readAsDataURL(file);
                        }
                    };
                    
                    document.getElementById('skinApply').onclick = () => {
                        const bg = preview.style.backgroundImage;
                        if(bg && bg !== 'none') {
                            document.body.style.backgroundImage = bg;
                            document.body.style.backgroundSize = 'cover';
                            localStorage.setItem(Config.skinKey, bg);
                            UI.notify("Tema diterapkan!");
                        }
                        overlay.classList.remove('active');
                    };

                    document.getElementById('skinReset').onclick = () => {
                        localStorage.removeItem(Config.skinKey);
                        document.body.style.backgroundImage = '';
                        preview.style.backgroundImage = 'none';
                        UI.notify("Tema direset");
                    };

                    const saved = localStorage.getItem(Config.skinKey);
                    if(saved) {
                        document.body.style.backgroundImage = saved;
                        document.body.style.backgroundSize = 'cover';
                    }
                }
            };

            const GameManager = {
                active: false,
                score: 0,
                circles: [],
                
                init() {
                    const btn = document.getElementById('gameBtn');
                    const close = document.getElementById('gameClose');
                    const modal = document.getElementById('miniGame');
                    
                    btn.onclick = () => {
                        modal.classList.add('active');
                        this.start();
                    };
                    close.onclick = () => {
                        modal.classList.remove('active');
                        this.active = false;
                    };
                    
                    const canvas = document.getElementById('gameCanvas');
                    const hit = (e) => {
                        if(!this.active) return;
                        e.preventDefault();
                        const rect = canvas.getBoundingClientRect();
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        const x = clientX - rect.left;
                        const y = clientY - rect.top;
                        
                        for(let i = this.circles.length-1; i>=0; i--) {
                            const c = this.circles[i];
                            const dx = x - c.x;
                            const dy = y - c.y;
                            if (dx*dx + dy*dy <= c.r*c.r) {
                                this.circles.splice(i, 1);
                                this.score += 10;
                                document.getElementById('gameScore').textContent = this.score;
                                break;
                            }
                        }
                    };
                    
                    canvas.addEventListener('mousedown', hit);
                    canvas.addEventListener('touchstart', hit);
                },
                
                start() {
                    this.active = true;
                    this.score = 0;
                    this.circles = [];
                    document.getElementById('gameScore').textContent = "0";
                    const canvas = document.getElementById('gameCanvas');
                    const ctx = canvas.getContext('2d');
                    let lastSpawn = 0;
                    
                    const loop = (time) => {
                        if(!this.active) return;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        if (time - lastSpawn > 500) {
                            this.circles.push({
                                x: Math.random() * (canvas.width - 40) + 20,
                                y: -20,
                                r: 15 + Math.random() * 10,
                                speed: 1 + Math.random() * 2,
                                color: `hsl(${Math.random()*360}, 70%, 60%)`
                            });
                            lastSpawn = time;
                        }
                        
                        for(let i = this.circles.length-1; i>=0; i--) {
                            const c = this.circles[i];
                            c.y += c.speed;
                            
                            let boom = 0;
                            if(AudioEngine.nodes.analyser && !UI.el.audio.paused) {
                                const data = new Uint8Array(10);
                                AudioEngine.nodes.analyser.getByteFrequencyData(data);
                                boom = data[2] / 30;
                            }

                            ctx.fillStyle = c.color;
                            ctx.beginPath();
                            ctx.arc(c.x, c.y, c.r + boom, 0, Math.PI*2);
                            ctx.fill();
                            
                            if(c.y > canvas.height + 50) this.circles.splice(i, 1);
                        }
                        requestAnimationFrame(loop);
                    };
                    requestAnimationFrame(loop);
                }
            };

            /* =========================================
               INISIALISASI UTAMA
               ========================================= */
            window.addEventListener('DOMContentLoaded', () => {
                UI.init();
                Storage.load();
            });

        })();
    </script>
</body>
</html>
