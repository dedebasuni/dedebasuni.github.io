<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ujian Online Chat Style</title>
<style>
  :root {
    --whatsapp-green: #25D366;
    --whatsapp-dark-green: #128C7E;
    --whatsapp-light-green: #DCF8C6;
    --whatsapp-gray: #ECE5DD;
    --whatsapp-dark-gray: #075E54;
    --whatsapp-blue: #34B7F1;
    --correct: #25D366;
    --incorrect: #FF3B30;
    --text-light: #757575;
    --text-dark: #222;
    --bg-light: #ECE5DD;
    --bg-dark: #0C1317;
    --chat-bg-dark: #0B141A;
    --white: #fff;
    --header-dark: #202C33;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-light);
    color: var(--text-dark);
    transition: background-color 0.3s, color 0.3s;
    overflow: hidden;
  }
  body.dark {
    background: var(--bg-dark);
    color: #E9EDEF;
  }

  /* HEADER */
  .header {
    background: var(--whatsapp-dark-green);
    color: var(--white);
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    z-index: 10;
    height: 60px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  body.dark .header {
    background: var(--header-dark);
  }
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: url('https://i.pravatar.cc/100') no-repeat center/cover;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .header-info {
    flex-grow: 1;
    overflow: hidden;
  }
  .header-info .name {
    font-weight: 500;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .header-info .status {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .timer {
    font-weight: 600;
    font-size: 14px;
    background: rgba(255,255,255,0.9);
    padding: 5px 10px;
    border-radius: 20px;
    color: var(--whatsapp-dark-green);
    user-select: none;
    min-width: 60px;
    text-align: center;
  }
  body.dark .timer {
    background: #111B21;
    color: var(--whatsapp-light-green);
  }

  /* DARK MODE TOGGLE */
  .dark-toggle {
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--white);
    font-size: 20px;
    margin-left: 10px;
    padding: 5px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .dark-toggle:hover {
    background: rgba(255,255,255,0.1);
  }

  /* CHAT CONTAINER */
  .chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px 8px;
    background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
    background-repeat: repeat;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
    position: relative;
  }
  body.dark .chat-container {
    background-image: url('https://i.pinimg.com/736x/58/c3/33/58c33377dfcbb3022493dec49d098b02.jpg');
    background-color: var(--chat-bg-dark);
  }

  /* MESSAGE BUBBLE */
  .message {
    max-width: 75%;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    line-height: 1.4;
    position: relative;
    font-size: 14.2px;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    word-wrap: break-word;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    word-break: break-word;
  }
  .bot-message {
    background: var(--white);
    align-self: flex-start;
    border-top-left-radius: 0;
    color: var(--text-dark);
    margin-left: 8px;
  }
  .user-message {
    background: var(--whatsapp-light-green);
    align-self: flex-end;
    border-top-right-radius: 0;
    color: var(--text-dark);
    margin-right: 8px;
  }
  body.dark .bot-message {
    background: #202C33;
    color: #E9EDEF;
  }
  body.dark .user-message {
    background: #005C4B;
    color: #E9EDEF;
  }

  /* Message time */
  .message-time {
    font-size: 11px;
    color: rgba(0,0,0,0.5);
    float: right;
    margin-left: 8px;
    margin-top: 2px;
  }
  body.dark .message-time {
    color: rgba(255,255,255,0.5);
  }
  .user-message .message-time {
    color: rgba(0,0,0,0.6);
  }
  body.dark .user-message .message-time {
    color: rgba(255,255,255,0.6);
  }

  /* Gambar di dalam pesan */
  .message img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin-top: 5px;
    display: block; /* Agar gambar tidak ada spasi di bawahnya */
  }

  /* OPTION JAWABAN */
  .option-message {
    background: var(--white);
    border-radius: 8px;
    padding: 10px 12px;
    margin: 6px 8px;
    cursor: pointer;
    border-left: 44px solid transparent;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    font-weight: 500;
    transition: all 0.2s;
    position: relative;
    user-select: none;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    color: var(--text-dark);
    font-size: 14.2px;
    word-break: break-word; /* Memastikan teks panjang tetap dalam batas */
  }
  .option-message:hover:not(.selected) {
    background: #f5f5f5;
    border-left-color: var(--whatsapp-dark-green);
  }
  .option-message.selected {
    pointer-events: none;
    background: var(--whatsapp-light-green);
    border-left-color: var(--whatsapp-green);
  }
  .correct-answer {
    background: var(--correct);
    color: white;
    border-left-color: var(--correct);
  }
  .wrong-answer {
    background: var(--incorrect);
    color: white;
    border-left-color: var(--incorrect);
  }
  body.dark .option-message {
    background: #202C33;
    color: #E9EDEF;
  }
  body.dark .option-message:hover:not(.selected) {
    background: #2A3942;
  }
  body.dark .option-message.selected {
    background: #005C4B;
    border-left-color: var(--whatsapp-green);
  }
  body.dark .correct-answer {
    background: #1B5E20;
    color: #E9EDEF;
    border-left-color: #2E7D32;
  }
  body.dark .wrong-answer {
    background: #7F1D1D;
    border-left-color: #B91C1C;
  }
  /* Gambar di dalam opsi */
  .option-message img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin-top: 5px;
  }

  /* Status Indicator */
  .status-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-weight: bold;
    font-size: 16px;
  }
  .correct-indicator { color: white; }
  .incorrect-indicator { color: white; }

  /* FOOTER */
  .footer {
    background: #f0f0f0;
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #e5e5e5;
    height: 60px;
  }
  body.dark .footer {
    background: var(--header-dark);
    border-top-color: #303D45;
  }
  #question-counter {
    font-size: 14px;
    color: var(--text-light);
    font-weight: 500;
  }
  body.dark #question-counter {
    color: #AEBAC1;
  }
  button.btn {
    padding: 8px 20px;
    border: none;
    border-radius: 20px;
    font-weight: 500;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
    height: 36px;
  }
  button.btn-primary {
    background: var(--whatsapp-dark-green);
    color: white;
  }
  button.btn-primary:hover:not(:disabled) {
    background: var(--whatsapp-dark-gray);
  }
  button.btn-primary:disabled {
    background: #CCCCCC;
    cursor: not-allowed;
    color: #666;
  }
  body.dark button.btn-primary:disabled {
    background: #2A3942;
    color: #6B7B84;
  }

  /* LOGIN SCREEN */
  #login-screen {
    background: var(--white);
    padding: 30px 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    margin: auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
    color: var(--text-dark);
  }
  body.dark #login-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #login-screen h2 {
    text-align: center;
    color: var(--whatsapp-dark-green);
    font-size: 22px;
    margin-bottom: 10px;
  }
  body.dark #login-screen h2 {
    color: var(--whatsapp-green);
  }
  .input-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .input-field label {
    font-size: 14px;
    color: var(--text-light);
  }
  body.dark .input-field label {
    color: #AEBAC1;
  }
  .input-field input {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    color: var(--text-dark);
    background: var(--white);
  }
  body.dark .input-field input {
    background: #2A3942;
    border-color: #303D45;
    color: #E9EDEF;
  }
  .input-field input:focus {
    border-color: var(--whatsapp-dark-green);
  }
  .login-actions {
    display: flex;
    /* justify-content: space-between; */ /* Dihapus, karena hanya 1 tombol */
    justify-content: center; /* Tombol di tengah */
    gap: 10px;
  }
  .login-actions button {
    /* flex: 1; */ /* Dihapus, agar tombol tidak memanjang */
    min-width: 150px; /* Lebar minimum untuk tombol */
  }

  /* RESULT SCREEN */
  #result-screen {
    background: var(--white);
    padding: 30px 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    margin: auto;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    color: var(--text-dark);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  body.dark #result-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  .result-avatar {
    width: 100px;
    height: 100px;
    margin: 0 auto;
    border-radius: 50%;
    background: url('https://avatars.githubusercontent.com/u/12972124?v=4') no-repeat center/contain;
    background-color: #F0F2F5;
    padding: 20px;
  }
  body.dark .result-avatar {
    background-color: #2A3942;
  }
  #result-title {
    color: var(--whatsapp-dark-green);
    font-size: 22px;
    font-weight: 600;
  }
  body.dark #result-title {
    color: var(--whatsapp-green);
  }
  #result-details {
    line-height: 1.6;
    font-size: 15px;
    text-align: left;
    background: #F9F9F9;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }
  body.dark #result-details {
    background: #2A3942;
  }
  #result-details p {
    margin-bottom: 8px;
  }
  button#restart-btn {
    background: var(--whatsapp-dark-green);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-weight: 500;
    font-size: 16px;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s ease;
    margin-top: 10px;
  }
  button#restart-btn:hover {
    background: var(--whatsapp-dark-gray);
  }

  /* Statistik Jawaban */
  #stats-container {
    background: var(--white);
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 8px 0;
    max-height: 180px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 14px;
    color: var(--text-dark);
  }
  body.dark #stats-container {
    background: #202C33;
    color: #E9EDEF;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  #stats-container h3 {
    margin-bottom: 10px;
    color: var(--whatsapp-dark-green);
    font-size: 15px;
    font-weight: 600;
  }
  body.dark #stats-container h3 {
    color: var(--whatsapp-green);
  }
  #stats-list {
    list-style: none;
    max-height: 140px;
    overflow-y: auto;
    padding-left: 0;
  }
  #stats-list li {
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    font-weight: 500;
    padding: 4px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  body.dark #stats-list li {
    border-bottom-color: rgba(255,255,255,0.05);
  }
  #stats-list li:last-child {
    border-bottom: none;
  }
  #stats-list li.correct {
    color: var(--correct);
  }
  #stats-list li.incorrect {
    color: var(--incorrect);
  }

  /* Indikator mengetik */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--white);
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
    width: fit-content;
    margin: 8px 8px 8px;
    opacity: 0;
    animation: fadeInUp 0.3s forwards;
    border-top-left-radius: 0;
  }
  body.dark .typing-indicator {
    background: #202C33;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.3);
  }
  .typing-dot {
    width: 7px;
    height: 7px;
    background: var(--text-light);
    border-radius: 50%;
    animation: bounce 1.5s infinite ease-in-out;
  }
  .typing-dot:nth-child(2) {
    animation-delay: 0.3s;
  }
  .typing-dot:nth-child(3) {
    animation-delay: 0.6s;
  }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
  }
  @keyframes fadeInUp {
    from {opacity: 0; transform: translateY(8px);}
    to {opacity: 1; transform: translateY(0);}
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }
  body.dark ::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
  }
  body.dark ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
  }

  /* Admin Screen */
  #admin-screen {
    background: var(--white);
    padding: 20px;
    border-radius: 8px;
    max-width: 900px;
    width: 90%;
    margin: auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    color: var(--text-dark);
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto; /* Untuk scrolling jika banyak data */
  }
  body.dark #admin-screen {
    background: var(--header-dark);
    color: #E9EDEF;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #admin-screen h2 {
    text-align: center;
    color: var(--whatsapp-dark-green);
    font-size: 24px;
  }
  body.dark #admin-screen h2 {
    color: var(--whatsapp-green);
  }
  #results-table-container {
    overflow-x: auto; /* Untuk horizontal scrolling pada tabel di layar kecil */
    max-height: 70vh; /* Batasi tinggi tabel agar bisa discroll */
    overflow-y: auto;
  }
  #results-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px; /* Lebar minimum tabel */
  }
  #results-table th, #results-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
    font-size: 14px;
  }
  #results-table th {
    background-color: #f2f2f2;
    font-weight: 600;
    color: var(--text-dark);
    position: sticky; /* Sticky header */
    top: 0;
    z-index: 1;
  }
  body.dark #results-table th {
    background-color: #2A3942;
    color: #E9EDEF;
  }
  #results-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  body.dark #results-table tbody tr:nth-child(even) {
    background-color: #111B21;
  }
  #results-table tbody tr:hover {
    background-color: #e0e0e0;
    cursor: pointer;
  }
  body.dark #results-table tbody tr:hover {
    background-color: #303D45;
  }
  .view-detail-btn {
    background: var(--whatsapp-blue);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  }
  .view-detail-btn:hover {
    background: #2196F3;
  }
  .admin-back-btn {
    background: #F44336;
    color: white;
  }
  .admin-back-btn:hover {
    background: #D32F2F;
  }

  /* Custom Modal */
  .custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); display: flex;
    justify-content: center; align-items: center; z-index: 1000;
  }
  .custom-modal-content {
    background-color: var(--white); padding: 25px; border-radius: 10px;
    max-width: 90%; width: 450px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    gap: 15px;
    color: var(--text-dark);
  }
  body.dark .custom-modal-content {
    background-color: var(--header-dark);
    color: #E9EDEF;
  }
  .custom-modal-title {
    color: var(--whatsapp-dark-green);
    margin-bottom: 10px; font-size: 1.2em;
  }
  body.dark .custom-modal-title {
    color: var(--whatsapp-green);
  }
  .custom-modal-message {
    font-size: 0.95em; line-height: 1.5; margin-bottom: 15px;
  }
  .custom-modal-button {
    background-color: var(--whatsapp-dark-green); color: white;
    padding: 10px 20px; border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.2s ease;
  }
  .custom-modal-button:hover {
    background-color: var(--whatsapp-dark-gray);
  }
  /* Detail Jawaban Modal Specific */
  #detail-answers-content {
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 5px;
    background-color: #fcfcfc;
    color: var(--text-dark);
  }
  body.dark #detail-answers-content {
    background-color: #111B21;
    border-color: #2A3942;
    color: #E9EDEF;
  }
  #detail-answers-content p {
    margin-bottom: 5px;
  }
  #detail-answers-content .correct { color: var(--correct); }
  #detail-answers-content .incorrect { color: var(--incorrect); }

  /* Admin Login Modal specific styles */
  #admin-login-modal-content {
    padding: 25px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  #admin-login-modal-content input[type="text"],
  #admin-login-modal-content input[type="password"] {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    color: var(--text-dark);
    background: var(--white);
  }
  body.dark #admin-login-modal-content input {
    background: #2A3942;
    border-color: #303D45;
    color: #E9EDEF;
  }
  #admin-login-modal-content input:focus {
    border-color: var(--whatsapp-dark-green);
  }
  #admin-login-modal-content button {
    margin-top: 10px;
  }

  /* Utility classes */
  .hidden {
    display: none !important;
  }
</style>
</head>
<body class="light">

<!-- HEADER -->
<div class="header hidden" id="header">
  <div class="avatar" id="avatar"></div>
  <div class="header-info">
    <div class="name" id="header-name"></div>
    <div class="status" id="header-status"></div>
  </div>
  <div class="timer" id="timer">--:--</div>
  <button class="dark-toggle" id="dark-toggle" title="Toggle Mode Gelap / Terang" aria-label="Toggle Dark Mode">ðŸŒ™</button>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <h2>Login Peserta Ujian</h2>
  <div class="input-field">
    <label for="noPeserta">No. Peserta</label>
    <input type="text" id="noPeserta" placeholder="Masukkan nomor peserta" aria-label="Nomor Peserta" />
  </div>
  <div class="input-field">
    <label for="nama">Nama Lengkap</label>
    <input type="text" id="nama" placeholder="Masukkan nama lengkap" aria-label="Nama Lengkap" disabled />
  </div>
  <div class="input-field">
    <label for="kelas">Kelas</label>
    <input type="text" id="kelas" placeholder="Masukkan kelas" aria-label="Kelas" disabled />
  </div>
  <div class="login-actions">
    <button id="start-btn" class="btn btn-primary" disabled>Mulai Ujian</button>
    <!-- Tombol "Login Admin" Dihapus -->
  </div>
</div>

<!-- EXAM SCREEN -->
<div id="exam-screen" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
  <div class="chat-container" id="chat-messages" aria-live="polite" aria-relevant="additions"></div>
  <div class="footer">
    <div id="question-counter" aria-live="polite" aria-atomic="true">Soal 1/10</div>
    <button id="next-btn" class="btn btn-primary" disabled>Lanjut</button>
  </div>
  <div id="stats-container">
    <h3>Statistik Jawaban</h3>
    <ul id="stats-list"></ul>
  </div>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="hidden">
  <div class="result-avatar"></div>
  <h2 id="result-title">Ujian Selesai!</h2>
  <div id="result-details"></div>
  <button id="restart-btn">Ulangi Ujian</button>
</div>

<!-- ADMIN SCREEN -->
<div id="admin-screen" class="hidden">
  <h2>Hasil Ujian Peserta</h2>
  <div id="results-table-container">
    <table id="results-table">
      <thead>
        <tr>
          <th>No. Peserta</th>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Skor</th>
          <th>Waktu Selesai</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data akan dimasukkan di sini oleh JavaScript -->
      </tbody>
    </table>
  </div>
  <button id="admin-back-btn" class="btn admin-back-btn">Kembali ke Login</button>
</div>

<!-- Custom Modal for general messages and detail answers -->
<div id="custom-modal-overlay" class="custom-modal-overlay hidden">
  <div class="custom-modal-content">
    <h3 id="custom-modal-title" class="custom-modal-title"></h3>
    <div id="custom-modal-message" class="custom-modal-message"></div>
    <button class="custom-modal-button" onclick="window.hideCustomModal('custom-modal-overlay')">OK</button>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="admin-login-modal-overlay" class="custom-modal-overlay hidden">
  <div class="custom-modal-content" id="admin-login-modal-content">
    <h3 class="custom-modal-title">Login Admin</h3>
    <div class="input-field">
      <label for="admin-password">Password</label>
      <input type="password" id="admin-password" placeholder="Masukkan password admin" />
    </div>
    <button id="admin-login-submit-btn" class="btn btn-primary">Login</button>
    <button id="admin-login-cancel-btn" class="btn admin-back-btn" onclick="window.hideCustomModal('admin-login-modal-overlay')">Batal</button>
  </div>
</div>


<script>
// PENTING: Fungsi modal ini HARUS didefinisikan di lingkup global (di luar DOMContentLoaded)
// agar bisa diakses oleh atribut 'onclick' di HTML.

/**
 * Menampilkan modal kustom dengan judul dan konten yang dinamis.
 * @param {string} title - Judul modal.
 * @param {string|HTMLElement} content - Konten modal (teks atau elemen HTML).
 * @param {boolean} isError - True jika ini adalah pesan error, false jika bukan.
 * @param {boolean} isHtmlContent - True jika 'content' adalah elemen HTML, false jika teks biasa.
 * @param {string} modalId - ID overlay modal yang akan ditampilkan.
 */
window.showCustomModal = function(title, content, isError, isHtmlContent = false, modalId = 'custom-modal-overlay') {
  const modalOverlay = document.getElementById(modalId);
  if (!modalOverlay) {
    console.error(`Modal overlay with ID '${modalId}' not found in HTML.`);
    return; // Exit if modal element is not found
  }

  const modalContentDiv = modalOverlay.querySelector('.custom-modal-content');
  const modalTitleEl = modalContentDiv.querySelector('.custom-modal-title');
  const modalMessageEl = modalContentDiv.querySelector('.custom-modal-message');

  modalTitleEl.textContent = title;
  // Set title color based on error status
  modalTitleEl.style.color = isError ? 'var(--incorrect)' : 'var(--whatsapp-dark-green)';

  if (isHtmlContent && typeof content === 'object') {
      modalMessageEl.innerHTML = ''; // Clear existing content
      modalMessageEl.appendChild(content); // Append the HTML element
  } else {
      modalMessageEl.textContent = content; // Set text content
  }

  // Determine current dark mode state from body class
  const currentDarkMode = document.body.classList.contains('dark');
  window.applyDarkModeToModal(modalId, currentDarkMode); // Pass dark mode state

  modalOverlay.classList.remove('hidden');
};

/**
 * Menyembunyikan modal kustom.
 * @param {string} modalId - ID overlay modal yang akan disembunyikan.
 */
window.hideCustomModal = function(modalId = 'custom-modal-overlay') {
  const modalOverlay = document.getElementById(modalId);
  if (modalOverlay) {
    modalOverlay.classList.add('hidden');
    // Clear password input if it's the admin login modal
    if (modalId === 'admin-login-modal-overlay') {
        const adminPasswordInput = document.getElementById('admin-password');
        if (adminPasswordInput) adminPasswordInput.value = '';
    }
  }
};

/**
 * Menerapkan gaya mode gelap/terang pada modal tertentu.
 * @param {string} modalId - ID overlay modal.
 * @param {boolean} isDarkMode - True jika mode gelap aktif.
 */
window.applyDarkModeToModal = function(modalId, isDarkMode) {
  const modalOverlay = document.getElementById(modalId);
  if (!modalOverlay) return;

  const modalContentDiv = modalOverlay.querySelector('.custom-modal-content');
  const modalTitleEl = modalContentDiv.querySelector('.custom-modal-title');
  const messageContent = modalContentDiv.querySelector('.custom-modal-message');

  if (isDarkMode) {
    modalContentDiv.style.backgroundColor = 'var(--header-dark)';
    modalContentDiv.style.color = '#E9EDEF';
    // Preserve error color if it was an error modal, otherwise apply green
    modalTitleEl.style.color = modalTitleEl.style.color === 'rgb(255, 59, 48)' ? 'var(--incorrect)' : 'var(--whatsapp-green)';

    if (modalId === 'admin-login-modal-overlay') {
      modalContentDiv.querySelectorAll('input').forEach(input => {
        input.style.backgroundColor = '#2A3942';
        input.style.borderColor = '#303D45';
        input.style.color = '#E9EDEF';
      });
    }
    if (messageContent && messageContent.id === 'detail-answers-content') {
      messageContent.style.backgroundColor = '#111B21';
      messageContent.style.borderColor = '#2A3942';
      messageContent.style.color = '#E9EDEF';
      messageContent.querySelectorAll('.correct').forEach(el => el.style.color = 'var(--correct)');
      messageContent.querySelectorAll('.incorrect').forEach(el => el.style.color = 'var(--incorrect)');
    }
  } else {
    modalContentDiv.style.backgroundColor = 'var(--white)';
    modalContentDiv.style.color = 'var(--text-dark)';
    // Preserve error color if it was an error modal, otherwise apply dark green
    modalTitleEl.style.color = modalTitleEl.style.color === 'rgb(255, 59, 48)' ? 'var(--incorrect)' : 'var(--whatsapp-dark-green)';

    if (modalId === 'admin-login-modal-overlay') {
      modalContentDiv.querySelectorAll('input').forEach(input => {
        input.style.backgroundColor = 'var(--white)';
        input.style.borderColor = '#ddd';
        input.style.color = 'var(--text-dark)';
      });
    }
    if (messageContent && messageContent.id === 'detail-answers-content') {
      messageContent.style.backgroundColor = '#fcfcfc';
      messageContent.style.borderColor = '#eee';
      messageContent.style.color = 'var(--text-dark)';
      messageContent.querySelectorAll('.correct').forEach(el => el.style.color = 'var(--correct)');
      messageContent.querySelectorAll('.incorrect').forEach(el => el.style.color = 'var(--incorrect)');
    }
  }
};


document.addEventListener('DOMContentLoaded', function () {

  const API_URL = 'https://script.google.com/macros/s/AKfycbwCn0QD_1GFvTJwsV3ZiHjQp-7EZzHLvKbiO6bBbjeJGnSId_ntpUFa0aP2EO_mi_hyzg/exec';

  // Sound effects (Pastikan URL ini dapat diakses atau ganti dengan sound yang Anda miliki)
  const soundCorrect = new Audio('https://blog-static.mamikos.com/wp-content/uploads/2020/05/upinipin_2singgit.mp3');
  const soundWrong = new Audio('https://blog-static.mamikos.com/wp-content/uploads/2020/05/beri_salam.mp3');

  const state = {
    noPeserta: '',
    nama: '',
    kelas: '',
    questions: [],
    participants: [], // Untuk menyimpan data peserta dari GSheet
    settings: {},     // Untuk menyimpan data pengaturan dari GSheet
    allResults: [],   // Untuk menyimpan semua hasil ujian (khusus admin)
    currentQuestionIndex: 0,
    answers: [],
    score: 0,
    timer: null,
    timeLeft: 0,      // Waktu akan diambil dari settings
    typingTimeout: null,
    darkMode: false,
    practiceMode: false, // Mode latihan tidak digunakan untuk saat ini
    adminNoPeserta: '' // Tambahkan ini untuk menyimpan nomor peserta admin dari settings
  };

  // DOM Elements
  const body = document.body;
  const header = document.getElementById('header');
  const avatar = document.getElementById('avatar');
  const headerName = document.getElementById('header-name');
  const headerStatus = document.getElementById('header-status');
  const timerEl = document.getElementById('timer');
  const darkToggle = document.getElementById('dark-toggle');

  const loginScreen = document.getElementById('login-screen');
  const examScreen = document.getElementById('exam-screen');
  const resultScreen = document.getElementById('result-screen');
  const adminScreen = document.getElementById('admin-screen'); // Admin screen
  const resultsTableBody = document.querySelector('#results-table tbody'); // Admin table body

  const chatMessages = document.getElementById('chat-messages');
  const questionCounter = document.getElementById('question-counter');
  const nextBtn = document.getElementById('next-btn');
  const startBtn = document.getElementById('start-btn');
  // const adminLoginBtn = document.getElementById('admin-login-btn'); // Dihapus, tombol Login Admin tidak ada lagi
  const adminBackBtn = document.getElementById('admin-back-btn');   // Admin back button

  const statsContainer = document.getElementById('stats-container');
  const statsList = document.getElementById('stats-list');

  const resultTitle = document.getElementById('result-title');
  const resultDetails = document.getElementById('result-details');
  const restartBtn = document.getElementById('restart-btn');

  const inputNoPeserta = document.getElementById('noPeserta');
  const inputNama = document.getElementById('nama');
  const inputKelas = document.getElementById('kelas');

  // Admin Login Modal Elements
  const adminLoginModalOverlay = document.getElementById('admin-login-modal-overlay');
  const adminPasswordInput = document.getElementById('admin-password');
  const adminLoginSubmitBtn = document.getElementById('admin-login-submit-btn');
  // const adminLoginCancelBtn = document.getElementById('admin-login-cancel-btn'); // Dihapus, onclick di HTML
  
  // --- Utility Functions (inside DOMContentLoaded or helper for global functions) ---

  // Fungsi untuk mengecek apakah string adalah URL gambar
  function isImageUrl(str) {
    return (typeof str === 'string') && (str.startsWith('http://') || str.startsWith('https://')) &&
           (/\.(jpg|jpeg|png|gif|webp)$/i).test(str);
  }

  // Fungsi untuk membuat elemen gambar
  function createImageElement(src) {
    const img = document.createElement('img');
    img.src = src;
    img.alt = 'Gambar soal';
    img.loading = 'lazy'; // Optimasi loading
    // Tambahkan event listener untuk penanganan error gambar
    img.onerror = () => {
      console.warn('Gagal memuat gambar:', src);
      // Ganti dengan placeholder atau sembunyikan jika gagal
      img.src = `https://placehold.co/150x100/A0A0A0/FFFFFF?text=Gambar+Rusak`;
    };
    return img;
  }

  // --- Initialization ---

  async function init() {
    // Check for saved dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      state.darkMode = true;
      body.classList.add('dark');
      body.classList.remove('light');
      darkToggle.textContent = 'â˜€ï¸';
    }

    // Fetch initial data (settings, participants, and all results for admin)
    await fetchAllInitialData();
    state.adminNoPeserta = state.settings['Admin No. Peserta'] || ''; // Ambil nomor peserta admin dari settings

    // Event listeners for login inputs
    inputNoPeserta.addEventListener('input', validateLoginInputs);
    inputNama.addEventListener('input', validateLoginInputs); // Still needed for manual fill if noPeserta not found
    inputKelas.addEventListener('input', validateLoginInputs); // Still needed for manual fill if noPeserta not found

    // Dark mode toggle
    darkToggle.addEventListener('click', () => {
      state.darkMode = !state.darkMode;
      if (state.darkMode) {
        body.classList.add('dark');
        body.classList.remove('light');
        darkToggle.textContent = 'â˜€ï¸';
        localStorage.setItem('darkMode', 'true');
      } else {
        body.classList.remove('dark');
        body.classList.add('light');
        darkToggle.textContent = 'ðŸŒ™';
        localStorage.setItem('darkMode', 'false');
      }
      // Apply dark mode to existing modals if any
      // Now passing state.darkMode directly
      window.applyDarkModeToModal('custom-modal-overlay', state.darkMode);
      window.applyDarkModeToModal('admin-login-modal-overlay', state.darkMode);
    });

    // Start exam (now also handles admin login)
    startBtn.addEventListener('click', startExam);
    // adminLoginBtn.addEventListener('click', showAdminLoginModal); // Dihapus, tombol ini tidak ada lagi

    // Admin login modal buttons
    adminLoginSubmitBtn.addEventListener('click', handleAdminLogin);
    // adminLoginCancelBtn.addEventListener('click', () => window.hideCustomModal('admin-login-modal-overlay')); // Dihapus, onclick di HTML sudah menangani

    // Next question button
    nextBtn.addEventListener('click', () => {
      if (state.currentQuestionIndex < state.questions.length - 1) {
        state.currentQuestionIndex++;
        showQuestion(state.currentQuestionIndex);
      } else {
        finishExam();
      }
    });

    // Restart exam
    restartBtn.addEventListener('click', restartExam);

    // Admin back button
    adminBackBtn.addEventListener('click', showLoginScreen);

    // Load saved state if available
    loadFromStorage() ? continueExam() : showLoginScreen();
  }

  async function fetchAllInitialData() {
      try {
          const response = await fetch(API_URL);
          const data = await response.json();
          if (data.status !== 'success' || !data.data) {
              throw new Error('Failed to load initial data from Google Sheet.');
          }
          state.settings = data.data.settings || {};
          state.participants = data.data.participants || [];
          state.questions = data.data.questions || [];
          state.allResults = data.data.results || [];
          // hapus dulu console.log('Data dari Google Sheet:', data.data);

          // Set header info based on settings
          if (state.settings['Mata Pelajaran'] && state.settings['Guru Mapel']) {
            headerName.textContent = `${state.settings['Mata Pelajaran']} - ${state.settings['Guru Mapel']}`;
          } else {
            headerName.textContent = 'Ujian Online';
          }
          headerStatus.textContent = state.settings['Kelas'] ? `Kelas: ${state.settings['Kelas']}` : 'Sedang mengerjakan ujian';

      } catch (e) {
          window.showCustomModal('Error', `Gagal memuat data awal: ${e.message}. Pastikan URL API benar dan Google Sheet siap.`, true);
          console.error('Error fetching initial data:', e);
          startBtn.disabled = true;
      }
  }

  // --- Login Logic ---

  function validateLoginInputs() {
    const noPesertaVal = inputNoPeserta.value.trim();
    const namaVal = inputNama.value.trim();
    const kelasVal = inputKelas.value.trim();

    // Cek apakah nomor peserta yang dimasukkan adalah nomor admin
    if (noPesertaVal === state.adminNoPeserta) {
      inputNama.value = 'Administrator'; // Set nama dan kelas untuk admin
      inputKelas.value = 'Admin';
      inputNama.disabled = true;
      inputKelas.disabled = true;
      startBtn.disabled = false; // Aktifkan tombol "Mulai Ujian" untuk login admin
    } else {
      // Logic untuk peserta biasa
      const participant = state.participants.find(p => p.noPeserta === noPesertaVal);

      if (participant) {
        inputNama.value = participant.nama;
        inputKelas.value = participant.kelas;
        inputNama.disabled = true;
        inputKelas.disabled = true;

        if (participant.isCompleted) {
          startBtn.disabled = true;
          window.showCustomModal('Ujian Selesai', `Maaf, ${participant.nama}, Anda sudah menyelesaikan ujian ini.`, false);
        } else {
          startBtn.disabled = false;
        }
      } else {
        // Peserta tidak ditemukan, izinkan pengisian manual
        inputNama.value = '';
        inputKelas.value = '';
        inputNama.disabled = false;
        inputKelas.disabled = false;
        startBtn.disabled = !(noPesertaVal && namaVal && kelasVal);
      }
    }
  }

  // --- Exam Flow ---

  async function startExam() {
    const noPesertaVal = inputNoPeserta.value.trim();
    const namaVal = inputNama.value.trim();
    const kelasVal = inputKelas.value.trim();

    // Jika nomor peserta adalah admin, tampilkan modal password admin
    if (noPesertaVal === state.adminNoPeserta) {
      showAdminPasswordPrompt(); // Memanggil fungsi untuk menampilkan modal password
      return; // Hentikan eksekusi, jangan lanjutkan ke logika ujian biasa
    }

    // --- Logic untuk peserta biasa (sama seperti sebelumnya) ---
    let foundParticipant = state.participants.find(p => p.noPeserta === noPesertaVal);

    if (foundParticipant && foundParticipant.isCompleted) {
      window.showCustomModal('Ujian Selesai', `Maaf, ${foundParticipant.nama}, Anda sudah menyelesaikan ujian ini.`, false);
      return;
    }

    if (!foundParticipant && !(noPesertaVal && namaVal && kelasVal)) {
      window.showCustomModal('Peringatan', 'Silakan lengkapi semua data login dengan benar.', false);
      return;
    }

    state.noPeserta = noPesertaVal;
    state.nama = namaVal;
    state.kelas = kelasVal;
    state.practiceMode = false;

    // Set up UI
    avatar.style.backgroundImage = `url(https://i.pravatar.cc/100?u=${encodeURIComponent(state.nama)}`;

    loginScreen.classList.add('hidden');
    header.classList.remove('hidden');
    examScreen.classList.remove('hidden');
    statsContainer.classList.remove('hidden');

    // Reset chat and stats
    chatMessages.innerHTML = '';
    statsList.innerHTML = '';
    questionCounter.textContent = `Soal 1/${state.questions.length}`;
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';

    // Reset exam state
    state.currentQuestionIndex = 0;
    state.answers = [];
    state.score = 0;
    // Set timer based on settings (default to 60 minutes if not found or invalid)
    const waktuSetting = parseInt(state.settings['Waktu'] || '60', 10);
    state.timeLeft = waktuSetting * 60;
    clearInterval(state.timer);
    startTimer();

    // Welcome messages
    appendBotMessage(`Halo ${state.nama}! Selamat datang di ujian online.`);
    appendBotMessage('Silakan jawab semua soal dengan memilih salah satu opsi yang tersedia.');

    // Show first question after a delay
    setTimeout(() => {
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        if (state.questions.length > 0) {
            showQuestion(0);
        } else {
            appendBotMessage('Tidak ada soal yang tersedia. Harap hubungi administrator.');
            nextBtn.disabled = true;
        }
        updateStats();
      }, 1200);
    }, 1000);
  }

  // Timer functions
  function startTimer() {
    updateTimerDisplay();
    state.timer = setInterval(() => {
      if (state.timeLeft <= 0) {
        clearInterval(state.timer);
        finishExam();
      } else {
        state.timeLeft--;
        updateTimerDisplay();
        saveToStorage();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
    const s = (state.timeLeft % 60).toString().padStart(2, '0');
    timerEl.textContent = `${m}:${s}`;
  }

  // --- Chat & Message Display ---

  function showTypingIndicator() {
    if (document.querySelector('.typing-indicator')) return;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.setAttribute('aria-live', 'polite');
    typingDiv.innerHTML = `
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
    `;
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
  }

  function hideTypingIndicator() {
    const typingDiv = document.querySelector('.typing-indicator');
    if (typingDiv) typingDiv.remove();
  }

  function appendBotMessage(content) {
    hideTypingIndicator();
    const div = document.createElement('div');
    div.className = 'message bot-message';
    if (isImageUrl(content)) {
        div.appendChild(createImageElement(content));
    } else {
        div.textContent = content;
    }
    const timeSpan = document.createElement('span');
    timeSpan.className = 'message-time';
    timeSpan.textContent = getCurrentTime();
    div.appendChild(timeSpan);
    chatMessages.appendChild(div);
    animateAndScroll(div);
  }

  function appendUserMessage(content) {
    const div = document.createElement('div');
    div.className = 'message user-message';
    if (isImageUrl(content)) {
        div.appendChild(createImageElement(content));
    } else {
        div.textContent = content;
    }
    const timeSpan = document.createElement('span');
    timeSpan.className = 'message-time';
    timeSpan.textContent = getCurrentTime();
    div.appendChild(timeSpan);
    chatMessages.appendChild(div);
    animateAndScroll(div);
  }

  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function animateAndScroll(el) {
    el.style.opacity = '0';
    el.style.transform = 'translateY(10px)';
    requestAnimationFrame(() => {
      el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
      scrollToBottom();
    });
  }

  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // --- Question and Answer Logic ---

  function showQuestion(index) {
    state.currentQuestionIndex = index;
    nextBtn.disabled = true;

    // Clear previous options
    chatMessages.querySelectorAll('.option-message').forEach(opt => opt.remove());
    hideTypingIndicator();

    // Show question
    const q = state.questions[index];
    appendBotMessage(q.question);

    // Show options after a delay
    showTypingIndicator();
    setTimeout(() => {
      hideTypingIndicator();
      q.options.forEach((opt, i) => {
        const div = document.createElement('div');
        div.className = 'option-message';
        div.tabIndex = 0;
        div.setAttribute('role', 'button');
        div.setAttribute('aria-pressed', 'false');

        const optionLabel = `${String.fromCharCode(65 + i)}. `; // A., B., C.
        if (isImageUrl(opt)) {
            div.innerHTML = optionLabel; // Tambahkan teks opsi (A., B., C.)
            div.appendChild(createImageElement(opt)); // Kemudian tambahkan gambar
        } else {
            div.textContent = optionLabel + opt;
        }

        div.addEventListener('click', () => selectAnswer(div, opt, q.correctAnswer));
        div.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectAnswer(div, opt, q.correctAnswer);
          }
        });
        chatMessages.appendChild(div);
        animateAndScroll(div);
      });
      questionCounter.textContent = `Soal ${index + 1} / ${state.questions.length}`;

      // Focus first option for keyboard navigation
      const firstOpt = chatMessages.querySelector('.option-message');
      if (firstOpt) firstOpt.focus();
    }, 1200);
  }

  function selectAnswer(selectedDiv, selectedAnswer, correctAnswer) {
    // Pastikan tombol next masih disabled saat opsi dipilih
    if (!nextBtn.disabled) return;

    // Show user's selected answer
    appendUserMessage(selectedAnswer);

    // Disable all options
    document.querySelectorAll('.option-message').forEach(opt => {
      opt.style.pointerEvents = 'none';
      opt.classList.add('selected');
    });

    // Check if answer is correct
    const isCorrect = selectedAnswer === correctAnswer;
    state.answers.push({
      question: state.questions[state.currentQuestionIndex].question,
      selectedAnswer,
      correctAnswer,
      isCorrect
    });

    // Play sound effect
    try {
      if (isCorrect) {
        soundCorrect.play();
        state.score++;
      } else {
        soundWrong.play();
      }
    } catch (e) {
      console.warn("Sound playback failed:", e);
    }


    // Highlight correct and incorrect answers
    document.querySelectorAll('.option-message').forEach(opt => {
      // Periksa apakah opsi ini adalah jawaban benar
      // Jika opsi memiliki gambar, bandingkan src gambarnya
      // Jika opsi adalah teks, bandingkan teksnya
      const optContentElement = opt.querySelector('img');
      const optContent = optContentElement ? optContentElement.src : opt.textContent.replace(/^[A-Z]\.\s*/, '');

      const correctContent = isImageUrl(correctAnswer) ? correctAnswer : correctAnswer;


      if (optContent === correctContent || opt.textContent.includes(correctAnswer)) { // Tambahkan juga teks jika teksnya cocok
        opt.classList.add('correct-answer');
        addStatusIcon(opt, 'âœ“', 'correct-indicator');
      }
      if (opt === selectedDiv && !isCorrect) {
        opt.classList.add('wrong-answer');
        addStatusIcon(opt, 'âœ—', 'incorrect-indicator');
      }
    });


    // Enable next button
    nextBtn.disabled = false;

    // Update button text for last question
    if (state.currentQuestionIndex === state.questions.length - 1) {
      nextBtn.textContent = 'Selesai';
    } else {
      nextBtn.textContent = 'Lanjut';
    }

    // Update stats and save state
    updateStats();
    saveToStorage();
  }

  function addStatusIcon(element, icon, className) {
    const span = document.createElement('span');
    span.className = `status-indicator ${className}`;
    span.textContent = icon;
    element.appendChild(span);
  }

  function updateStats() {
    statsList.innerHTML = '';
    state.answers.forEach((ans, i) => {
      const li = document.createElement('li');
      li.textContent = `Soal ${i + 1}: ${ans.isCorrect ? 'Benar' : 'Salah'}`;
      li.className = ans.isCorrect ? 'correct' : 'incorrect';
      statsList.appendChild(li);
    });
  }

  // --- Exam Completion ---

  function finishExam() {
    clearInterval(state.timer);
    header.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.remove('hidden');

    // Calculate results
    const percentage = state.questions.length > 0 ? Math.round((state.score / state.questions.length) * 100) : 0;
    const emoji = percentage >= 85 ? 'ðŸŽ‰' : percentage >= 60 ? 'ðŸ‘' : 'ðŸ’ª';
    const feedback = percentage >= 85 ? 'Sempurna!' : percentage >= 60 ? 'Bagus!' : 'Perlu belajar lagi';

    // Display results
    resultTitle.textContent = `Ujian Selesai!`;
    resultDetails.innerHTML = `
      <p>No. Peserta: ${state.noPeserta}</p>
      <p>Nama: ${state.nama}</p>
      <p>Kelas: ${state.kelas}</p>
      <p>Skor: ${state.score} dari ${state.questions.length}</p>
      <p>Persentase: ${percentage}%</p>
      <p><strong>${feedback} ${emoji}</strong></p>
    `;

    // Send results to server
    sendResults();

    // Clear storage
    clearStorage();
  }

  async function sendResults() {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          noPeserta: state.noPeserta,
          nama: state.nama,
          kelas: state.kelas,
          score: state.score,
          answers: state.answers,
        }),
      });
      console.log('Hasil ujian dikirim:', response);
      // Setelah berhasil mengirim hasil, perbarui data participants agar isCompleted true
      const participantIndex = state.participants.findIndex(p => p.noPeserta === state.noPeserta);
      if (participantIndex !== -1) {
        state.participants[participantIndex].isCompleted = true;
      }
      // Perbarui juga allResults untuk admin view
      await fetchAllInitialData(); // Muat ulang semua data termasuk hasil terbaru
    } catch (e) {
      console.warn('Gagal kirim hasil ujian:', e);
    }
  }

  // --- Restart & Continue Exam ---

  function restartExam() {
    resultScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    statsContainer.classList.add('hidden');
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';
    chatMessages.innerHTML = '';
    inputNoPeserta.value = '';
    inputNama.value = '';
    inputKelas.value = '';
    // Re-enable inputs for potential new participant login
    inputNama.disabled = false;
    inputKelas.disabled = false;
    startBtn.disabled = true;
    // adminLoginBtn.classList.remove('hidden'); // Dihapus
    state.answers = [];
    state.score = 0;
    state.currentQuestionIndex = 0;
    clearStorage();
    clearInterval(state.timer);
    updateTimerDisplay();
  }

  function continueExam() {
    avatar.style.backgroundImage = `url(https://i.pravatar.cc/100?u=${encodeURIComponent(state.nama)}`;

    loginScreen.classList.add('hidden');
    header.classList.remove('hidden');
    examScreen.classList.remove('hidden');
    statsContainer.classList.remove('hidden');

    chatMessages.innerHTML = '';
    statsList.innerHTML = '';

    questionCounter.textContent = `Soal ${state.currentQuestionIndex + 1} / ${state.questions.length}`;
    nextBtn.disabled = true;
    nextBtn.textContent = 'Lanjut';

    startTimer();

    appendBotMessage(`Selamat datang kembali, ${state.nama}!`);
    appendBotMessage('Anda dapat melanjutkan ujian dari sebelumnya.');

    setTimeout(() => {
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        if (state.questions.length > 0) {
            showQuestion(state.currentQuestionIndex);
        } else {
            appendBotMessage('Tidak ada soal yang tersedia. Harap hubungi administrator.');
            nextBtn.disabled = true;
        }
        updateStats();
      }, 1200);
    }, 1000);
  }

  function showLoginScreen() {
    loginScreen.classList.remove('hidden');
    header.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    adminScreen.classList.add('hidden'); // Ensure admin screen is hidden
    statsContainer.classList.add('hidden');
    window.hideCustomModal('admin-login-modal-overlay'); // Hide admin login modal if visible
  }

  // --- Local Storage Functions ---

  function saveToStorage() {
    localStorage.setItem('ujian-online-data', JSON.stringify({
      noPeserta: state.noPeserta,
      nama: state.nama,
      kelas: state.kelas,
      questions: state.questions,
      answers: state.answers,
      score: state.score,
      currentQuestionIndex: state.currentQuestionIndex,
      timeLeft: state.timeLeft,
      practiceMode: state.practiceMode,
      settings: state.settings
    }));
  }

  function loadFromStorage() {
    const data = localStorage.getItem('ujian-online-data');
    if (!data) return false;
    try {
      const obj = JSON.parse(data);
      if (obj && obj.nama && obj.kelas && obj.questions && obj.answers && obj.settings) {
        Object.assign(state, obj);
        // Pastikan settings dimuat kembali untuk header
        if (state.settings['Mata Pelajaran'] && state.settings['Guru Mapel']) {
          headerName.textContent = `${state.settings['Mata Pelajaran']} - ${state.settings['Guru Mapel']}`;
        } else {
          headerName.textContent = 'Ujian Online';
        }
        headerStatus.textContent = state.settings['Kelas'] ? `Kelas: ${state.settings['Kelas']}` : 'Sedang mengerjakan ujian';
        return true;
      }
    } catch (e) {
      console.error("Failed to load from storage:", e);
      return false;
    }
    return false;
  }

  function clearStorage() {
    localStorage.removeItem('ujian-online-data');
  }

  // --- Admin Functions ---

  // Fungsi ini sekarang dipanggil dari startExam jika nomor peserta admin terdeteksi
  function showAdminPasswordPrompt() { // Nama diubah dari showAdminLoginModal
    adminLoginModalOverlay.classList.remove('hidden');
    adminPasswordInput.value = '';
    adminPasswordInput.focus();
    window.applyDarkModeToModal('admin-login-modal-overlay', state.darkMode); // Pass state.darkMode
  }
  
  async function handleAdminLogin() {
    const noPeserta = inputNoPeserta.value.trim(); // Ambil dari input No. Peserta utama
    const password = adminPasswordInput.value.trim();

    if (noPeserta !== state.adminNoPeserta) {
        window.showCustomModal('Peringatan', 'Nomor Peserta yang dimasukkan bukan admin. Harap masukkan nomor peserta admin yang benar.', false);
        return;
    }
    if (!password) {
        window.showCustomModal('Peringatan', 'Password harus diisi.', false);
        return;
    }

    try {
      window.showCustomModal('Memuat', 'Memverifikasi kredensial...', false);
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'adminLogin', // Tetap gunakan action ini untuk membedakan di GAS
          noPeserta: noPeserta, // Kirim nomor peserta admin
          password: password,
        }),
      });
      const result = await response.json();
      window.hideCustomModal(); // Hide loading modal umum

      if (result.status === 'success' && result.role === 'admin') { // Cek role juga dari GAS
        window.hideCustomModal('admin-login-modal-overlay'); // Sembunyikan modal password admin
        showAdminScreen();
      } else {
        window.showCustomModal('Login Gagal', result.message || 'Nomor Peserta atau Password Admin salah.', true);
      }
    } catch (e) {
      window.hideCustomModal();
      window.showCustomModal('Error', `Gagal terhubung ke server: ${e.message}. Pastikan URL Web App Google Apps Script Anda benar dan di-deploy dengan benar.`, true);
      console.error('Error during admin login:', e);
    }
  }

  async function showAdminScreen() {
    loginScreen.classList.add('hidden');
    examScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    header.classList.add('hidden'); // Hide header in admin view
    adminScreen.classList.remove('hidden');

    // Re-fetch all data to ensure results are up-to-date
    window.showCustomModal('Memuat Data', 'Sedang memuat data hasil ujian...', false);
    await fetchAllInitialData(); // Re-fetch results
    populateAdminResultsTable();
    window.hideCustomModal(); // Hide loading modal
  }

  function populateAdminResultsTable() {
    resultsTableBody.innerHTML = ''; // Clear existing rows

    if (!state.allResults || state.allResults.length === 0) {
      const row = resultsTableBody.insertRow();
      const cell = row.insertCell();
      cell.colSpan = 6;
      cell.textContent = 'Belum ada hasil ujian.';
      cell.style.textAlign = 'center';
      return;
    }

    state.allResults.forEach(result => {
      const row = resultsTableBody.insertRow();
      row.insertCell().textContent = result.noPeserta;
      row.insertCell().textContent = result.nama;
      row.insertCell().textContent = result.kelas;
      row.insertCell().textContent = `${result.score} / ${state.questions.length || 'N/A'}`; // Tampilkan skor / total soal
      // Format timestamp
      const timestamp = new Date(result.timestamp);
      row.insertCell().textContent = timestamp.toLocaleString('id-ID', {
          year: 'numeric', month: 'numeric', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
      });

      const detailCell = row.insertCell();
      const detailButton = document.createElement('button');
      detailButton.textContent = 'Lihat Detail';
      detailButton.className = 'btn view-detail-btn';
      detailButton.onclick = () => showAnswerDetailsModal(result.answers);
      detailCell.appendChild(detailButton);
    });
  }

  function showAnswerDetailsModal(answersJson) {
    let answers;
    try {
      answers = JSON.parse(answersJson);
    } catch (e) {
      window.showCustomModal('Error', 'Gagal memparsing detail jawaban.', true);
      console.error('Error parsing answers JSON:', e);
      return;
    }

    const modalContentDiv = document.createElement('div');
    modalContentDiv.id = 'detail-answers-content';

    answers.forEach((ans, index) => {
      const p = document.createElement('p');
      p.innerHTML = `<strong>Soal ${index + 1}:</strong> `;

      // Question content
      if (isImageUrl(ans.question)) {
          p.appendChild(createImageElement(ans.question));
      } else {
          p.innerHTML += ans.question;
      }

      // Selected Answer
      const selectedAnswerEl = document.createElement('span');
      selectedAnswerEl.innerHTML = `Jawaban Anda: `;
      if (isImageUrl(ans.selectedAnswer)) {
          selectedAnswerEl.appendChild(createImageElement(ans.selectedAnswer));
          selectedAnswerEl.querySelector('img').style.maxWidth = '80px';
      } else {
          selectedAnswerEl.innerHTML += ans.selectedAnswer;
      }
      p.appendChild(document.createElement('br'));
      p.appendChild(selectedAnswerEl);

      // Correct Answer
      const correctAnswerEl = document.createElement('span');
      correctAnswerEl.innerHTML = `Jawaban Benar: `;
      if (isImageUrl(ans.correctAnswer)) {
          correctAnswerEl.appendChild(createImageElement(ans.correctAnswer));
          correctAnswerEl.querySelector('img').style.maxWidth = '80px';
      } else {
          correctAnswerEl.innerHTML += ans.correctAnswer;
      }
      p.appendChild(document.createElement('br'));
      p.appendChild(correctAnswerEl);


      if (ans.isCorrect) {
        p.className = 'correct';
        p.innerHTML += '<br> (Benar)';
      } else {
        p.className = 'incorrect';
        p.innerHTML += '<br> (Salah)';
      }
      modalContentDiv.appendChild(p);
    });

    window.showCustomModal('Detail Jawaban', modalContentDiv, false, true);
  }


  // Initialize the app
  init();
});
</script>
</body>
</html>
